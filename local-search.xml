<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>K8sä¹‹å®‰å…¨è®¤è¯</title>
    <link href="/2025/11/20/K8s%E4%B9%8B%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/"/>
    <url>/2025/11/20/K8s%E4%B9%8B%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/</url>
    
    <content type="html"><![CDATA[<h1 id="K8sä¹‹å®‰å…¨è®¤è¯"><a href="#K8sä¹‹å®‰å…¨è®¤è¯" class="headerlink" title="K8sä¹‹å®‰å…¨è®¤è¯"></a>K8sä¹‹å®‰å…¨è®¤è¯</h1><h2 id="Kubernetes-é›†ç¾¤çš„å®‰å…¨æœºåˆ¶"><a href="#Kubernetes-é›†ç¾¤çš„å®‰å…¨æœºåˆ¶" class="headerlink" title="Kubernetes é›†ç¾¤çš„å®‰å…¨æœºåˆ¶"></a>Kubernetes é›†ç¾¤çš„å®‰å…¨æœºåˆ¶</h2><p>Kubernetes ä½œä¸ºä¸€ä¸ªåˆ†éƒ¨ç½²é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯å…¶ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡ã€‚API Server æ˜¯é›†ç¾¤å†…éƒ¨å„ä¸ªç»„ä»¶é€šä¿¡çš„ä¸­ä»‹ï¼Œä¹Ÿæ˜¯å¤–éƒ¨æ§åˆ¶çš„å…¥å£ã€‚æ‰€ä»¥ Kubernetes çš„é›†ç¾¤å®‰å…¨æœºåˆ¶åŸºæœ¬å°±æ˜¯å›´ç»•ä¿æŠ¤ API Server æ¥è®¾è®¡çš„ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/29302735/1757078338305-fed2d0af-f047-4016-9d4e-4007af0402c6.png" alt="img"></p><h2 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h2><h3 id="è®¤è¯çš„æ–¹å¼"><a href="#è®¤è¯çš„æ–¹å¼" class="headerlink" title="è®¤è¯çš„æ–¹å¼"></a>è®¤è¯çš„æ–¹å¼</h3><p>1ã€HTTP Token è®¤è¯ï¼šé€šè¿‡ä¸€ä¸ª Token æ¥è¯†åˆ«åˆæ³•ç”¨æˆ·</p><ul><li>HTTP Token çš„è®¤è¯æ˜¯ç”¨ä¸€ä¸ªå¾ˆé•¿çš„ç‰¹æ®Šç¼–ç çš„å¹¶ä¸”éš¾ä»¥è¢«æ¨¡ä»¿çš„å­—ç¬¦ä¸² <code>Token</code> æ¥è¡¨è¾¾å®¢æˆ·çš„ä¸€ç§æ–¹å¼ã€‚æ¯ä¸€ä¸ª Token å¯¹åº”ä¸€ä¸ªç”¨æˆ·åå­˜å‚¨åœ¨ API Server èƒ½è®¿é—®çš„æ–‡ä»¶ä¸­ã€‚å½“å®¢æˆ·ç«¯å‘èµ· API è°ƒç”¨è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦åœ¨ HTTP Header é‡Œæ”¾å…¥ Token</li></ul><p>2ã€HTTP Base è®¤è¯ï¼šé€šè¿‡ç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯</p><ul><li>ç”¨æˆ·å+ï¼šå¯†ç  ç”¨ BASE64 ç®—æ³•è¿›è¡Œç¼–ç åçš„å­—ç¬¦ä¸²æ”¾åœ¨ HTTP Request ä¸­çš„ Heather Authorization åŸŸé‡Œå‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åè¿›è¡Œè§£ç å¾—åˆ°ç”¨æˆ·åä»¥åŠå¯†ç ã€‚</li></ul><p>3ã€HTTPS è¯ä¹¦è®¤è¯ï¼šåŸºäº CA æ ¹è¯ä¹¦ç­¾åçš„å®¢æˆ·ç«¯èº«ä»½è®¤è¯æ–¹å¼</p><p>åœ¨é›†ç¾¤å†…éƒ¨ï¼Œå½“ Controller Managerã€Scheduler ä¸ API Server åœ¨åŒä¸€å°æœºå™¨ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ API Server çš„éå®‰å…¨ç«¯å£è®¿é—®ï¼Œ<code>--insecure-bind-address=127.0.0.1</code></p><p>kubectlã€kubeletã€kubeproxy è®¿é—® API Server å°±éƒ½éœ€è¦è¿›è¡Œ HTTPS åŒå‘è®¤è¯ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/29302735/1757080706754-0ba5ed5c-7c5c-4c27-9fad-97be5a066a72.png" alt="img"></p><h5 id="1ã€Service-Account"><a href="#1ã€Service-Account" class="headerlink" title="1ã€Service Account"></a>1ã€Service Account</h5><ul><li>1ã€å¦‚æœPodæ²¡æœ‰è®¾ç½®saï¼Œåˆ™å°†saè®¾ç½®ä¸ºé»˜è®¤çš„ default</li><li>2ã€å¦‚æœPodä¸åŒ…å«ä»»ä½•çš„imagepullsecretsï¼Œåˆ™å°†saçš„imagepullsecretsæ·»åŠ åˆ°podä¸­</li><li>3ã€sa çš„é»˜è®¤æŒ‚è½½è·¯å¾„ä¸ºï¼š<code>/run/secrets/kubernetes.io/serviceaccount/</code></li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ª nameSpace éƒ½ä¼šæœ‰ä¸€ä¸ªåä¸º <code>default</code> çš„ Service Accountã€‚</p><p>SA ç»„æˆï¼š</p><ul><li>ca.crtï¼šé›†ç¾¤çš„æ ¹è¯ä¹¦ï¼Œç”¨äº Pod ç¡®è®¤ apiserver çš„å®‰å…¨æ€§</li><li>tokenï¼šä½¿ç”¨ apiserver çš„ç§é’¥ç­¾å‘çš„åŸºäº JWT æ ‡æ³¨çš„å­—ç¬¦ä¸²ï¼Œç”¨äº apiserver ç¡®è®¤ Pod çš„å®‰å…¨æ€§</li><li>namespaceï¼šç”¨äºè¡¨ç¤ºå½“å‰çš„ Pod çš„ä½œç”¨åŸŸ</li></ul><p>åˆ›å»ºä¸€ä¸ªå¸¦ token çš„ sa</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/service-account.name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/service-account-token</span><br></code></pre></td></tr></table></figure><h5 id="2ã€User-Account"><a href="#2ã€User-Account" class="headerlink" title="2ã€User Account"></a>2ã€User Account</h5><p>æ™®é€šè´¦æˆ·æ—¶å‡å®šä¸ºå¤–éƒ¨æˆ–ç‹¬ç«‹æœåŠ¡ç®¡ç†çš„ï¼Œæœ‰ç®¡ç†å‘˜åˆ†é…keysï¼Œç”¨æˆ·åƒä½¿ç”¨keystoneå’Œgoogleè´¦å·ä¸€æ ·ï¼Œè¢«å­˜å‚¨åœ¨åŒ…å«usernameå’Œpaswordçš„listæ–‡ä»¶ä¸­ã€‚</p><p>æ™®é€šè´¦æˆ·æ˜¯é’ˆå¯¹ä¸ªäººç”¨æˆ·çš„ï¼ŒæœåŠ¡è´¦æˆ·é’ˆå¯¹Podè¿›ç¨‹ã€‚</p><p>æ™®é€šè´¦æˆ·æ—¶å…¨å±€æ€§çš„ã€‚åœ¨é›†ç¾¤æ‰€æœ‰çš„namespacesä¸­ï¼Œåç§°å…·æœ‰å”¯ä¸€æ€§ã€‚</p><p>åœ¨k8sä¸­ä¸èƒ½é€šè¿‡APIè°ƒç”¨æ™®é€šç”¨æˆ·æ·»åŠ åˆ°é›†ç¾¤ä¸­</p><h2 id="ä»€ä¹ˆæ˜¯é‰´æƒ"><a href="#ä»€ä¹ˆæ˜¯é‰´æƒ" class="headerlink" title="ä»€ä¹ˆæ˜¯é‰´æƒ"></a>ä»€ä¹ˆæ˜¯é‰´æƒ</h2><p>ä¸Šé¢çš„è®¤è¯è¿‡ç¨‹ï¼Œåªæ˜¯ç¡®è®¤é€šä¿¡åŒæ–¹éƒ½ç¡®è®¤å¯¹æ–¹æ˜¯å¯ä¿¡çš„ï¼Œå¯ä»¥ç›¸äº’é€šä¿¡ã€‚è€Œé‰´æƒæ˜¯ç¡®å®šè¯·æ±‚æ–¹æœ‰å“ªäº›èµ„æºçš„æƒé™ã€‚API Server ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æˆæƒç­–ç•¥ï¼ˆé€šè¿‡ API Server çš„å¯åŠ¨å‚æ•°<code>--authorization-mode</code>è®¾ç½®ï¼‰</p><ul><li>AlwaysDenyï¼šè¡¨ç¤ºæ‹’ç»æ‰€æœ‰çš„è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li><li>AlwaysAllowï¼šå…è®¸æ¥æ”¶æ‰€æœ‰çš„è¯·æ±‚ï¼Œå¦‚æœé›†ç¾¤ä¸éœ€è¦æˆæƒæµç¨‹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨è¯¥ç­–ç•¥</li><li>ABAC(Attribute-Based Access Control)ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œè¡¨ç¤ºä½¿ç”¨ç”¨æˆ·é…ç½®çš„æˆæƒè§„åˆ™å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡ŒåŒ¹é…å’Œæ§åˆ¶</li><li>Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨ REST æœåŠ¡å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒ</li><li>RBAC(Role-Based Access Control)ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œç°è¡Œçš„é»˜è®¤è§„åˆ™</li></ul><h2 id="RBAC-ä»‹ç»"><a href="#RBAC-ä»‹ç»" class="headerlink" title="RBAC ä»‹ç»"></a>RBAC ä»‹ç»</h2><h3 id="ä»€ä¹ˆæ˜¯-RBAC"><a href="#ä»€ä¹ˆæ˜¯-RBAC" class="headerlink" title="ä»€ä¹ˆæ˜¯ RBAC"></a>ä»€ä¹ˆæ˜¯ RBAC</h3><p>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œåœ¨ Kubernetes 1.5 ç‰ˆæœ¬ä¸­å¼•å…¥ï¼Œç°è¡Œç‰ˆæœ¬æˆä¸ºé»˜è®¤æ ‡å‡†ã€‚ç›¸å¯¹äºå…¶ä»–è®¿é—®æ§åˆ¶æ–¹å¼ï¼Œæ‹¥æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>å¯¹é›†ç¾¤ä¸­çš„èµ„æºå’Œéèµ„æºéƒ½æ‹¥æœ‰å®Œæ•´çš„è¦†ç›–</li><li>æ•´ä¸ª RBAC å®Œå…¨ç”±å‡ ä¸ª API å¯¹è±¡å®Œæˆï¼ŒåŒå…¶ä»– API å¯¹è±¡ä¸€æ ·ï¼Œå¯ä»¥ç”¨ kubectl æˆ– API è¿›è¡Œæ“ä½œ</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œè°ƒæ•´ï¼Œæ— éœ€é‡å¯ API Server</li></ul><h2 id="RBAC-æ ¸å¿ƒçŸ¥è¯†"><a href="#RBAC-æ ¸å¿ƒçŸ¥è¯†" class="headerlink" title="RBAC æ ¸å¿ƒçŸ¥è¯†"></a>RBAC æ ¸å¿ƒçŸ¥è¯†</h2><p><code>Kubernetes</code>æœ‰ä¸€ä¸ªå¾ˆåŸºæœ¬çš„ç‰¹æ€§å°±æ˜¯å®ƒçš„æ‰€æœ‰èµ„æºå¯¹è±¡éƒ½æ˜¯æ¨¡å‹åŒ–çš„ API å¯¹è±¡ï¼Œå…è®¸æ‰§è¡Œ CRUD(Createã€Readã€Updateã€Delete)æ“ä½œ(ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œ)ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™ä¸‹èµ„æºï¼š</p><ul><li>Pods</li><li>ConfigMaps</li><li>Deployments</li><li>Nodes</li><li>Secrets</li><li>Namespaces</li></ul><p>ä¸Šé¢è¿™äº›èµ„æºå¯¹è±¡çš„å¯èƒ½å­˜åœ¨çš„æ“ä½œæœ‰ï¼š</p><ul><li>create</li><li>get</li><li>delete</li><li>list</li><li>update</li><li>edit</li><li>watch</li><li>exec</li></ul><p>RBAC å¼•å…¥çš„ 4 ä¸ªé¡¶çº§èµ„æºå¯¹è±¡æ¥å®ç° Kubernetes é›†ç¾¤ä¸­èµ„æºçš„æ“ä½œï¼Œåˆ†åˆ«æ˜¯ <code>Role</code>ã€ClusterRoleã€RoleBindingã€ClusterRoleBindingã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/29302735/1757081996085-7060830f-0605-4e07-b897-7fbec02b8dcb.png" alt="img"></p><h5 id="åˆ›å»º-Role"><a href="#åˆ›å»º-Role" class="headerlink" title="åˆ›å»º Role"></a>åˆ›å»º Role</h5><p>Role è¡¨ç¤ºä¸€ä¸ªè§’è‰²ï¼Œä¼šåŒ…å«ä¸€ç»„æƒé™ï¼Œæƒé™åªä¼šå¢åŠ ï¼ˆç´¯åŠ æƒé™ï¼‰ï¼Œä¸å­˜åœ¨ä¸€ä¸ªèµ„æºä¸€å¼€å§‹å°±æœ‰å¾ˆå¤šæƒé™è€Œé€šè¿‡ RBAC å¯¹å…¶è¿›è¡Œå‡å°‘çš„æ“ä½œã€‚ä»–æ˜¯ namespace çº§åˆ«çš„èµ„æºï¼Œåªèƒ½ä½œç”¨äºnamespaceä¹‹å†…ã€‚å¦‚æœæƒ³è¦è·¨ namespace åˆ™å¯ä»¥åˆ›å»º ClusterRole</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">apiVersion: rbac.authorization.k8s.io/v1<br>kind: Role<br>metadata:<br>  name: pod-role<br>  namespace: default<br>rules:<br>- apiGroups: [&quot;&quot;]# æ¥å£ç»„ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒç»„v1<br>  resources: [&quot;pods&quot;]# è¦æ“ä½œçš„èµ„æºç±»å‹ï¼Œå†™ä¸ºèµ„æºçš„å¤æ•°å½¢å¼<br>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]# å¯¹èµ„æºæ“ä½œçš„æƒé™<br></code></pre></td></tr></table></figure><h5 id="åˆ›å»º-ClusterRole"><a href="#åˆ›å»º-ClusterRole" class="headerlink" title="åˆ›å»º ClusterRole"></a>åˆ›å»º ClusterRole</h5><p>ä¸roleä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯èµ„æºç±»å‹ä¸ºé›†ç¾¤ç±»å‹ï¼Œè€Œroleåªåœ¨namespace</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plain">apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  name: pod-clusterrole<br>rules:<br>- apiGroups: [&quot;&quot;]<br>  resources: [&quot;nodes&quot;]<br>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]<br>- apiGroups: [&quot;&quot;]<br>  resources: [&quot;pods&quot;]<br>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]<br>- apiGroups: [&quot;extensions&quot;]<br>  resources: [&quot;deployments&quot;]<br>  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]<br></code></pre></td></tr></table></figure><h5 id="åˆ›å»º-RoleBinding"><a href="#åˆ›å»º-RoleBinding" class="headerlink" title="åˆ›å»º RoleBinding"></a>åˆ›å»º RoleBinding</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain">apiVersion: rbac.authorization.k8s.io/v1<br>kind: RoleBinding<br>metadata:<br>  name: rb<br>  namespace: default<br>subjects:<br>- kind: ServiceAccount<br>  name: zhangsan<br>  namespace: default<br>roleRef:<br>  kind: Role<br>  name: pod-role<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure><h5 id="åˆ›å»º-ClusterRoleBinding"><a href="#åˆ›å»º-ClusterRoleBinding" class="headerlink" title="åˆ›å»º ClusterRoleBinding"></a>åˆ›å»º ClusterRoleBinding</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plain">apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: crb<br>subjects:<br>- kind: ServiceAccount<br>  name: zhangsan<br>  namespace: default<br>roleRef:<br>  kind: ClusterRole<br>  name: pod-clusterrole<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure><h5 id="å­èµ„æºç»‘å®š"><a href="#å­èµ„æºç»‘å®š" class="headerlink" title="å­èµ„æºç»‘å®š"></a>å­èµ„æºç»‘å®š</h5><p>Kubernetes é›†ç¾¤å†…ä¸€äº›èµ„æºä¸€èˆ¬ä»¥å…¶åç§°å­—ç¬¦ä¸²æ¥è¡¨ç¤ºï¼Œè¿™äº›å­—ç¬¦ä¸²ä¸€èˆ¬ä¼šåœ¨ API çš„ URL åœ°å€ä¸­å‡ºç°ï¼›åŒæ—¶æŸäº›èµ„æºä¹Ÿä¼šåŒ…å«å­èµ„æºï¼Œä¾‹å¦‚ logs å°±å±äº Pod çš„å­èµ„æºï¼ŒAPI ä¸­ URL çš„æ ·ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">GET /api/v1/namespaces/&#123;namespace&#125;/pods/&#123;name&#125;/log<br></code></pre></td></tr></table></figure><p>å¦‚æœè¦åœ¨ RBAC æˆæƒæ¨¡å‹ä¸­æ§åˆ¶è¿™äº›å­èµ„æºçš„è®¿é—®æƒé™ï¼Œå¯ä»¥é€šè¿‡<code>/</code> åˆ†éš”ç¬¦æ¥å®ç°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">crb</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>  <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;pods/loog&quot;</span>]<br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>]<br></code></pre></td></tr></table></figure><h5 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h5><p>Subjects å¯ä»¥æ˜¯ groupsã€users æˆ–è€… saã€‚</p><p>Users ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šçš„åå­—å­—ç¬¦ä¸²ï¼Œå¦‚â€œzhangsanâ€ï¼›ä¹Ÿå¯ä»¥æ˜¯ email æ ¼å¼çš„é‚®ç®±åœ°å€ï¼›ç”šè‡³æ˜¯ä¸€ç»„å­—ç¬¦ä¸²å½¢å¼çš„æ•°å­— IDã€‚ä½†æ˜¯ User çš„å‰ç¼€ <code>system:</code> æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œé›†ç¾¤ç®¡ç†å‘˜åº”ç¡®ä¿æ™®é€šç”¨æˆ·ä¸ä¼šä½¿ç”¨è¿™ä¸ªå‰ç¼€æ ¼å¼ã€‚</p><p>Groups ä¹¦å†™æ ¼å¼ä¸ Users ç›¸åŒï¼Œéƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ²¡æœ‰ç‰¹å®šçš„æ ¼å¼è¦æ±‚ï¼›åŒæ · <code>system:</code>ä¸ºç³»ç»Ÿä¿ç•™</p><h2 id="å‡†å…¥æ§åˆ¶"><a href="#å‡†å…¥æ§åˆ¶" class="headerlink" title="å‡†å…¥æ§åˆ¶"></a>å‡†å…¥æ§åˆ¶</h2><p>å¸¸ç”¨çš„å‡ ä¸ªæ’ä»¶çš„åŠŸèƒ½</p><ul><li>NamespaceLifecycleï¼šé˜²æ­¢åœ¨ä¸å­˜åœ¨çš„ namespace ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œé˜²æ­¢åˆ é™¤ç³»ç»Ÿé¢„ç½®çš„ namespaceï¼Œåˆ é™¤ namespace æ—¶ï¼Œè¿å¸¦åˆ é™¤å®ƒçš„æ‰€æœ‰èµ„æºå¯¹è±¡</li><li>LimitRangerï¼šç¡®ä¿è¯·æ±‚çš„èµ„æºä¸ä¼šè¶…è¿‡ namespace çš„ LimitRange çš„é™åˆ¶</li><li>ServiceAccountï¼šå®ç°äº†è‡ªåŠ¨åŒ–æ·»åŠ  ServiceAccount</li><li>ResourceQuotaï¼šç¡®ä¿è¯·æ±‚çš„èµ„æºä¸ä¼šè¶…è¿‡èµ„æºçš„ ResourceQuota é™åˆ¶</li></ul>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Ubuntuå’ŒCentosçš„åŒºåˆ«</title>
    <link href="/2025/11/20/Ubuntu%E5%92%8CCentos%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <url>/2025/11/20/Ubuntu%E5%92%8CCentos%E7%9A%84%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="Ubuntu-å’Œ-Centos-çš„åŒºåˆ«"><a href="#Ubuntu-å’Œ-Centos-çš„åŒºåˆ«" class="headerlink" title="Ubuntu å’Œ Centos çš„åŒºåˆ«"></a>Ubuntu å’Œ Centos çš„åŒºåˆ«</h2><h5 id="1ã€è½¯ä»¶å®‰è£…å·¥å…·"><a href="#1ã€è½¯ä»¶å®‰è£…å·¥å…·" class="headerlink" title="1ã€è½¯ä»¶å®‰è£…å·¥å…·"></a>1ã€è½¯ä»¶å®‰è£…å·¥å…·</h5><table><thead><tr><th>æ“ä½œ</th><th>CentOS 7ï¼ˆyumï¼‰</th><th>Ubuntu 22.04ï¼ˆaptï¼‰</th></tr></thead><tbody><tr><td>æ›´æ–°è½¯ä»¶æºç´¢å¼•</td><td><code>yum check-update</code>ï¼ˆè‡ªåŠ¨ï¼‰</td><td><code>sudo apt update</code>ï¼ˆå¿…é¡»æ‰‹åŠ¨ï¼‰</td></tr><tr><td>å®‰è£…è½¯ä»¶</td><td><code>sudo yum install httpd</code></td><td><code>sudo apt install apache2</code></td></tr><tr><td>å¸è½½è½¯ä»¶</td><td><code>sudo yum remove httpd</code></td><td><code>sudo apt remove apache2</code></td></tr><tr><td>æœç´¢è½¯ä»¶</td><td><code>yum search nginx</code></td><td><code>apt search nginx</code></td></tr><tr><td>æŸ¥çœ‹è½¯ä»¶ä¿¡æ¯</td><td><code>yum info nginx</code></td><td><code>apt show nginx</code></td></tr><tr><td>å‡çº§æ‰€æœ‰åŒ…</td><td><code>sudo yum update</code></td><td><code>sudo apt upgrade</code>ï¼ˆæˆ– <code>apt full-upgrade</code>ï¼‰</td></tr><tr><td>æ¸…ç†ç¼“å­˜</td><td><code>sudo yum clean all</code></td><td><code>sudo apt clean</code> æˆ– <code>sudo apt autoclean</code></td></tr></tbody></table><h5 id="2ã€é˜²ç«å¢™"><a href="#2ã€é˜²ç«å¢™" class="headerlink" title="2ã€é˜²ç«å¢™"></a>2ã€é˜²ç«å¢™</h5><table><thead><tr><th>é»˜è®¤é˜²ç«å¢™</th><th><code>firewalld</code></th><th><code>ufw</code>ï¼ˆUncomplicated Firewallï¼‰</th></tr></thead><tbody><tr><td>å¯ç”¨é˜²ç«å¢™</td><td><code>sudo systemctl start firewalld</code></td><td><code>sudo ufw enable</code></td></tr><tr><td>å¼€æ”¾ç«¯å£</td><td><code>sudo firewall-cmd --add-port=80/tcp --permanent</code> <code>sudo firewall-cmd --reload</code></td><td><code>sudo ufw allow 80/tcp</code></td></tr><tr><td>æŸ¥çœ‹è§„åˆ™</td><td><code>firewall-cmd --list-all</code></td><td><code>sudo ufw status verbose</code></td></tr></tbody></table><p>ğŸ’¡ Ubuntu æœåŠ¡å™¨é»˜è®¤ <strong>ufw æœªå¯ç”¨</strong>ï¼Œä½†åº•å±‚ä»å¯ç”¨ <code>iptables</code> æˆ– <code>nftables</code>ã€‚</p><h5 id="3ã€ç½‘ç»œç®¡ç†"><a href="#3ã€ç½‘ç»œç®¡ç†" class="headerlink" title="3ã€ç½‘ç»œç®¡ç†"></a>3ã€ç½‘ç»œç®¡ç†</h5><table><thead><tr><th>é…ç½®æ–‡ä»¶ä½ç½®</th><th><code>/etc/sysconfig/network-scripts/ifcfg-eth0</code></th><th><code>/etc/netplan/*.yaml</code></th></tr></thead><tbody><tr><td>é…ç½®æ ¼å¼</td><td>ä¼ ç»Ÿé”®å€¼å¯¹ï¼ˆ<code>KEY=value</code>ï¼‰</td><td>YAMLï¼ˆç¼©è¿›æ•æ„Ÿï¼‰</td></tr><tr><td>åº”ç”¨é…ç½®</td><td><code>sudo systemctl restart network</code></td><td><code>sudo netplan apply</code></td></tr><tr><td>æŸ¥çœ‹ IP</td><td><code>ip a</code> æˆ– <code>ifconfig</code>ï¼ˆéœ€å®‰è£… net-toolsï¼‰</td><td>åŒå·¦</td></tr></tbody></table><p>é…ç½®æ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">network:</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">ethernets:</span><br>    <span class="hljs-attr">eth0:</span><br>      <span class="hljs-attr">addresses:</span> [<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span><span class="hljs-string">/24</span>]<br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">default</span><br>          <span class="hljs-attr">via:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><br>      <span class="hljs-attr">nameservers:</span><br>        <span class="hljs-attr">addresses:</span> [<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>]<br></code></pre></td></tr></table></figure><h5 id="4ã€å…¶ä»–å·®å¼‚"><a href="#4ã€å…¶ä»–å·®å¼‚" class="headerlink" title="4ã€å…¶ä»–å·®å¼‚"></a>4ã€å…¶ä»–å·®å¼‚</h5><table><thead><tr><th>æŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬</th><th><code>cat /etc/redhat-release</code> æˆ– <code>hostnamectl</code></th><th><code>lsb_release -a</code> æˆ– <code>cat /etc/os-release</code></th></tr></thead><tbody><tr><td>é»˜è®¤ Shell é…ç½®æ–‡ä»¶</td><td><code>~/.bash_profile</code></td><td><code>~/.bashrc</code>ï¼ˆç™»å½• shell ä¹Ÿä¼šåŠ è½½ï¼‰</td></tr><tr><td>è½¯ä»¶æºé…ç½®</td><td><code>/etc/yum.repos.d/</code></td><td><code>/etc/apt/sources.list</code> å’Œ <code>/etc/apt/sources.list.d/</code></td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sv1.28.1éƒ¨ç½²-åŸºäºkubeadm</title>
    <link href="/2025/11/19/K8sv1-28-1%E9%83%A8%E7%BD%B2-%E5%9F%BA%E4%BA%8Ekubeadm/"/>
    <url>/2025/11/19/K8sv1-28-1%E9%83%A8%E7%BD%B2-%E5%9F%BA%E4%BA%8Ekubeadm/</url>
    
    <content type="html"><![CDATA[<h1 id="Centos7éƒ¨ç½²K8s1-28é›†ç¾¤-Containerd"><a href="#Centos7éƒ¨ç½²K8s1-28é›†ç¾¤-Containerd" class="headerlink" title="Centos7éƒ¨ç½²K8s1.28é›†ç¾¤-Containerd"></a>Centos7éƒ¨ç½²K8s1.28é›†ç¾¤-Containerd</h1><h3 id="ä¸€ã€æ¶æ„åˆ’åˆ†"><a href="#ä¸€ã€æ¶æ„åˆ’åˆ†" class="headerlink" title="ä¸€ã€æ¶æ„åˆ’åˆ†"></a>ä¸€ã€æ¶æ„åˆ’åˆ†</h3><h5 id="1ã€èŠ‚ç‚¹"><a href="#1ã€èŠ‚ç‚¹" class="headerlink" title="1ã€èŠ‚ç‚¹"></a>1ã€èŠ‚ç‚¹</h5><table><thead><tr><th><strong>èŠ‚ç‚¹ç±»å‹</strong></th><th><strong>æ•°é‡</strong></th><th><strong>æ¨èé…ç½®</strong></th><th><strong>å…³é”®ç»„ä»¶</strong></th></tr></thead><tbody><tr><td>Master</td><td>1</td><td>4C4G 40G</td><td>kube-apiserverï¼Œetcdï¼Œkube-scheduler â€¦</td></tr><tr><td>Worker1</td><td>1</td><td>8C8G 100G</td><td>kubeletï¼Œkube-proxy</td></tr><tr><td>Worker2</td><td>1</td><td>8C8G 100G</td><td>kubeletï¼Œkube-proxy</td></tr></tbody></table><h5 id="2ã€ç½‘ç»œ"><a href="#2ã€ç½‘ç»œ" class="headerlink" title="2ã€ç½‘ç»œ"></a>2ã€ç½‘ç»œ</h5><table><thead><tr><th><strong>ç½‘ç»œç±»å‹</strong></th><th><strong>CIDR</strong></th><th><strong>ç”¨é€”è¯´æ˜</strong></th></tr></thead><tbody><tr><td>èŠ‚ç‚¹ç®¡ç†ç½‘ç»œ</td><td>192.168.213.0&#x2F;24</td><td>ssh&#x2F;k8sç»„ä»¶é€šä¿¡</td></tr><tr><td>Podç½‘ç»œ</td><td>10.244.0.0&#x2F;16</td><td>k8sç½‘ç»œç»„ä»¶é€šä¿¡</td></tr><tr><td>Serviceç½‘ç»œ</td><td>10.96.0.0&#x2F;16</td><td>Serviceç½‘ç»œ</td></tr><tr><td>Ingressç½‘ç»œ</td><td>192.168.100.0&#x2F;24</td><td>å¤–éƒ¨è®¿é—®å…¥å£</td></tr></tbody></table><h3 id="äºŒã€åŸºç¡€ç¯å¢ƒé…ç½®"><a href="#äºŒã€åŸºç¡€ç¯å¢ƒé…ç½®" class="headerlink" title="äºŒã€åŸºç¡€ç¯å¢ƒé…ç½®"></a>äºŒã€åŸºç¡€ç¯å¢ƒé…ç½®</h3><h5 id="1ã€é˜²ç«å¢™å’Œselinux"><a href="#1ã€é˜²ç«å¢™å’Œselinux" class="headerlink" title="1ã€é˜²ç«å¢™å’Œselinux"></a>1ã€é˜²ç«å¢™å’Œselinux</h5><p>å…³é—­é˜²ç«å¢™å¹¶å…³é—­å¼€æœºè‡ªå¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">systemctl disable firewalld --now<br># æŸ¥çœ‹çŠ¶æ€<br>[root@master ~]# systemctl status firewalld<br>â— firewalld.service - firewalld - dynamic firewall daemon<br>   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)<br>   Active: inactive (dead)<br>     Docs: man:firewalld(1)<br></code></pre></td></tr></table></figure><p>å…³é—­selinux</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config<br>setenforce 0<br># æŸ¥çœ‹çŠ¶æ€<br>[root@master ~]# getenforce<br>Disabled<br></code></pre></td></tr></table></figure><h5 id="2ã€swapäº¤æ¢åˆ†åŒº"><a href="#2ã€swapäº¤æ¢åˆ†åŒº" class="headerlink" title="2ã€swapäº¤æ¢åˆ†åŒº"></a>2ã€swapäº¤æ¢åˆ†åŒº</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain"># ä¸´æ—¶ç¦ç”¨<br>swapoff -a<br># æ°¸ä¹…ç¦ç”¨<br>swapoff -a &amp;&amp; sed -i &#x27;/ swap / s/^\(.*\)$/#\1/g&#x27; /etc/fstab<br># æŸ¥çœ‹çŠ¶æ€<br>free -h<br></code></pre></td></tr></table></figure><h5 id="3ã€æ—¶é—´åŒæ­¥"><a href="#3ã€æ—¶é—´åŒæ­¥" class="headerlink" title="3ã€æ—¶é—´åŒæ­¥"></a>3ã€æ—¶é—´åŒæ­¥</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">yum -y install ntpdate<br># é…ç½®å®šæ—¶ä»»åŠ¡<br>crontab -e <br><br>30 2 * * * /usr/sbin/ntpdate time1.aliyun.com &gt;/dev/null 2&gt;&amp;1<br></code></pre></td></tr></table></figure><h5 id="4ã€é…ç½®hostsåŠå…å¯†"><a href="#4ã€é…ç½®hostsåŠå…å¯†" class="headerlink" title="4ã€é…ç½®hostsåŠå…å¯†"></a>4ã€é…ç½®hostsåŠå…å¯†</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain"># é…ç½®hostsè§£æ<br>vim /etc/hosts<br>192.168.213.66 master<br>192.168.213.67 node<br># é…ç½®å…å¯†<br>ssh-keygen<br>ssh-copy-id node1<br></code></pre></td></tr></table></figure><h5 id="5ã€å†…æ ¸ä¼˜åŒ–"><a href="#5ã€å†…æ ¸ä¼˜åŒ–" class="headerlink" title="5ã€å†…æ ¸ä¼˜åŒ–"></a>5ã€å†…æ ¸ä¼˜åŒ–</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &gt;/etc/sysctl.d/k8s.conf &lt;&lt;EOF<br>net.bridge.bridge-nf-call-iptables  = 1<br>net.bridge.bridge-nf-call-ip6tables = 1<br>net.ipv4.ip_forward = 1<br>fs.file-max = 2097152    # è¡¨ç¤ºæ•´ä¸ªç³»ç»Ÿå¯ä»¥åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„çš„æœ€å¤§æ•°ç›®<br>user.max_user_namespaces=28633    # è¡¨ç¤ºç³»ç»Ÿå…è®¸æ¯ä¸ªç”¨æˆ·æœ€å¤šåˆ›å»º 28633 ä¸ªç”¨æˆ·å‘½åç©ºé—´ã€‚<br>vm.swappiness=0        # è¡¨ç¤ºå†…æ ¸ä¼šå°½é‡é¿å…ä½¿ç”¨ swap<br>EOF<br><br># åº”ç”¨å‚æ•°<br>sysctl --system<br><br>cat &gt;/etc/modules-load.d/k8s.conf &lt;&lt;EOF<br>overlay<br>br_netfilter<br>EOF<br># åŠ è½½å†…æ ¸æ¨¡å—<br>modprobe overlay<br>modprobe br_netfilter<br># æŸ¥çœ‹æ˜¯å¦è¢«åŠ è½½<br>lsmod |grep overlay<br>lsmod |grep br_netfilter<br><br># ç¼–è¾‘ /etc/security/limits.confï¼Œæ·»åŠ ï¼š<br>cat &gt;&gt;/etc/security/limits.conf &lt;&lt;EOF<br>* soft nofile 65535<br>* hard nofile 65535<br>EOF<br># æŸ¥çœ‹<br>ulimit -n<br></code></pre></td></tr></table></figure><h5 id="6ã€yumæºé…ç½®ï¼ˆrockyï¼‰"><a href="#6ã€yumæºé…ç½®ï¼ˆrockyï¼‰" class="headerlink" title="6ã€yumæºé…ç½®ï¼ˆrockyï¼‰"></a>6ã€yumæºé…ç½®ï¼ˆrockyï¼‰</h5><h5 id="7ã€é…ç½®ipvs"><a href="#7ã€é…ç½®ipvs" class="headerlink" title="7ã€é…ç½®ipvs"></a>7ã€é…ç½®ipvs</h5><p>åˆ›å»º<code>/etc/modules-load.d/ipvs.conf</code>æ–‡ä»¶ï¼Œä¿è¯åœ¨èŠ‚ç‚¹é‡å¯åèƒ½è‡ªåŠ¨åŠ è½½æ‰€éœ€æ¨¡å—:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF<br>ip_vs<br>ip_vs_rr<br>ip_vs_wrr<br>ip_vs_sh<br>EOF<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åŠ è½½æ¨¡å—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">modprobe ip_vs<br>modprobe ip_vs_rr<br>modprobe ip_vs_wrr<br>modprobe ip_vs_sh<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿˜éœ€è¦ç¡®ä¿å„ä¸ªèŠ‚ç‚¹ä¸Šå·²ç»å®‰è£…äº†ipsetè½¯ä»¶åŒ…ï¼Œä¸ºäº†ä¾¿äºæŸ¥çœ‹ipvsçš„ä»£ç†è§„åˆ™ï¼Œæœ€å¥½å®‰è£…ä¸€ä¸‹ç®¡ç†å·¥å…·ipvsadmã€‚</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y ipset ipvsadm<br></code></pre></td></tr></table></figure><h3 id="ä¸‰ã€containerdå®‰è£…"><a href="#ä¸‰ã€containerdå®‰è£…" class="headerlink" title="ä¸‰ã€containerdå®‰è£…"></a>ä¸‰ã€containerdå®‰è£…</h3><h5 id="1ã€é…ç½®æº"><a href="#1ã€é…ç½®æº" class="headerlink" title="1ã€é…ç½®æº"></a>1ã€é…ç½®æº</h5><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨dockerçš„æºï¼Œdockerç”¨çš„ä¹Ÿæ˜¯containerd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain"># å®‰è£…å¿…è¦çš„ä¸€äº›ç³»ç»Ÿå·¥å…·<br>yum install -y yum-utils<br><br># æ·»åŠ è½¯ä»¶æºä¿¡æ¯<br>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure><h5 id="2ã€å®‰è£…å’Œé»˜è®¤é…ç½®åˆå§‹åŒ–"><a href="#2ã€å®‰è£…å’Œé»˜è®¤é…ç½®åˆå§‹åŒ–" class="headerlink" title="2ã€å®‰è£…å’Œé»˜è®¤é…ç½®åˆå§‹åŒ–"></a>2ã€å®‰è£…å’Œé»˜è®¤é…ç½®åˆå§‹åŒ–</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain"># å®‰è£…containerd<br>yum install -y containerd.io<br># é…ç½®æ–‡ä»¶åˆå§‹åŒ–<br>mkdir -p /etc/containerd<br>containerd config default | tee /etc/containerd/config.toml<br><br># ä¿®æ”¹systemd cgroupé©±åŠ¨å’Œpauseé•œåƒåœ°å€<br>sed -i &#x27;s/SystemdCgroup \= false/SystemdCgroup \= true/g&#x27; /etc/containerd/config.toml<br>sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.9&quot;<br>more /etc/containerd/config.toml<br>[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]<br>....<br>SystemdCgroup = true<br>....<br><br># é‡å¯æœåŠ¡<br>systemctl restart containerd &amp;&amp; systemctl enable containerd<br></code></pre></td></tr></table></figure><h5 id="3ã€é…ç½®é•œåƒåŠ é€Ÿ"><a href="#3ã€é…ç½®é•œåƒåŠ é€Ÿ" class="headerlink" title="3ã€é…ç½®é•œåƒåŠ é€Ÿ"></a>3ã€é…ç½®é•œåƒåŠ é€Ÿ</h5><p>1ã€åœ¨containerd1.5ä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨è¿™ç§é…ç½®æ›´ä¸ºç®€å•ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥åˆ›å»ºç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain"># åˆ›å»ºç›®å½•<br>mkdir /etc/containerd/certs.d<br></code></pre></td></tr></table></figure><p>2ã€åˆ›å»ºç›¸å¯¹åº”çš„åŠ é€Ÿé…ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plain"># docker hubé•œåƒåŠ é€Ÿ<br>mkdir /etc/containerd/certs.d/docker.io<br>cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF<br>server = &quot;https://docker.io&quot;<br>[host.&quot;https://82m9ar63.mirror.aliyuncs.com&quot;]<br>  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]<br>EOF<br><br><br># registry.k8s.ioé•œåƒåŠ é€Ÿ<br>mkdir -p /etc/containerd/certs.d/registry.k8s.io<br>tee /etc/containerd/certs.d/registry.k8s.io/hosts.toml &lt;&lt; &#x27;EOF&#x27;<br>server = &quot;https://registry.k8s.io&quot;<br>[host.&quot;https://registry.aliyuncs.com/google_containers&quot;]<br>  capabilities = [&quot;pull&quot;, &quot;resolve&quot;, &quot;push&quot;]<br>EOF<br><br><br># docker.elastic.coé•œåƒåŠ é€Ÿ<br>mkdir -p /etc/containerd/certs.d/docker.elastic.co<br>tee /etc/containerd/certs.d/docker.elastic.co/hosts.toml &lt;&lt; &#x27;EOF&#x27;<br>server = &quot;https://docker.elastic.co&quot;<br>[host.&quot;https://elastic.m.daocloud.io&quot;]<br>  capabilities = [&quot;pull&quot;, &quot;resolve&quot;, &quot;push&quot;]<br>EOF<br></code></pre></td></tr></table></figure><p>3ã€ä¿®æ”¹ä¸»é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain"># ä¿®æ”¹containerdçš„é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹<br>[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]<br>   config_path = &quot;/etc/containerd/certs.d&quot;<br></code></pre></td></tr></table></figure><h3 id="å››ã€kubeadmå®‰è£…é›†ç¾¤"><a href="#å››ã€kubeadmå®‰è£…é›†ç¾¤" class="headerlink" title="å››ã€kubeadmå®‰è£…é›†ç¾¤"></a>å››ã€kubeadmå®‰è£…é›†ç¾¤</h3><h5 id="1ã€é…ç½®k8sçš„æºæ–‡ä»¶"><a href="#1ã€é…ç½®k8sçš„æºæ–‡ä»¶" class="headerlink" title="1ã€é…ç½®k8sçš„æºæ–‡ä»¶"></a>1ã€é…ç½®k8sçš„æºæ–‡ä»¶</h5><p>1ã€å®˜æ–¹æºæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/<br>enabled=1<br>gpgcheck=1<br>gpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key<br>exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni<br>EOF<br></code></pre></td></tr></table></figure><p>2ã€é˜¿é‡Œäº‘æºæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &lt;&lt;EOF | tee /etc/yum.repos.d/kubernetes.repo<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/<br>enabled=1<br>gpgcheck=1<br>gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/repodata/repomd.xml.key<br>EOF<br></code></pre></td></tr></table></figure><h5 id="2ã€å®‰è£…kubectlï¼Œkubeadmï¼Œkubelet"><a href="#2ã€å®‰è£…kubectlï¼Œkubeadmï¼Œkubelet" class="headerlink" title="2ã€å®‰è£…kubectlï¼Œkubeadmï¼Œkubelet"></a>2ã€å®‰è£…kubectlï¼Œkubeadmï¼Œkubelet</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">yum install -y kubelet kubeadm kubectl<br>systemctl enable kubelet --now<br></code></pre></td></tr></table></figure><h5 id="3ã€kubeadmåˆå§‹åŒ–é›†ç¾¤"><a href="#3ã€kubeadmåˆå§‹åŒ–é›†ç¾¤" class="headerlink" title="3ã€kubeadmåˆå§‹åŒ–é›†ç¾¤"></a>3ã€kubeadmåˆå§‹åŒ–é›†ç¾¤</h5><p>åœ¨åˆå§‹åŒ–é›†ç¾¤ä¹‹å‰å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šé¢„å…ˆä¸‹è½½k8séœ€è¦çš„é•œåƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">kubeadm config images list<br>kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–é›†ç¾¤ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ç§å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm init --apiserver-advertise-address=192.168.213.66 --control-plane-endpoint=master --service-cidr=10.96.0.0/16 --pod-network-cidr=10.244.0.0/16 --image-repository registry.aliyuncs.com/google_containers<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨é…ç½®æ–‡ä»¶éœ€è¦å…ˆç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶æˆ–è€…åœ¨ç½‘ä¸Šä¸‹è½½ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ›´æ”¹å…³é”®é…ç½®å³å¯</p><p>ä½¿ç”¨kubeadmæ‰“å°é›†ç¾¤åˆå§‹åŒ–é»˜è®¤é…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm config <span class="hljs-built_in">print</span> init-defaults --component-configs KubeletConfiguration &gt;kubeadm-init.yaml<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å…³é”®é…ç½®ï¼Œæ ¹æ®è‡ªå·±çš„æƒ…å†µæ›´æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# cat kubeadm-init.yaml<br>apiVersion: kubeadm.k8s.io/v1beta3<br>bootstrapTokens:<br>- groups:<br>  - system:bootstrappers:kubeadm:default-node-token<br>  token: abcdef.0123456789abcdef<br>  ttl: 24h0m0s<br>  usages:<br>  - signing<br>  - authentication<br>kind: InitConfiguration<br>localAPIEndpoint:<br>  advertiseAddress: 192.168.213.66#ä¸»æœºåœ°å€<br>  bindPort: 6443# ä¸»æœºç«¯å£<br>nodeRegistration:<br>  criSocket: unix:///run/containerd/containerd.sock# æ ¹æ®è‡ªå·±ä½¿ç”¨çš„å®¹å™¨è¿›è¡Œæ—¶è¿›è¡Œæ›´æ”¹ï¼Œé»˜è®¤æ˜¯containerd<br>  imagePullPolicy: IfNotPresent<br>  name: master# ä¸»æœºå<br>  taints: null<br>---<br>apiServer:<br>  timeoutForControlPlane: 4m0s<br>apiVersion: kubeadm.k8s.io/v1beta3<br>certificatesDir: /etc/kubernetes/pki<br>clusterName: kubernetes<br>controllerManager: &#123;&#125;<br>dns: &#123;&#125;<br>etcd:<br>  local:<br>    dataDir: /var/lib/etcd<br>imageRepository: registry.aliyuncs.com/google_containers# ä¿®æ”¹ä¸ºå›½å†…é˜¿é‡Œäº‘çš„åœ°å€<br>kind: ClusterConfiguration<br>kubernetesVersion: 1.28.0<br>networking:<br>  dnsDomain: cluster.local<br>  serviceSubnet: 10.96.0.0/16# serviceçš„cidrå—<br>  podSubnet: 10.244.0.0/16# podçš„cidrå—<br>scheduler: &#123;&#125;<br>---<br>apiVersion: kubelet.config.k8s.io/v1beta1<br>authentication:<br>  anonymous:<br>    enabled: false<br>  webhook:<br>    cacheTTL: 0s<br>    enabled: true<br>  x509:<br>    clientCAFile: /etc/kubernetes/pki/ca.crt<br>authorization:<br>  mode: Webhook<br>  webhook:<br>    cacheAuthorizedTTL: 0s<br>    cacheUnauthorizedTTL: 0s<br>cgroupDriver: systemd# ä½¿ç”¨systemd<br>clusterDNS:<br>- 10.96.0.10<br>clusterDomain: cluster.local<br>containerRuntimeEndpoint: &quot;&quot;<br>cpuManagerReconcilePeriod: 0s<br>evictionPressureTransitionPeriod: 0s<br>fileCheckFrequency: 0s<br>healthzBindAddress: 127.0.0.1<br>healthzPort: 10248<br>httpCheckFrequency: 0s<br>imageMinimumGCAge: 0s<br>kind: KubeletConfiguration<br>logging:<br>  flushFrequency: 0<br>  options:<br>    json:<br>      infoBufferSize: &quot;0&quot;<br>  verbosity: 0<br>memorySwap: &#123;&#125;<br>nodeStatusReportFrequency: 0s<br>nodeStatusUpdateFrequency: 0s<br>rotateCertificates: true<br>runtimeRequestTimeout: 0s<br>shutdownGracePeriod: 0s<br>shutdownGracePeriodCriticalPods: 0s<br>staticPodPath: /etc/kubernetes/manifests<br>streamingConnectionIdleTimeout: 0s<br>syncFrequency: 0s<br>volumeStatsAggPeriod: 0s<br>---<br>apiVersion: kubeproxy.config.k8s.io/v1alpha1<br>kind: KubeProxyConfiguration<br>mode: ipvs# ä½¿ç”¨ipvs<br></code></pre></td></tr></table></figure><p>æ ¹æ®è¿™ä¸ªæ–‡ä»¶å†…å®¹åˆ›å»ºé›†ç¾¤</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">kubeadm <span class="hljs-keyword">init</span> --config kubeadm-<span class="hljs-keyword">init</span>.yaml<br></code></pre></td></tr></table></figure><h5 id="4ã€è®°å½•é›†ç¾¤ä¿¡æ¯"><a href="#4ã€è®°å½•é›†ç¾¤ä¿¡æ¯" class="headerlink" title="4ã€è®°å½•é›†ç¾¤ä¿¡æ¯"></a>4ã€è®°å½•é›†ç¾¤ä¿¡æ¯</h5><p>åœ¨å®‰è£…å®Œæˆä¹‹åä¼šæ‰“å°ä¸€å †ä¸œè¥¿ï¼ŒæŠŠå…³é”®çš„ä¿¡æ¯å¤åˆ¶å‡ºæ¥ä»¥ä¾¿ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plain">Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  mkdir -p $HOME/.kube<br>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>  sudo chown $(id -u):$(id -g) $HOME/.kube/config<br><br>Alternatively, if you are the root user, you can run:<br><br>  export KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>Then you can join any number of worker nodes by running the following on each as root:<br><br>kubeadm join 172.16.1.60:6443 --token abcdef.0123456789abcdef \<br>        --discovery-token-ca-cert-hash sha256:350078e0960a0c28fd45d76ab7289390650df9b6810da7a89775e61a74e6d37a<br># ä½¿ç”¨æ­¤å‘½ä»¤è®©nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤<br></code></pre></td></tr></table></figure><p>CRIçš„æ¥å£é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯ä¾æ¬¡è¯»å–<code>unix:///run/containerd/containerd.sock</code> ã€<code>unix:///run/crio/crio.sock</code>ã€ <code>unix:///var/run/cri-dockerd.sock</code>è¿™ä¸‰ä¸ªå˜é‡ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬å·²ç»å¼ƒç”¨äº†è¿™ä¸ªé…ç½®ï¼Œå¹¶ä¸”å»ºè®®æˆ‘ä»¬è‡ªè¡Œé…ç½®ã€‚å¦‚æœä¸é…ç½®éœ€è¦åœ¨å‘½ä»¤æŒ‡å®šcriæ¥å£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &gt;/etc/crictl.yaml &lt;&lt;EOF<br>&gt; runtime-endpoint: unix:///run/containerd/containerd.sock<br>&gt; image-endpoint: unix:///run/containerd/containerd.sock<br>&gt; timeout: 2<br>&gt; debug: false<br>&gt; pull-image-on-create: false<br>EOF<br></code></pre></td></tr></table></figure><p>åœ¨å®Œæˆä¸Šè¿°æ­¥éª¤ä¹‹åï¼ŒæŸ¥çœ‹æˆ‘ä»¬å®‰è£…çš„é›†ç¾¤ä¿¡æ¯ï¼ŒçŠ¶æ€åœ¨å®‰è£…ç½‘ç»œæ’ä»¶ä¹‹åä¼šæ­£å¸¸ï¼ŒåŒ…æ‹¬corednsçŠ¶æ€ä¹Ÿä¼šä»Pendingè½¬åˆ°Runningã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# kubectl get nodes<br>NAME     STATUS     ROLES           AGE     VERSION<br>master   NotReady   control-plane   2m38s   v1.28.15<br>node     NotReady   &lt;none&gt;          10s     v1.28.15<br></code></pre></td></tr></table></figure><h5 id="5ã€é‡ç½®å‘½ä»¤"><a href="#5ã€é‡ç½®å‘½ä»¤" class="headerlink" title="5ã€é‡ç½®å‘½ä»¤"></a>5ã€é‡ç½®å‘½ä»¤</h5><p>é›†ç¾¤åˆå§‹åŒ–å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨<code>kubeadm reset</code>å‘½ä»¤è¿›è¡Œæ¸…ç†ã€‚</p><h3 id="äº”ã€éƒ¨ç½²Calicoç½‘ç»œæ’ä»¶"><a href="#äº”ã€éƒ¨ç½²Calicoç½‘ç»œæ’ä»¶" class="headerlink" title="äº”ã€éƒ¨ç½²Calicoç½‘ç»œæ’ä»¶"></a>äº”ã€éƒ¨ç½²Calicoç½‘ç»œæ’ä»¶</h3><h5 id="1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶"><a href="#1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶" class="headerlink" title="1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶"></a>1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶</h5><p><a href="https://docs.tigera.io/calico/latest/about/">calicoå®˜ç½‘</a></p><p>æ­¤æ¬¡æˆ‘ä»¬ä½¿ç”¨calicoä½œä¸ºç½‘ç»œæ’ä»¶ï¼Œé¦–å…ˆä¸‹è½½k8sçš„æ¸…å•æ–‡ä»¶</p><p>curl <a href="https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml">https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml</a> -O</p><h5 id="2ã€é…ç½®"><a href="#2ã€é…ç½®" class="headerlink" title="2ã€é…ç½®"></a>2ã€é…ç½®</h5><p>ä¿®æ”¹é•œåƒä»“åº“çš„é…ç½®ï¼Œè¿™é‡Œæ ¹æ®æƒ…å†µæ¥é…ç½®ï¼Œå¦‚æœé…ç½®äº†åŠ é€Ÿå™¨çš„æƒ…å†µä¸‹å¯ä»¥ä¸è€ƒè™‘ï¼Œå› ä¸ºæ˜¯docker.ioä¸‹çš„é•œåƒ</p><p>sed -i â€˜s|docker.io|xxx|gâ€™ calico.yaml</p><p>ä¿®æ”¹ä¸ºä¹‹å‰è®¾ç½®çš„servicesubnetçš„åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">- name: CALICO_IPV4POOL_CIDR<br>  value: &quot;10.244.0.0/16&quot;<br></code></pre></td></tr></table></figure><h5 id="3ã€éƒ¨ç½²"><a href="#3ã€éƒ¨ç½²" class="headerlink" title="3ã€éƒ¨ç½²"></a>3ã€éƒ¨ç½²</h5><p>æ›´æ”¹å®Œåä¿å­˜å¹¶æ¨å‡ºï¼Œæ‰§è¡Œéƒ¨ç½²å‘½ä»¤</p><p>kubectl apply -f calico.yaml</p><p>æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# kubectl get pod -n kube-system<br>NAME                                       READY   STATUS    RESTARTS      AGE<br>calico-kube-controllers-7ddc4f45bc-p9w5s   1/1     Running   1 (15m ago)   94m<br>calico-node-qt6qz                          1/1     Running   1 (16m ago)   94m<br>calico-node-wldxs                          1/1     Running   1 (15m ago)   94m<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ¥æŸ¥çœ‹nodesèµ„æºï¼Œä¼šå‘ç°çŠ¶æ€è½¬ä¸ºReady</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# kubectl get nodes<br>NAME     STATUS   ROLES           AGE     VERSION<br>master   Ready    control-plane   7h16m   v1.28.15<br>node     Ready    &lt;none&gt;          7h13m   v1.28.15<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ kube-proxy çš„è¿è¡Œæ¨¡å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl 127.0.0.1:10249/proxyMode<br>ipvs<br></code></pre></td></tr></table></figure><h3 id="å…­ã€éƒ¨ç½²helm"><a href="#å…­ã€éƒ¨ç½²helm" class="headerlink" title="å…­ã€éƒ¨ç½²helm"></a>å…­ã€éƒ¨ç½²helm</h3><h5 id="1ã€ä¸‹è½½helm"><a href="#1ã€ä¸‹è½½helm" class="headerlink" title="1ã€ä¸‹è½½helm"></a>1ã€ä¸‹è½½helm</h5><p>wget <a href="https://get.helm.sh/helm-v3.16.4-linux-amd64.tar.gz">https://get.helm.sh/helm-v3.16.4-linux-amd64.tar.gz</a></p><h5 id="2ã€å®‰è£…"><a href="#2ã€å®‰è£…" class="headerlink" title="2ã€å®‰è£…"></a>2ã€å®‰è£…</h5><p>è§£å‹å¹¶ç§»åŠ¨åˆ°æŒ‡å®šç›®å½•ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# tar -zxvf helm-v3.16.4-linux-amd64.tar.gz<br>linux-amd64/<br>linux-amd64/LICENSE<br>linux-amd64/helm<br>llinux-amd64/README.md<br>[root@master ~]# cp -rf linux-amd64/helm /usr/bin/helm<br>[root@master ~]# chmod +x /usr/bin/helm<br></code></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹åæŸ¥çœ‹æŸ¥çœ‹ç‰ˆæœ¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">[root@master ~]# helm version<br>version.BuildInfo&#123;Version:&quot;v3.16.4&quot;, GitCommit:&quot;7877b45b63f95635153b29a42c0c2f4273ec45ca&quot;, GitTreeState:&quot;clean&quot;, GoVersion:&quot;go1.22.7&quot;&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸‰ã€æ·»åŠ é»˜è®¤ä»“åº“"><a href="#ä¸‰ã€æ·»åŠ é»˜è®¤ä»“åº“" class="headerlink" title="ä¸‰ã€æ·»åŠ é»˜è®¤ä»“åº“"></a>ä¸‰ã€æ·»åŠ é»˜è®¤ä»“åº“</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">helm repo add  elastic    https://helm.elastic.co<br>helm repo add  gitlab     https://charts.gitlab.io<br>helm repo add  harbor     https://helm.goharbor.io<br>helm repo add bitnami https://charts.bitnami.com/bitnami<br></code></pre></td></tr></table></figure><h3 id="ä¸ƒã€éƒ¨ç½²ingress"><a href="#ä¸ƒã€éƒ¨ç½²ingress" class="headerlink" title="ä¸ƒã€éƒ¨ç½²ingress"></a>ä¸ƒã€éƒ¨ç½²ingress</h3><h5 id="1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶-1"><a href="#1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶-1" class="headerlink" title="1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶"></a>1ã€ä¸‹è½½æ¸…å•æ–‡ä»¶</h5><p>wget <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.13.1/deploy/static/provider/cloud/deploy.yaml">https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.13.1/deploy/static/provider/cloud/deploy.yaml</a></p><h5 id="2ã€ä¿®æ”¹é…ç½®"><a href="#2ã€ä¿®æ”¹é…ç½®" class="headerlink" title="2ã€ä¿®æ”¹é…ç½®"></a>2ã€ä¿®æ”¹é…ç½®</h5><p>ä¿®æ”¹é•œåƒåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">sed  -i &#x27;s##registry.cn-hangzhou.aliyuncs.com/image-storage/controller:v1.6.4#&#x27; deploy.yaml<br>sed  -i &#x27;s##registry.cn-hangzhou.aliyuncs.com/image-storage/kube-webhook-certgen:v20220916-gd32f8c343#&#x27; deploy.yaml<br></code></pre></td></tr></table></figure><h1 id="Centos7éƒ¨ç½²K8s1-28é›†ç¾¤-Docker"><a href="#Centos7éƒ¨ç½²K8s1-28é›†ç¾¤-Docker" class="headerlink" title="Centos7éƒ¨ç½²K8s1.28é›†ç¾¤-Docker"></a>Centos7éƒ¨ç½²K8s1.28é›†ç¾¤-Docker</h1><h3 id="ä¸‰ã€dockerå®‰è£…"><a href="#ä¸‰ã€dockerå®‰è£…" class="headerlink" title="ä¸‰ã€dockerå®‰è£…"></a>ä¸‰ã€dockerå®‰è£…</h3><p>1ã€è®¾ç½®dockerçš„æº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs plain"># step 1: å®‰è£…å¿…è¦çš„ä¸€äº›ç³»ç»Ÿå·¥å…·<br>yum install -y yum-utils<br><br># Step 2: æ·»åŠ è½¯ä»¶æºä¿¡æ¯<br>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br># Step 3: å®‰è£…Docker<br>yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y<br><br># Step 4: å¼€å¯DockeræœåŠ¡<br>systemctl enable docker --now<br><br># æ³¨æ„ï¼š<br># å®˜æ–¹è½¯ä»¶æºé»˜è®¤å¯ç”¨äº†æœ€æ–°çš„è½¯ä»¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡ç¼–è¾‘è½¯ä»¶æºçš„æ–¹å¼è·å–å„ä¸ªç‰ˆæœ¬çš„è½¯ä»¶åŒ…ã€‚ä¾‹å¦‚å®˜æ–¹å¹¶æ²¡æœ‰å°†æµ‹è¯•ç‰ˆæœ¬çš„è½¯ä»¶æºç½®ä¸ºå¯ç”¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼€å¯ã€‚åŒç†å¯ä»¥å¼€å¯å„ç§æµ‹è¯•ç‰ˆæœ¬ç­‰ã€‚<br># vim /etc/yum.repos.d/docker-ce.repo<br>#   å°†[docker-ce-test]ä¸‹æ–¹çš„enabled=0ä¿®æ”¹ä¸ºenabled=1<br>#<br># å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Docker-CE:<br># Step 1: æŸ¥æ‰¾Docker-CEçš„ç‰ˆæœ¬:<br># yum list docker-ce.x86_64 --showduplicates | sort -r<br>#   Loading mirror speeds from cached hostfile<br>#   Loaded plugins: branch, fastestmirror, langpacks<br>#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable<br>#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable<br>#   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable<br>#   Available Packages<br># Step2: å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Docker-CE: (VERSIONä¾‹å¦‚ä¸Šé¢çš„17.03.0.ce.1-1.el7.centos)<br># sudo yum -y install docker-ce-[VERSION]<br></code></pre></td></tr></table></figure><p>2ã€é…ç½®é•œåƒåŠ é€Ÿå™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://docker.m.daocloud.io&quot;],<br>  &quot;insecure-registries&quot;:  [&quot;192.168.236.67:8668&quot;],<br>  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],<br>  &quot;log-driver&quot;: &quot;json-file&quot;,<br>  &quot;log-opts&quot;: &#123;<br>    &quot;max-size&quot;: &quot;100m&quot;<br>  &#125;,<br>  &quot;storage-driver&quot;: &quot;overlay2&quot;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure><p>é…ç½®å®Œé•œåƒåŠ é€Ÿåé‡æ–°è½½å…¥é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure><p>3ã€é…ç½®cri-docker</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain"># ä¸‹è½½æ–‡ä»¶<br>wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.1/cri-dockerd-0.3.1-3.el7.x86_64.rpm<br>#å®‰è£…cri-dockerd<br>rpm -ivh cri-dockerd-0.3.1-3.el7.x86_64.rpm<br> <br>#ä¿®æ”¹é•œåƒåœ°å€ä¸ºå›½å†…ï¼Œå¦åˆ™kubeletæ‹‰å–ä¸äº†é•œåƒå¯¼è‡´å¯åŠ¨å¤±è´¥<br>vi /usr/lib/systemd/system/cri-docker.service<br> <br>ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9<br> <br>#å¯åŠ¨cri-dockerd<br>systemctl daemon-reload <br>systemctl enable cri-docker &amp;&amp; systemctl start cri-docker<br></code></pre></td></tr></table></figure><h3 id="å››ã€kubeadmå®‰è£…é›†ç¾¤-1"><a href="#å››ã€kubeadmå®‰è£…é›†ç¾¤-1" class="headerlink" title="å››ã€kubeadmå®‰è£…é›†ç¾¤"></a>å››ã€kubeadmå®‰è£…é›†ç¾¤</h3><h5 id="3ã€åˆå§‹åŒ–é›†ç¾¤"><a href="#3ã€åˆå§‹åŒ–é›†ç¾¤" class="headerlink" title="3ã€åˆå§‹åŒ–é›†ç¾¤"></a>3ã€åˆå§‹åŒ–é›†ç¾¤</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain"># åœ¨åˆå§‹åŒ–é›†ç¾¤ä¹‹å‰å¯ä»¥å…ˆä¸‹è½½é•œåƒ<br>kubeadm config images list --cri-socket /var/run/cri-dockerd.sock --image-repository registry.aliyuncs.com/google_containers<br>kubeadm config images pull --cri-socket /var/run/cri-dockerd.sock --image-repository registry.aliyuncs.com/google_containers<br><br># åˆå§‹åŒ–é›†ç¾¤<br>kubeadm init --apiserver-advertise-address=172.16.1.70 --control-plane-endpoint=master --service-cidr=10.96.0.0/16 --pod-network-cidr=10.244.0.0/16 --image-repository registry.aliyuncs.com/google_containers --cri-socket /var/run/cri-dockerd.sock<br><br># nodeèŠ‚ç‚¹åŠ å…¥é›†ç¾¤<br>kubeadm join 172.16.66.10:6443 --token abcdef.0123456789abcdef         --discovery-token-ca-cert-hash sha256:8d75ed3dbaf5fb262005b01c44ca33d8ba0b49d0a1a7c6225a8244918bf36d79 --cri-socket /var/run/cri-dockerd.sock<br></code></pre></td></tr></table></figure><h5 id="4ã€è§£å†³æŠ¥é”™å†…å®¹"><a href="#4ã€è§£å†³æŠ¥é”™å†…å®¹" class="headerlink" title="4ã€è§£å†³æŠ¥é”™å†…å®¹"></a>4ã€è§£å†³æŠ¥é”™å†…å®¹</h5><p>1ã€crictlå‘½ä»¤æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">cat &gt; /etc/crictl.yaml &lt;&lt;EOF<br>runtime-endpoint: unix:///var/run/cri-dockerd.sock<br>image-endpoint: unix:///var/run/cri-dockerd.sock<br>timeout: 2<br>debug: false<br>pull-image-on-create: false<br>EOF<br></code></pre></td></tr></table></figure><p>2ã€é•œåƒåŠ é€Ÿå™¨</p><p><a href="https://pbes7383.mirror.aliyuncs.com/">åŠ é€Ÿå™¨ï¼šhttps://pbes7383.mirror.aliyuncs.com</a></p><p>3ã€å¯ç”¨çš„é•œåƒåŠ é€Ÿç½‘ç«™ï¼Œç›®å‰é˜¿é‡Œäº‘çš„åŠ é€Ÿç½‘ç«™åªæœ‰é˜¿é‡Œäº‘çš„æœºå™¨å¯ä»¥ä½¿ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain">&quot;https://docker.1ms.run&quot;,<br>    &quot;https://docker.mybacc.com&quot;,<br>    &quot;https://dytt.online&quot;,<br>    &quot;https://lispy.org&quot;,<br>    &quot;https://docker.xiaogenban1993.com&quot;,<br>    &quot;https://docker.yomansunter.com&quot;,<br>    &quot;https://aicarbon.xyz&quot;,<br>    &quot;https://666860.xyz&quot;,<br>    &quot;https://docker.zhai.cm&quot;,<br>    &quot;https://a.ussh.net&quot;,<br>    &quot;https://hub.littlediary.cn&quot;,<br>    &quot;https://hub.rat.dev&quot;,<br>    &quot;https://docker.m.daocloud.io&quot;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sä¹‹å­˜å‚¨</title>
    <link href="/2025/10/11/K8s%E4%B9%8B%E5%AD%98%E5%82%A8/"/>
    <url>/2025/10/11/K8s%E4%B9%8B%E5%AD%98%E5%82%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="K8sä¹‹å­˜å‚¨"><a href="#K8sä¹‹å­˜å‚¨" class="headerlink" title="K8sä¹‹å­˜å‚¨"></a>K8sä¹‹å­˜å‚¨</h1><h2 id="1ã€Volume"><a href="#1ã€Volume" class="headerlink" title="1ã€Volume"></a>1ã€Volume</h2><h3 id="1ã€æ¦‚å¿µ"><a href="#1ã€æ¦‚å¿µ" class="headerlink" title="1ã€æ¦‚å¿µ"></a>1ã€æ¦‚å¿µ</h3><p>Kubernetes Volumeï¼ˆæ•°æ®å·ï¼‰ä¸»è¦è§£å†³äº†å¦‚ä¸‹ä¸¤æ–¹é¢é—®é¢˜ï¼š</p><p>ï¼ˆ1ï¼‰æ•°æ®æŒä¹…æ€§ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œå®¹å™¨è¿è¡Œèµ·æ¥ä¹‹åï¼Œå†™å…¥åˆ°å…¶æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æš‚æ—¶æ€§çš„ã€‚å½“å®¹å™¨å´©æºƒåï¼ŒKubeletå°†ä¼šé‡å¯è¯¥å®¹å™¨ï¼Œæ­¤æ—¶åŸå®¹å™¨è¿è¡Œåå†™å…¥çš„æ–‡ä»¶å°†ä¸¢å¤±ï¼Œå› ä¸ºå®¹å™¨å°†é‡æ–°ä»é•œåƒåˆ›å»ºã€‚</p><p>ï¼ˆ2ï¼‰æ•°æ®å…±äº«ï¼šåŒä¸€ä¸ªPodï¼ˆå®¹å™¨ç»„ï¼‰ä¸­è¿è¡Œçš„å®¹å™¨ä¹‹é—´ï¼Œç»å¸¸ä¼šå­˜åœ¨å…±äº«æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹çš„éœ€æ±‚ã€‚</p><p>Dockeré‡ŒåŒæ ·ä¹Ÿå­˜åœ¨ä¸€ä¸ªVolumeï¼ˆæ•°æ®å·ï¼‰çš„æ¦‚å¿µï¼Œä½†æ˜¯Dockerå¯¹æ•°æ®å·çš„ç®¡ç†ç›¸å¯¹Kubernetesè€Œè¨€è¦æ›´å°‘ä¸€äº›ã€‚åœ¨Dockeré‡Œï¼Œä¸€ä¸ªVolumeä»…ä»…æ˜¯å®¿ä¸»æœºï¼ˆæˆ–å¦ä¸€ä¸ªå®¹å™¨ï¼‰æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚Dockerå¹¶ä¸ç®¡ç†Volumeçš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>åœ¨Kubernetesé‡Œï¼ŒVolumeå­˜åœ¨æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸï¼ˆä¸åŒ…å«è¯¥æ•°æ®å·çš„å®¹å™¨ç»„ç›¸åŒï¼‰ã€‚å› æ­¤Volumeçš„ç”Ÿå‘½å‘¨æœŸæ¯”åŒä¸€å®¹å™¨ç»„ä¸­ä»»æ„å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸè¦æ›´é•¿ï¼Œä¸ç®¡å®¹å™¨é‡å¯äº†å¤šå°‘æ¬¡ï¼Œæ•°æ®éƒ½èƒ½è¢«ä¿ç•™ä¸‹æ¥ã€‚å½“ç„¶ï¼Œå¦‚æœå®¹å™¨ç»„é€€å‡ºäº†ï¼Œæ•°æ®å·ä¹Ÿå°±è‡ªç„¶é€€å‡ºäº†ã€‚æ­¤æ—¶ï¼Œæ ¹æ®å®¹å™¨ç»„æ‰€ä½¿ç”¨çš„Volumeç±»å‹ä¸åŒï¼Œæ•°æ®å¯èƒ½éšæ•°æ®å·çš„é€€å‡ºè€Œåˆ é™¤ï¼Œä¹Ÿå¯èƒ½è¢«çœŸæ­£æŒä¹…åŒ–ï¼Œå¹¶åœ¨ä¸‹æ¬¡å®¹å™¨ç»„é‡å¯æ—¶ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p><p>ä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼Œä¸€ä¸ªVolumeä»…ä»…æ˜¯ä¸€ä¸ªå¯è¢«å®¹å™¨ç»„ä¸­çš„å®¹å™¨è®¿é—®çš„æ–‡ä»¶ç›®å½•ï¼ˆä¹Ÿè®¸å…¶ä¸­åŒ…å«ä¸€äº›æ•°æ®æ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªç›®å½•æ˜¯æ€ä¹ˆæ¥çš„ï¼Œå–å†³äºè¯¥æ•°æ®å·çš„ç±»å‹ï¼ˆä¸åŒç±»å‹çš„æ•°æ®å·ä½¿ç”¨ä¸åŒçš„å­˜å‚¨ä»‹è´¨ï¼‰ã€‚</p><p>æˆ‘ä»¬ç°åœ¨é€šè¿‡å›¾1-1æ¥ç†è§£å®¹å™¨ç»„ã€å®¹å™¨ã€æŒ‚è½½ç‚¹ã€æ•°æ®å·ã€å­˜å‚¨ä»‹è´¨ï¼ˆNFSã€PVCã€ConfigMapï¼‰ç­‰å‡ ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»ï¼š</p><p>â— ä¸€ä¸ªå®¹å™¨ç»„å¯ä»¥åŒ…å«å¤šä¸ªæ•°æ®å·ã€å¤šä¸ªå®¹å™¨ã€‚</p><p>â— ä¸€ä¸ªå®¹å™¨é€šè¿‡æŒ‚è½½ç‚¹å†³å®šæŸä¸€ä¸ªæ•°æ®å·è¢«æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ä»€ä¹ˆè·¯å¾„ã€‚</p><p>â— ä¸åŒç±»å‹çš„æ•°æ®å·å¯¹åº”ä¸åŒçš„å­˜å‚¨ä»‹è´¨ã€‚</p><h3 id="2ã€ç±»å‹"><a href="#2ã€ç±»å‹" class="headerlink" title="2ã€ç±»å‹"></a>2ã€ç±»å‹</h3><p>Kubernetesç›®å‰æ”¯æŒå¤šè¾¾28ç§æ•°æ®å·ç±»å‹ï¼ˆå…¶ä¸­å¤§éƒ¨åˆ†ç‰¹å®šäºå…·ä½“çš„äº‘ç¯å¢ƒå¦‚GCE&#x2F;AWS&#x2F;Azureç­‰ï¼‰ã€‚è‡ªå»ºKubernetesæ—¶ï¼Œç»å¸¸ä½¿ç”¨çš„æ•°æ®å·çš„ç±»å‹æè¿°æœ‰ä»¥ä¸‹å‡ ç§ã€‚</p><h5 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>emptyDirç±»å‹çš„æ•°æ®å·æ˜¯åœ¨Podè¢«åˆ›å»ºæ—¶åˆ†é…ç»™è¯¥Podçš„ï¼Œå¹¶ä¸”ç›´åˆ°Podè¢«ç§»é™¤ï¼Œè¯¥æ•°æ®å·æ‰ä¼šè¢«é‡Šæ”¾ã€‚æ­£å¦‚ä»–çš„åå­—æ‰€è¿°ï¼Œè¯¥æ•°æ®å·åˆå§‹åˆ†é…æ—¶ï¼Œå§‹ç»ˆæ˜¯ä¸€ä¸ªç©ºç›®å½•ã€‚åŒä¸€Podä¸­çš„ä¸åŒå®¹å™¨éƒ½å¯ä»¥å¯¹è¯¥ç›®å½•æ‰§è¡Œè¯»å†™æ“ä½œï¼Œå¹¶ä¸”å…±äº«å…¶ä¸­çš„æ•°æ®ï¼Œï¼ˆå°½ç®¡ä¸åŒçš„å®¹å™¨å¯èƒ½å°†è¯¥æ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„ä¸åŒè·¯å¾„ï¼‰ã€‚å½“Podè¢«åˆ é™¤æ—¶ï¼ŒemptyDiræ•°æ®å·ä¸­çš„æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚</p><p>å®¹å™¨å´©æºƒæ—¶ï¼ŒKubeletå¹¶ä¸ä¼šåˆ é™¤å®¹å™¨ç»„ï¼Œè€Œä»…ä»…æ˜¯å°†å®¹å™¨é‡å¯ï¼Œå› æ­¤emptyDirä¸­çš„æ•°æ®åœ¨å®¹å™¨å´©æºƒå¹¶é‡å¯åï¼Œä»ç„¶æ˜¯å­˜åœ¨çš„ã€‚</p><p>ä»–çš„å¸¸è§ç”¨æœ‰ï¼š</p><ul><li>æš‚å­˜ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºåŸºäºç£ç›˜çš„åˆå¹¶æ’åºï¼Œç”¨ä½œé•¿æ—¶é—´è®¡ç®—å¥”æºƒæ¢å¤æ—¶çš„æ£€æŸ¥ç‚¹</li><li>WebæœåŠ¡å™¨å®¹å™¨æä¾›æ•°æ®æ—¶ï¼Œä¿å­˜å†…å®¹ç®¡ç†å™¨å®¹å™¨æå–çš„æ–‡ä»¶</li></ul><p>åœ¨kubeletçš„å·¥ä½œç›®å½•(root-dir å‚æ•°æ§åˆ¶)ï¼Œé»˜è®¤ä¸º &#x2F;var&#x2F;lib&#x2F;kubeletï¼Œä¼šä¸ºæ¯ä¸€ä¸ªä½¿ç”¨äº†emptyDirçš„Podåˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œæ ¼å¼å¦‚ <code>/var/lib/kubelet/pods/{podid}/volumes/kubernetes.io~empty-dir</code>ï¼Œæ‰€æœ‰æ”¾åœ¨emptyDir çš„æ•°æ®ï¼Œæœ€ç»ˆéƒ½æ˜¯è½åœ¨äº†<code>nodeçš„ä¸Šè¿°è·¯å¾„</code>ä¸­</p><h5 id="HostPath"><a href="#HostPath" class="headerlink" title="HostPath"></a>HostPath</h5><p>HostPathç±»å‹çš„æ•°æ®å·å°†Podæ‰€åœ¨èŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿä¸ŠæŸä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æŒ‚è½½è¿›å®¹å™¨ç»„ï¼ˆå®¹å™¨ï¼‰ã€‚é™¤äº†ä¸ºHostPathæŒ‡å®šPathå­—æ®µä»¥å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥ä¸ºå…¶æŒ‡å®šTypeå­—æ®µï¼š</p><table><thead><tr><th><strong>Typeå­—æ®µå–å€¼</strong></th><th><strong>æè¿°</strong></th></tr></thead><tbody><tr><td></td><td>ç©ºå­—ç¬¦ä¸²ï¼ˆdefaultï¼‰ç”¨äºå‘åå…¼å®¹ï¼Œæ­¤æ—¶ï¼ŒKubernetesåœ¨æŒ‚è½½HostPathæ•°æ®å·å‰ä¸ä¼šæ‰§è¡Œä»»ä½•æ£€æŸ¥</td></tr><tr><td>DirectoryOrCreate</td><td>å¦‚æœæŒ‡å®šçš„ HostPath è·¯å¾„ä¸å­˜åœ¨ï¼ŒKubernetes å°†åœ¨èŠ‚ç‚¹çš„è¯¥è·¯å¾„ä¸Šåˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼Œæƒé™è®¾ç½®ä¸º0755ï¼Œä¸Kubeletè¿›ç¨‹å…·å¤‡ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒ</td></tr><tr><td>Directory</td><td>æŒ‡å®šHostPathè·¯å¾„å¿…é¡»å­˜åœ¨ï¼Œä¸”æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹</td></tr><tr><td>FileOrCreate</td><td>å¦‚æœæŒ‡å®šçš„HostPath è·¯å¾„ä¸å­˜åœ¨ï¼ŒKuberneteså°†åœ¨èŠ‚ç‚¹çš„è¯¥è·¯å¾„ä¸Šåˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡ä»¶ï¼Œæƒé™è®¾ç½®ä¸º0644ï¼Œä¸Kubeletè¿›ç¨‹å…·å¤‡ç›¸åŒçš„ç»„å’Œæ‰€æœ‰æƒ</td></tr><tr><td>File</td><td>æŒ‡å®šHostPathè·¯å¾„å¿…é¡»å­˜åœ¨å¯¹åº”æ–‡ä»¶</td></tr><tr><td>Socket</td><td>æŒ‡å®šHostPath è·¯å¾„å¿…é¡»å­˜åœ¨ä¸€ä¸ªUnix Socket</td></tr><tr><td>CharDevice</td><td>æŒ‡å®šHostPath è·¯å¾„å¿…é¡»å­˜åœ¨character deviceï¼ˆå­—ç¬¦è®¾å¤‡ï¼‰</td></tr><tr><td>BlockDevice</td><td>æŒ‡å®šHostPath è·¯å¾„å¿…é¡»å­˜åœ¨block deviceï¼ˆå—è®¾å¤‡ï¼‰</td></tr></tbody></table><p>ä½¿ç”¨HostPathæ•°æ®å·æ—¶ï¼Œéœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ol><li>ç”±äºèŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ä¸åŒï¼Œå…·æœ‰ç›¸åŒé…ç½®ï¼ˆå¦‚ä»podTemplateåˆ›å»ºçš„ï¼‰çš„Podsåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„è¡Œä¸ºå¯èƒ½ä¸åŒã€‚</li><li>å½“KubernetesæŒ‰ç…§è®¡åˆ’æ·»åŠ èµ„æºæ„ŸçŸ¥è°ƒåº¦æ—¶ï¼Œå®ƒå°†ä¸ä¼šä½¿ç”¨HostPathå£°æ˜çš„èµ„æºã€‚</li><li>éœ€è¦åœ¨ä¸€ä¸ªæœ‰ç‰¹æƒçš„å®¹å™¨ä¸­ä»¥Rootèº«ä»½è¿è¡Œè¿›ç¨‹ï¼Œæˆ–è€…ä¿®æ”¹ä¸»æœºä¸Šçš„æ–‡ä»¶æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿå†™å…¥HostPathå·ã€‚</li></ol><h5 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h5><p>NFSä½¿æˆ‘ä»¬å¯ä»¥æŒ‚è½½å·²ç»å­˜åœ¨çš„å…±äº«åˆ°çš„æˆ‘ä»¬çš„Podä¸­ï¼Œå’ŒemptyDirä¸åŒçš„æ˜¯ï¼Œå½“æˆ‘ä»¬çš„Podè¢«åˆ é™¤çš„æ—¶å€™emptyDirä¼šè¢«åˆ é™¤ï¼Œä½†æ˜¯NFSä¸ä¼šè¢«åˆ é™¤ï¼Œä»…ä»…æ˜¯è§£é™¤æŒ‚åœ¨çŠ¶æ€è€Œå·²ï¼Œè¿™å°±æ„å‘³ç€NFSèƒ½å¤Ÿå…è®¸æˆ‘ä»¬æå‰å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè€Œä¸”è¿™äº›æ•°æ®å¯ä»¥åœ¨Podä¹‹é—´ç›¸äº’ä¼ é€’ã€‚å¹¶ä¸”ï¼ŒNFSå¯ä»¥åŒæ—¶è¢«å¤šä¸ªPodæŒ‚åœ¨å¹¶è¿›è¡Œè¯»å†™ã€‚</p><p>â‘  å¯ä»¥åœ¨åŠ è½½NFSæ•°æ®å·å‰å°±åœ¨å…¶ä¸­å‡†å¤‡å¥½æ•°æ®ã€‚</p><p>â‘¡ å¯ä»¥åœ¨ä¸åŒå®¹å™¨ç»„ä¹‹é—´å…±äº«æ•°æ®ã€‚</p><p>â‘¢ å¯ä»¥è¢«å¤šä¸ªå®¹å™¨ç»„åŠ è½½å¹¶åŒæ—¶è¯»å†™ã€‚</p><h5 id="CephFS"><a href="#CephFS" class="headerlink" title="CephFS"></a>CephFS</h5><p>CephFSæ•°æ®å·ä½¿å¾—æ‚¨å¯ä»¥æŒ‚è½½ä¸€ä¸ªå¤–éƒ¨CephFSå·åˆ°ç”¨æˆ·çš„å®¹å™¨ç»„ä¸­ã€‚å¯¹äº Kubernetesè€Œè¨€ï¼ŒCephFSä¸NFSçš„ç®¡ç†æ–¹å¼å’Œè¡Œä¸ºå®Œå…¨ç›¸ä¼¼ï¼Œé€‚ç”¨åœºæ™¯ä¹Ÿç›¸åŒã€‚ä¸åŒçš„ä»…ä»…æ˜¯èƒŒåçš„å­˜å‚¨ä»‹è´¨ã€‚é€‚ç”¨åœºæ™¯åŒNFSç±»ä¼¼ã€‚</p><h3 id="3ã€Volumeä½¿ç”¨"><a href="#3ã€Volumeä½¿ç”¨" class="headerlink" title="3ã€Volumeä½¿ç”¨"></a>3ã€Volumeä½¿ç”¨</h3><h5 id="emptyDiræ•°æ®å·æ¼”ç¤º"><a href="#emptyDiræ•°æ®å·æ¼”ç¤º" class="headerlink" title="emptyDiræ•°æ®å·æ¼”ç¤º"></a>emptyDiræ•°æ®å·æ¼”ç¤º</h5><p>emptyDirçš„æ¸…å•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: emptydir-pod<br>spec:<br>  containers:<br>  - name: nginx<br>    image: nginx:v1.22.1<br>    imagePullPolicy: IfNotPresent<br>    volumeMounts:<br>    - mountPath: /cache<br>      name: cache-volume<br>  volumes:<br>  - name: cache-volume<br>    emptyDir:<br>      sizeLimit: 500Mi       # å®¹é‡é™åˆ¶(å¯é€‰)<br>      medium: Memory         # å¯è®¾ä¸ºå†…å­˜<br></code></pre></td></tr></table></figure><h5 id="HostPathå­˜å‚¨å·æ¼”ç¤º"><a href="#HostPathå­˜å‚¨å·æ¼”ç¤º" class="headerlink" title="HostPathå­˜å‚¨å·æ¼”ç¤º"></a>HostPathå­˜å‚¨å·æ¼”ç¤º</h5><p>hostpathçš„æ¸…å•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plain">vi pod-hostpath-vol.yaml<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: pod-vol-hostpath<br>  namespace: default<br>spec:<br>  containers:<br>  - name: nginx<br>    image: nginx<br>    volumeMounts:<br>    - name: html<br>      mountPath: /usr/share/nginx/html<br>  volumes:<br>    - name: html<br>      hostPath:<br>        path: /data/pod/volume1<br>        type: DirectoryOrCreate<br></code></pre></td></tr></table></figure><p>HostPathå¯ä»¥å®ç°æŒä¹…å­˜å‚¨ï¼Œä½†æ˜¯åœ¨NodeèŠ‚ç‚¹æ•…éšœæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ã€‚</p><h5 id="NFSå…±äº«å­˜å‚¨å·æ¼”ç¤º"><a href="#NFSå…±äº«å­˜å‚¨å·æ¼”ç¤º" class="headerlink" title="NFSå…±äº«å­˜å‚¨å·æ¼”ç¤º"></a>NFSå…±äº«å­˜å‚¨å·æ¼”ç¤º</h5><p>å®‰è£…NFSï¼Œå¹¶é…ç½®NFSæœåŠ¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plain"># æ‰€æœ‰èŠ‚ç‚¹å®‰è£…nfs<br>yum install -y nfs-utils<br># ä¸»èŠ‚ç‚¹<br>echo &quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot; &gt; /etc/exports<br>mkdir -p /nfs/data<br>systemctl enable rpcbind --now<br>systemctl enable nfs-server --now<br>exportfs -r<br># åœ¨ä»èŠ‚ç‚¹æŸ¥çœ‹æŒ‚è½½<br>showmount -e master_ip<br># æŒ‚è½½<br>mount -t nfs nfs_ip:/nfs/data æŒ‚è½½ç›®å½•<br></code></pre></td></tr></table></figure><p>åˆ›å»ºNFSå­˜å‚¨å·çš„ä½¿ç”¨æ¸…å•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plain">vi pod-nfs-vol.yaml<br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: pod-vol-nfs<br>  namespace: default<br>spec:<br>  containers:<br>  - name: nginx<br>    image: nginx:v1.22.1<br>    volumeMounts:<br>    - name: html<br>      mountPath: /usr/share/nginx/html<br>  volumes:<br>    - name: html<br>      nfs:<br>        path: /data/volumes<br>        server: nfs_ip<br></code></pre></td></tr></table></figure><h2 id="2ã€PV-PVC"><a href="#2ã€PV-PVC" class="headerlink" title="2ã€PV&#x2F;PVC"></a>2ã€PV&#x2F;PVC</h2><h3 id="1ã€æ¦‚å¿µ-1"><a href="#1ã€æ¦‚å¿µ-1" class="headerlink" title="1ã€æ¦‚å¿µ"></a>1ã€æ¦‚å¿µ</h3><p>ä¸ç®¡ç†è®¡ç®—èµ„æºç›¸æ¯”ï¼Œç®¡ç†å­˜å‚¨èµ„æºæ˜¯ä¸€ä¸ªå®Œå…¨ä¸åŒçš„é—®é¢˜ã€‚ä¸ºäº†æ›´å¥½çš„ç®¡ç†å­˜å‚¨ï¼ŒKuberneteså¼•å…¥äº†Persistent Volumeï¼ˆPVï¼‰å’ŒPersistent Volume Claimï¼ˆPVCï¼‰ ä¸¤ä¸ªæ¦‚å¿µï¼Œå°†å­˜å‚¨ç®¡ç†æŠ½è±¡æˆå¦‚ä½•æä¾›å­˜å‚¨ä»¥åŠå¦‚ä½•ä½¿ç”¨å­˜å‚¨ä¸¤ä¸ªå…³æ³¨ç‚¹ã€‚</p><p>Persistent Volumeï¼ˆPVå­˜å‚¨å·ï¼‰æ˜¯é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç”±é›†ç¾¤ç®¡ç†å‘˜ç®¡ç†ã€æˆ–è€…ç”±Storage Classï¼ˆå­˜å‚¨ç±»ï¼‰è‡ªåŠ¨ç®¡ç†ã€‚PVï¼ˆå­˜å‚¨å·ï¼‰å’ŒNodeï¼ˆèŠ‚ç‚¹ï¼‰ä¸€æ ·ï¼Œæ˜¯é›†ç¾¤ä¸­çš„èµ„æºï¼ˆKubernetesé›†ç¾¤ç”±å­˜å‚¨èµ„æºå’Œè®¡ç®—èµ„æºç»„æˆï¼‰ã€‚Persistent Volume Claimï¼ˆå­˜å‚¨å·å£°æ˜ï¼‰æ˜¯ä¸€ç§ç±»å‹çš„Volumeï¼ˆæ•°æ®å·ï¼‰ï¼ŒPersistent Volume Claimå¼•ç”¨çš„Persistent Volumeæœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºä»»ä½•ä½¿ç”¨å®ƒçš„å®¹å™¨ç»„ã€‚Persistent Volumeæè¿°äº†å¦‚ä½•æä¾›å­˜å‚¨çš„ç»†èŠ‚ä¿¡æ¯ï¼ˆNFSã€CephFSç­‰å­˜å‚¨çš„å…·ä½“å‚æ•°ï¼‰ã€‚</p><p>Persistent Volume Claimä»£è¡¨ç”¨æˆ·ä½¿ç”¨å­˜å‚¨çš„è¯·æ±‚ã€‚Podå®¹å™¨ç»„æ¶ˆè€—Nodeè®¡ç®—èµ„æºï¼ŒPVCå­˜å‚¨å·å£°æ˜æ¶ˆè€—Persistent Volumeå­˜å‚¨èµ„æºã€‚Podå®¹å™¨ç»„å¯ä»¥è¯·æ±‚ç‰¹å®šæ•°é‡çš„è®¡ç®—èµ„æºï¼ˆCPU&#x2F;å†…å­˜ï¼‰ï¼›Persistent Volume Claimå¯ä»¥è¯·æ±‚ç‰¹å®šå¤§å°&#x2F;ç‰¹å®šè®¿é—®æ¨¡å¼ï¼ˆåªèƒ½è¢«å•èŠ‚ç‚¹è¯»å†™&#x2F;å¯è¢«å¤šèŠ‚ç‚¹åªè¯»&#x2F;å¯è¢«å¤šèŠ‚ç‚¹è¯»å†™ï¼‰çš„å­˜å‚¨èµ„æºã€‚</p><h3 id="2ã€PVçš„çŠ¶æ€"><a href="#2ã€PVçš„çŠ¶æ€" class="headerlink" title="2ã€PVçš„çŠ¶æ€"></a>2ã€PVçš„çŠ¶æ€</h3><table><thead><tr><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Availableï¼ˆå¯ç”¨ï¼‰</td><td>ä¸€å—ç©ºé—²èµ„æºè¿˜æ²¡æœ‰è¢«ä»»ä½•å£°æ˜æ‰€ç»‘å®š</td></tr><tr><td>Boundï¼ˆå·²ç»‘å®šï¼‰</td><td>å·å·²ç»è¢«å£°æ˜ç»‘å®š</td></tr><tr><td>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰</td><td>å£°æ˜è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜</td></tr><tr><td>Failedï¼ˆå¤±è´¥ï¼‰</td><td>å·çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</td></tr></tbody></table><h3 id="3ã€ä»€ä¹ˆæ˜¯PV"><a href="#3ã€ä»€ä¹ˆæ˜¯PV" class="headerlink" title="3ã€ä»€ä¹ˆæ˜¯PV"></a>3ã€ä»€ä¹ˆæ˜¯PV</h3><p>pv æœ¬è´¨ä¸Šæ˜¯é›†ç¾¤ä¸­çš„ä¸€å—æŒä¹…åŒ–å­˜å‚¨ç©ºé—´ï¼Œç‹¬ç«‹äº pod ç”Ÿå‘½å‘¨æœŸè€Œå­˜åœ¨ï¼ŒPVæ˜¯åç§°é›†ç¾¤çº§åˆ«çš„èµ„æº</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv-demo</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">ssd</span> <span class="hljs-comment"># è‡ªå®šä¹‰æ ‡ç­¾ä¾¿äºç­›é€‰</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span> <span class="hljs-comment"># ç²¾ç¡®å®¹é‡è®¾ç½®</span><br>  <span class="hljs-attr">volumeMode:</span> <span class="hljs-string">Filesystem</span> <span class="hljs-comment"># æˆ–Blockï¼ˆåŸå§‹å—è®¾å¤‡ï¼‰</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span> <span class="hljs-comment"># è®¿é—®æ¨¡å¼</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span> <span class="hljs-comment"># å›æ”¶ç­–ç•¥</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">gold-ssd</span> <span class="hljs-comment"># å­˜å‚¨ç±»åç§°</span><br>  <span class="hljs-attr">mountOptions:</span> <span class="hljs-comment"># æŒ‚è½½å‚æ•°</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">noatime</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nodelalloc</span><br>  <span class="hljs-attr">nfs:</span> <span class="hljs-comment"># å…·ä½“å­˜å‚¨å®ç°</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/exports/data</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span><br>    <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><h3 id="4ã€PV-çš„è®¿é—®æ¨¡å¼"><a href="#4ã€PV-çš„è®¿é—®æ¨¡å¼" class="headerlink" title="4ã€PV çš„è®¿é—®æ¨¡å¼"></a>4ã€PV çš„è®¿é—®æ¨¡å¼</h3><table><thead><tr><th><strong>æ¨¡å¼</strong></th><th><strong>æŠ€æœ¯ç»†èŠ‚</strong></th><th><strong>é€‚ç”¨åœºæ™¯</strong></th><th><strong>é™åˆ¶</strong></th></tr></thead><tbody><tr><td>ReadWriteOnce (RWO)</td><td>å—è®¾å¤‡çº§é”å®šæœºåˆ¶</td><td>æ•°æ®åº“ä¸»èŠ‚ç‚¹</td><td>æ— æ³•å¤šèŠ‚ç‚¹åŒæ—¶è¯»å†™</td></tr><tr><td>ReadOnlyMany (ROX)</td><td>å®¢æˆ·ç«¯ç¼“å­˜ç­–ç•¥</td><td>å…±äº«åªè¯»é…ç½®</td><td>æ— æ³•ä¿®æ”¹æ•°æ®</td></tr><tr><td>ReadWriteMany (RWX)</td><td>åˆ†å¸ƒå¼é”ç®¡ç†</td><td>ç”¨æˆ·ä¸Šä¼ ç›®å½•</td><td>æ€§èƒ½ä½äºRWO</td></tr><tr><td>ReadWriteOncePod (RWOP)</td><td>Pod UIDç»‘å®š</td><td>å®‰å…¨æ•æ„Ÿåº”ç”¨</td><td>Kubernetes 1.22+</td></tr></tbody></table><h5 id="1ã€ReadWriteOnceï¼ˆRWOï¼‰"><a href="#1ã€ReadWriteOnceï¼ˆRWOï¼‰" class="headerlink" title="1ã€ReadWriteOnceï¼ˆRWOï¼‰"></a>1ã€ReadWriteOnceï¼ˆRWOï¼‰</h5><ul><li><strong>èƒ½åŠ›</strong>ï¼šå•èŠ‚ç‚¹è¯»å†™</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæ•°æ®åº“ã€å•å®ä¾‹åº”ç”¨</li><li><strong>æ”¯æŒå­˜å‚¨</strong>ï¼šEBSã€GCE PDã€æœ¬åœ°å·</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rwo-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteOnce&quot;</span>]<br>  <span class="hljs-attr">capacity:</span> &#123; <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span> &#125;<br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">standard</span><br>  <span class="hljs-attr">hostPath:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/data/rwo</span><br></code></pre></td></tr></table></figure><h5 id="2ã€ReadOnlyManyï¼ˆROXï¼‰"><a href="#2ã€ReadOnlyManyï¼ˆROXï¼‰" class="headerlink" title="2ã€ReadOnlyManyï¼ˆROXï¼‰"></a>2ã€ReadOnlyManyï¼ˆROXï¼‰</h5><ul><li><strong>èƒ½åŠ›</strong>ï¼šå¤šèŠ‚ç‚¹åªè¯»</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé…ç½®æ–‡ä»¶åˆ†å‘ã€åªè¯»æ•°æ®å…±äº«</li><li><strong>æ”¯æŒå­˜å‚¨</strong>ï¼šNFSã€CephFS</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rox-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadOnlyMany&quot;</span>]<br>  <span class="hljs-attr">capacity:</span> &#123; <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span> &#125;<br>  <span class="hljs-attr">nfs:</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">nfs-server.example.com</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;/exports/rox&quot;</span><br></code></pre></td></tr></table></figure><h5 id="3ã€ReadWriteManyï¼ˆRWXï¼‰"><a href="#3ã€ReadWriteManyï¼ˆRWXï¼‰" class="headerlink" title="3ã€ReadWriteManyï¼ˆRWXï¼‰"></a>3ã€ReadWriteManyï¼ˆRWXï¼‰</h5><ul><li><strong>èƒ½åŠ›</strong>ï¼šå¤šèŠ‚ç‚¹è¯»å†™</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå…±äº«æ–‡ä»¶ç³»ç»Ÿã€ååŒç¼–è¾‘</li><li><strong>æ”¯æŒå­˜å‚¨</strong>ï¼šNFSã€CephFSã€GlusterFS</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rwx-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteMany&quot;</span>]<br>  <span class="hljs-attr">capacity:</span> &#123; <span class="hljs-attr">storage:</span> <span class="hljs-string">20Gi</span> &#125;<br>  <span class="hljs-attr">cephfs:</span><br>    <span class="hljs-attr">monitors:</span> [<span class="hljs-string">&quot;10.0.0.1:6789&quot;</span>]<br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;/shared-data&quot;</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">admin</span><br></code></pre></td></tr></table></figure><h5 id="4ã€ReadWriteOncePodï¼ˆRWOPï¼‰"><a href="#4ã€ReadWriteOncePodï¼ˆRWOPï¼‰" class="headerlink" title="4ã€ReadWriteOncePodï¼ˆRWOPï¼‰"></a>4ã€ReadWriteOncePodï¼ˆRWOPï¼‰</h5><ul><li><strong>èƒ½åŠ›</strong>ï¼šå•Podè¯»å†™</li><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæœ‰çŠ¶æ€åº”ç”¨ã€éœ€è¦ç‹¬å è®¿é—®çš„Pod</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rwop-pv</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span> [<span class="hljs-string">&quot;ReadWriteOncePod&quot;</span>]<br>  <span class="hljs-attr">capacity:</span> &#123; <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span> &#125;<br>  <span class="hljs-attr">csi:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">ebs.csi.aws.com</span><br>    <span class="hljs-attr">volumeHandle:</span> <span class="hljs-string">vol-0abcdef123456</span><br></code></pre></td></tr></table></figure><h3 id="5ã€PV-å›æ”¶ç­–ç•¥æœºåˆ¶"><a href="#5ã€PV-å›æ”¶ç­–ç•¥æœºåˆ¶" class="headerlink" title="5ã€PV å›æ”¶ç­–ç•¥æœºåˆ¶"></a>5ã€PV å›æ”¶ç­–ç•¥æœºåˆ¶</h3><table><thead><tr><th>ç­–ç•¥</th><th>è¡Œä¸º</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>Retainï¼ˆä¿ç•™ï¼‰</td><td>çŠ¶æ€å˜ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œç­‰å¾…ç®¡ç†å‘˜å¤‡ä»½æ•°æ®ï¼Œåœ¨æ­¤æœŸé—´ä¸å¯è¢«é‡æ–°ç»‘å®š</td><td>éœ€è¦æ‰‹åŠ¨å›æ”¶ï¼Œé€‚åˆäºç”Ÿäº§æ•°æ®</td></tr><tr><td>Deleteï¼ˆè‡ªåŠ¨åˆ é™¤ï¼‰</td><td>è‡ªåŠ¨åˆ é™¤pvåŠå…¶åç«¯æ•°æ®</td><td></td></tr><tr><td>Recycleï¼ˆå›æ”¶ï¼‰</td><td>åˆ é™¤æ•°æ®ç›®å½•æ‰€æœ‰æ–‡ä»¶ï¼ˆrm -rf &#x2F;volume&#x2F;*ï¼‰ï¼Œä»…æ”¯æŒNFSå’ŒhostPath</td><td>Kubernetes 1.15+ å·²åºŸå¼ƒ</td></tr></tbody></table><h3 id="6ã€PVCçš„ä½¿ç”¨"><a href="#6ã€PVCçš„ä½¿ç”¨" class="headerlink" title="6ã€PVCçš„ä½¿ç”¨"></a>6ã€PVCçš„ä½¿ç”¨</h3><p>PVæ˜¯å‘½åç©ºé—´çº§åˆ«çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># pvc-example.yaml</span><br>apiVersion: v1<br>kind: PersistentVolumeClaim<br>metadata:<br>  name: pvc-demo<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  resources:<br>    requests:<br>      storage: 5Gi               <span class="hljs-comment"># ç”³è¯· 5Gi å­˜å‚¨</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sä¹‹ConfigMap</title>
    <link href="/2025/10/10/K8s%E4%B9%8BConfigMap/"/>
    <url>/2025/10/10/K8s%E4%B9%8BConfigMap/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯-ConfigMap"><a href="#ä»€ä¹ˆæ˜¯-ConfigMap" class="headerlink" title="ä»€ä¹ˆæ˜¯ ConfigMap"></a>ä»€ä¹ˆæ˜¯ ConfigMap</h2><p>Configmap æ˜¯ k8s ä¸­ç”¨æ¥å­˜å‚¨éæœºå¯†æ€§æ•°æ®çš„ API å¯¹è±¡ã€‚å®ƒæä¾›äº†ä¸€ç§ç¯å¢ƒé…ç½®ä¿¡æ¯ï¼ˆå¦‚é…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡ç­‰ï¼‰ä¸å®¹å™¨é•œåƒåˆ†ç¦»çš„æ–¹æ³•ï¼Œä½¿åº”ç”¨ç¨‹åºçš„é…ç½®å¯ä»¥ç‹¬ç«‹äºå®¹å™¨é•œåƒè¿›è¡Œç®¡ç†å’Œä¿®æ”¹ã€‚</p><p>kubelet å®šæœŸåŒæ­¥å˜æ›´ï¼ˆé»˜è®¤1åˆ†é’Ÿï¼‰ï¼Œé€šè¿‡è½¯è¿æ¥å®ç°çƒ­æ›´æ–°ï¼Œè€Œä¸æ˜¯å…±äº«æ–‡ä»¶å¤¹</p><h2 id="configmap-ä½¿ç”¨"><a href="#configmap-ä½¿ç”¨" class="headerlink" title="configmap ä½¿ç”¨"></a>configmap ä½¿ç”¨</h2><h3 id="åˆ›å»ºæ–¹å¼"><a href="#åˆ›å»ºæ–¹å¼" class="headerlink" title="åˆ›å»ºæ–¹å¼"></a>åˆ›å»ºæ–¹å¼</h3><h5 id="åŸºäºå‘½ä»¤è¡Œ"><a href="#åŸºäºå‘½ä»¤è¡Œ" class="headerlink" title="åŸºäºå‘½ä»¤è¡Œ"></a>åŸºäºå‘½ä»¤è¡Œ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä»æ–‡ä»¶åˆ›å»º</span><br>kubectl create configmap app-config --from-file=nginx.conf<br><br><span class="hljs-comment"># ä»ç›®å½•åˆ›å»º</span><br>kubectl create configmap app-config --from-file=conf.d/<br><br><span class="hljs-comment"># ä»å­—é¢é‡åˆ›å»º</span><br>kubectl create configmap game-env --from-literal=LEVEL=5 --from-literal=LIVE=3<br><br><span class="hljs-comment"># ä»ç¯å¢ƒå˜é‡åˆ›å»º</span><br>kubectl create configmap db-env --from-env-file=db.properties<br></code></pre></td></tr></table></figure><h5 id="åŸºäº-YAML"><a href="#åŸºäº-YAML" class="headerlink" title="åŸºäº YAML"></a>åŸºäº YAML</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-comment"># é”®å€¼å¯¹é…ç½®</span><br>  <span class="hljs-attr">log_level:</span> <span class="hljs-string">&quot;INFO&quot;</span><br>  <br>  <span class="hljs-comment"># æ–‡ä»¶å†…å®¹é…ç½®</span><br>  <span class="hljs-attr">nginx.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    server &#123;</span><br><span class="hljs-string">      listen 80;</span><br><span class="hljs-string">      server_name localhost;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span>  <br>  <span class="hljs-comment"># JSONé…ç½®</span><br>  <span class="hljs-attr">settings.json:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    &#123;</span><br><span class="hljs-string">      &quot;debug&quot;: false,</span><br><span class="hljs-string">      &quot;timeout&quot;: 30</span><br><span class="hljs-string">    &#125;</span><br></code></pre></td></tr></table></figure><h3 id="åœ¨-Pod-ä¸­ä½¿ç”¨-ConfigMap"><a href="#åœ¨-Pod-ä¸­ä½¿ç”¨-ConfigMap" class="headerlink" title="åœ¨ Pod ä¸­ä½¿ç”¨ ConfigMap"></a>åœ¨ Pod ä¸­ä½¿ç”¨ ConfigMap</h3><h5 id="ç¯å¢ƒå˜é‡æ³¨å…¥"><a href="#ç¯å¢ƒå˜é‡æ³¨å…¥" class="headerlink" title="ç¯å¢ƒå˜é‡æ³¨å…¥"></a>ç¯å¢ƒå˜é‡æ³¨å…¥</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">web-app</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LOG_LEVEL</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">configMapKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span><span class="hljs-comment"># ä»app-configè¿™ä¸ªconfigmapä¸­å¯»æ‰¾ä¸€ä¸ªkeyä¸ºlog_level</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">log_level</span><br>      <span class="hljs-attr">envFrom:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">configMapRef:</span><span class="hljs-comment"># ç›´æ¥ä½¿ç”¨configmap</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">env-config</span><br></code></pre></td></tr></table></figure><h5 id="ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°"><a href="#ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°"></a>ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cli-app</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>      <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo $LEVEL &amp;&amp; echo $LIVES&quot;</span>]<br>      <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LEVEL</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">configMapKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">game-env</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">LEVEL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LIVES</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">configMapKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">game-env</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">LIVES</span><br></code></pre></td></tr></table></figure><h5 id="ä½œä¸ºå·æŒ‚è½½"><a href="#ä½œä¸ºå·æŒ‚è½½" class="headerlink" title="ä½œä¸ºå·æŒ‚è½½"></a>ä½œä¸ºå·æŒ‚è½½</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/nginx</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>      <span class="hljs-attr">configMap:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span><br></code></pre></td></tr></table></figure><h5 id="ä½œä¸ºç‰¹å®šé”®å€¼"><a href="#ä½œä¸ºç‰¹å®šé”®å€¼" class="headerlink" title="ä½œä¸ºç‰¹å®šé”®å€¼"></a>ä½œä¸ºç‰¹å®šé”®å€¼</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>    <span class="hljs-attr">configMap:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span><br>      <span class="hljs-attr">items:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;nginx.conf&quot;</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;nginx.conf&quot;</span> <span class="hljs-comment"># è‡ªå®šä¹‰æŒ‚è½½è·¯å¾„åç§°</span><br></code></pre></td></tr></table></figure><h5 id="ä¸å¯å˜-configmap"><a href="#ä¸å¯å˜-configmap" class="headerlink" title="ä¸å¯å˜ configmap"></a>ä¸å¯å˜ configmap</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">immutable-config</span><br><span class="hljs-attr">immutable:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Kubernetes 1.19+</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">app.config:</span> <span class="hljs-string">&quot;...&quot;</span><br></code></pre></td></tr></table></figure><h5 id="å¼€å¯æ»šåŠ¨æ›´æ–°"><a href="#å¼€å¯æ»šåŠ¨æ›´æ–°" class="headerlink" title="å¼€å¯æ»šåŠ¨æ›´æ–°"></a>å¼€å¯æ»šåŠ¨æ›´æ–°</h5><p>æˆ‘ä»¬åœ¨æ›´æ–° configmap ä¹‹åéƒ¨åˆ†åº”ç”¨ä¸æ”¯æŒçƒ­æ›´æ–°ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ Pod çš„è‡ªåŠ¨æ›´æ–°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ˆåˆ é™¤åœ¨é‡å»ºï¼‰ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ annotations çš„æ–¹å¼å¼ºåˆ¶å‡ºå‘æ»šåŠ¨æ›´æ–°</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spec.template.metadata.annotations:</span> <br>  <span class="hljs-attr">version/config:</span> <span class="hljs-string">&quot;123&quot;</span><br></code></pre></td></tr></table></figure><h2 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h2><h3 id="ä»€ä¹ˆæ˜¯-Secret"><a href="#ä»€ä¹ˆæ˜¯-Secret" class="headerlink" title="ä»€ä¹ˆæ˜¯ Secret"></a>ä»€ä¹ˆæ˜¯ Secret</h3><p>Secretæ˜¯Kubernetesç”¨äº<code>å®‰å…¨å­˜å‚¨æ•æ„Ÿæ•°æ®</code>çš„æ ¸å¿ƒèµ„æºå¯¹è±¡ï¼Œé€šè¿‡Base64ç¼–ç å’Œå¯é€‰çš„é™æ€åŠ å¯†å®ç°æ•°æ®ä¿æŠ¤ã€‚</p><p>Kubernetes é€šè¿‡ä»…ä»…å°† secret åˆ†å‘åˆ°éœ€è¦è®¿é—® secret çš„ Pod æ‰€åœ¨çš„æœºå™¨èŠ‚ç‚¹æ¥ä¿è¯å…¶å®‰å…¨æ€§ã€‚</p><p>Secret åªä¼šå­˜å‚¨åœ¨èŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œæ°¸ä¸å†™å…¥ç‰©ç†å­˜å‚¨ï¼Œè¿™æ ·ä»èŠ‚ç‚¹åˆ é™¤ secret æ—¶å°±ä¸éœ€è¦æ“¦é™¤ç£ç›˜æ•°æ®ã€‚</p><p>ä» Kubernetes1.7 ç‰ˆæœ¬å¼€å§‹ï¼Œetcd ä¼šä»¥åŠ å¯†å½¢å¼å­˜å‚¨ secretï¼Œä¸€å®šç¨‹åº¦ä¸Šä¿è¯äº† secret çš„å®‰å…¨ã€‚</p><p>Secretæ•°æ®å·å¯ä»¥ç”¨æ¥æ³¨å…¥æ•æ„Ÿä¿¡æ¯ï¼ˆä¾‹å¦‚å¯†ç ï¼‰åˆ°å®¹å™¨ç»„ã€‚æ‚¨å¯ä»¥å°†æ•æ„Ÿä¿¡æ¯å­˜å…¥Kubernetes Secretå¯¹è±¡ï¼Œå¹¶é€šè¿‡Volumeä»¥æ–‡ä»¶çš„å½¢å¼æŒ‚è½½åˆ°å®¹å™¨ç»„ï¼ˆæˆ–å®¹å™¨ï¼‰ã€‚</p><p>å°†Secretæ•°æ®å·æŒ‚è½½åˆ°å®¹å™¨æ—¶ï¼Œå¦‚æœè¯¥æŒ‚è½½ç‚¹æŒ‡å®šäº†æ•°æ®å·å†…å­è·¯å¾„ï¼ˆsubPathï¼‰ï¼Œåˆ™è¯¥Secretè¢«æ”¹å˜åï¼Œè¯¥å®¹å™¨ä¸ä¼šæ”¶åˆ°çƒ­æ›´æ–°ã€‚</p><p>ä¹Ÿæ”¯æŒä¸å¯å˜ secretï¼Œå’Œ configmap è®¾ç½®æ–¹å¼ä¸€æ ·ã€‚</p><h3 id="secret-ç±»å‹"><a href="#secret-ç±»å‹" class="headerlink" title="secret ç±»å‹"></a>secret ç±»å‹</h3><p>é€šè¿‡å®šä¹‰ä»¥å¥ç‚¹ï¼ˆ<code>.</code>ï¼‰å¼€å¤´çš„ä¸»é”®ï¼Œä½ å¯ä»¥â€œéšè—â€ä½ çš„æ•°æ®ã€‚ è¿™äº›ä¸»é”®ä»£è¡¨çš„æ˜¯ä»¥å¥ç‚¹å¼€å¤´çš„æ–‡ä»¶æˆ–â€œéšè—â€æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼Œå½“ä»¥ä¸‹ Secret è¢«æŒ‚è½½åˆ° <code>secret-volume</code> å·ä¸Šæ—¶ï¼Œè¯¥å·ä¸­ä¼šåŒ…å«ä¸€ä¸ªåä¸º <code>.secret-file</code> çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å®¹å™¨ <code>dotfile-test-container</code> ä¸­æ­¤æ–‡ä»¶ä½äºè·¯å¾„ <code>/etc/secret-volume/.secret-file</code> å¤„ã€‚è¿™äº›å†…å®¹å¿…é¡»ä»¥<code>ls -al</code>æ‰èƒ½è¢«åˆ—ä¸¾å‡ºæ¥ã€‚</p><table><thead><tr><th>ç±»å‹</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>Opaque</td><td>ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ®</td></tr><tr><td>kubernetes.io&#x2F;service-account-token</td><td>æœåŠ¡è´¦å·ä»¤ç‰Œ</td></tr><tr><td>kubernetes.io&#x2F;dockercfg</td><td>~&#x2F;.dockercfg æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td></tr><tr><td>kubernetes.io&#x2F;dockerconfigjson</td><td>~&#x2F;.dockerconfigjson æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼</td></tr><tr><td>kubernetes.io&#x2F;basic-auth</td><td>ç”¨äºåŸºæœ¬èº«ä»½è®¤è¯çš„å‡­æ®</td></tr><tr><td>kubernetes.io&#x2F;ssh-auth</td><td>ç”¨äº ssh èº«ä»½è®¤è¯çš„å‡­æ®</td></tr><tr><td>kubernetes.io&#x2F;tls</td><td>ç”¨äº TLS å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯çš„æ•°æ®</td></tr><tr><td>bootstrap.kubernetes.io&#x2F;token</td><td>å¯åŠ¨å¼•å¯¼ä»¤ç‰Œæ•°æ®</td></tr></tbody></table><p><img src="https://cdn.nlark.com/yuque/0/2025/png/29302735/1757002313299-dd1d0883-c772-425a-9f48-aa73c6d872ce.png" alt="img"></p><h3 id="Secret-æŒ‚è½½æ–¹å¼"><a href="#Secret-æŒ‚è½½æ–¹å¼" class="headerlink" title="Secret æŒ‚è½½æ–¹å¼"></a>Secret æŒ‚è½½æ–¹å¼</h3><h5 id="env-æ–¹å¼"><a href="#env-æ–¹å¼" class="headerlink" title="env æ–¹å¼"></a>env æ–¹å¼</h5><h5 id="volume-æ–¹å¼"><a href="#volume-æ–¹å¼" class="headerlink" title="volume æ–¹å¼"></a>volume æ–¹å¼</h5><h3 id="Secret-ä½¿ç”¨"><a href="#Secret-ä½¿ç”¨" class="headerlink" title="Secret ä½¿ç”¨"></a>Secret ä½¿ç”¨</h3><h5 id="é€šç”¨ç±»å‹ï¼ˆQpaqueï¼‰"><a href="#é€šç”¨ç±»å‹ï¼ˆQpaqueï¼‰" class="headerlink" title="é€šç”¨ç±»å‹ï¼ˆQpaqueï¼‰"></a>é€šç”¨ç±»å‹ï¼ˆQpaqueï¼‰</h5><p>ä½¿ç”¨åœºæ™¯ï¼šå­˜å‚¨ä»»æ„æ•æ„Ÿæ•°æ®ï¼ˆé»˜è®¤ç±»å‹ï¼‰</p><p>åˆ›å»ºæ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å‘½ä»¤è¡Œåˆ›å»º</span><br>kubectl create secret generic db-credentials \<br>  --from-literal=username=admin \<br>  --from-literal=password=<span class="hljs-string">&#x27;S!B\*d$zDsb=&#x27;</span><br><br><span class="hljs-comment"># ä»æ–‡ä»¶åˆ›å»º</span><br>kubectl create secret generic tls-key --from-file=private.key<br></code></pre></td></tr></table></figure><p>YAML å®šä¹‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">app-secrets</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">api-key:</span> <span class="hljs-string">MWYyZDFlMmU2N2Rm</span>  <span class="hljs-comment"># echo -n &quot;1f2d1e2e67df&quot; | base64</span><br>  <span class="hljs-attr">config.ini:</span> <span class="hljs-string">|</span><br>    <span class="hljs-string">W2RiXQp1c2VybmFtZT0ke0RLX1VTRVJOQU1FfQpwYXNzd29yZD0ke0RLX1BBU1NXT1JEfQ==</span><br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼šæ•°æ®åº“å‡­è¯æ³¨å…¥</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">web-app</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">my-app:v1</span><br>        <span class="hljs-attr">env:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_USER</span><br>            <span class="hljs-attr">valueFrom:</span><br>              <span class="hljs-attr">secretKeyRef:</span><br>                <span class="hljs-attr">name:</span> <span class="hljs-string">db-credentials</span><br>                <span class="hljs-attr">key:</span> <span class="hljs-string">username</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_PASSWORD</span><br>            <span class="hljs-attr">valueFrom:</span><br>              <span class="hljs-attr">secretKeyRef:</span><br>                <span class="hljs-attr">name:</span> <span class="hljs-string">db-credentials</span><br>                <span class="hljs-attr">key:</span> <span class="hljs-string">password</span><br></code></pre></td></tr></table></figure><h5 id="TLS-è¯ä¹¦ç±»å‹ï¼ˆkubernetes-io-tlsï¼‰"><a href="#TLS-è¯ä¹¦ç±»å‹ï¼ˆkubernetes-io-tlsï¼‰" class="headerlink" title="TLS è¯ä¹¦ç±»å‹ï¼ˆkubernetes.io&#x2F;tlsï¼‰"></a>TLS è¯ä¹¦ç±»å‹ï¼ˆkubernetes.io&#x2F;tlsï¼‰</h5><p>ä½¿ç”¨åœºæ™¯ï¼šHTTPS æœåŠ¡æ‰€éœ€è¦çš„è¯ä¹¦å’Œç§é’¥</p><p>åˆ›å»ºæ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret tls nginx-tls \<br>  --cert=fullchain.pem \<br>  --key=privkey.pem<br></code></pre></td></tr></table></figure><p>YAML å®šä¹‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-tls</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/tls</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">tls.crt:</span> <span class="hljs-string">LS0t...LQo=</span>  <span class="hljs-comment"># base64ç¼–ç çš„è¯ä¹¦</span><br>  <span class="hljs-attr">tls.key:</span> <span class="hljs-string">QCVWR...VRA=</span>  <span class="hljs-comment"># base64ç¼–ç çš„ç§é’¥</span><br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼šingress TLS é…ç½®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">review-test</span><br>    <span class="hljs-attr">kubernetes.io/ingress.rule-mix:</span> <span class="hljs-string">&quot;false&quot;</span><br>    <span class="hljs-attr">kubernetes.io/ingress.subnetId:</span> <span class="hljs-string">subnet-06gosjvc</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="hljs-string">500m</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-request-buffering:</span> <span class="hljs-string">&quot;off&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">generation:</span> <span class="hljs-number">4</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">publink-web</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">review-test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">review-test.cnpereading.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">service:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">review-ui-web-test</span><br>            <span class="hljs-attr">port:</span><br>              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">secretName:</span> <span class="hljs-string">ca-secret</span><br></code></pre></td></tr></table></figure><h5 id="Docker-é•œåƒä»“åº“å‡­è¯ï¼ˆkubernetes-io-dockerconfigjsonï¼‰"><a href="#Docker-é•œåƒä»“åº“å‡­è¯ï¼ˆkubernetes-io-dockerconfigjsonï¼‰" class="headerlink" title="Docker é•œåƒä»“åº“å‡­è¯ï¼ˆkubernetes.io&#x2F;dockerconfigjsonï¼‰"></a>Docker é•œåƒä»“åº“å‡­è¯ï¼ˆkubernetes.io&#x2F;dockerconfigjsonï¼‰</h5><p>ä½¿ç”¨åœºæ™¯ï¼šç§æœ‰å®¹å™¨é•œåƒä»“åº“è®¤è¯</p><p>åˆ›å»ºæ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret docker-registry secret-tiger-docker \<br>  --docker-email=tiger@acme.example \<br>  --docker-username=tiger \<br>  --docker-password=pass1234 \<br>  --docker-server=my-registry.example:5000<br></code></pre></td></tr></table></figure><p>YAML å®šä¹‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">secret-dockercfg</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/dockercfg</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-string">.dockerconfigjson:</span> <span class="hljs-string">|</span><br>    <span class="hljs-string">eyJhdXRocyI6eyJodHRwczovL2V4YW1wbGUvdjEvIjp7ImF1dGgiOiJvcGVuc2VzYW1lIn19fQo=</span>    <br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼šç§æœ‰é•œåƒä»“åº“æ‹‰å–</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">private-app</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">imagePullSecrets:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">secret-dockercfg</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">registry.example.com/project/app:v1.2</span><br></code></pre></td></tr></table></figure><h5 id="æœåŠ¡è´¦å·ä»¤ç‰Œï¼ˆkubernetes-io-service-account-tokenï¼‰"><a href="#æœåŠ¡è´¦å·ä»¤ç‰Œï¼ˆkubernetes-io-service-account-tokenï¼‰" class="headerlink" title="æœåŠ¡è´¦å·ä»¤ç‰Œï¼ˆkubernetes.io&#x2F;service-account-tokenï¼‰"></a>æœåŠ¡è´¦å·ä»¤ç‰Œï¼ˆkubernetes.io&#x2F;service-account-tokenï¼‰</h5><p>ä½¿ç”¨åœºæ™¯ï¼šæœåŠ¡è´¦å·çš„è‡ªåŠ¨åŒ–ä»¤ç‰Œç®¡ç†ï¼ˆç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºï¼‰</p><p>å…¸å‹ç»“æ„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">monitoring-token-kb94v</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/service-account.name:</span> <span class="hljs-string">monitoring-sa</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/service-account-token</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">ca.crt:</span> <span class="hljs-string">LS0t...LQo=</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ZGVmYXVsdA==</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">ZXlKaG...Wk09</span><br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼šPrometheus è®¿é—® kubernetes API</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">monitoring-sa</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">monitoring-sa</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">token-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/run/secrets/kubernetes.io/serviceaccount</span><br></code></pre></td></tr></table></figure><h5 id="SSH-è®¤è¯ï¼ˆkubernetes-io-ssh-authï¼‰"><a href="#SSH-è®¤è¯ï¼ˆkubernetes-io-ssh-authï¼‰" class="headerlink" title="SSH è®¤è¯ï¼ˆkubernetes.io&#x2F;ssh-authï¼‰"></a>SSH è®¤è¯ï¼ˆkubernetes.io&#x2F;ssh-authï¼‰</h5><p>ä½¿ç”¨åœºæ™¯ï¼šGit ä»“åº“ SSH å¯†é’¥è®¿é—®</p><p>åˆ›å»ºæ–¹æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret generic git-ssh-key \<br>  --from-file=ssh-privatekey=/path/to/id_rsa \<br>  --<span class="hljs-built_in">type</span>=kubernetes.io/ssh-auth<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ¡ˆä¾‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">git-cloner</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cloner</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">alpine/git</span><br>      <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;git clone git@github.com:user/repo.git&quot;</span>]<br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ssh-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/root/.ssh&quot;</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ssh-volume</span><br>      <span class="hljs-attr">secret:</span><br>        <span class="hljs-attr">secretName:</span> <span class="hljs-string">git-ssh-key</span><br>        <span class="hljs-attr">items:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">ssh-privatekey</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">id_rsa</span><br>            <span class="hljs-attr">mode:</span> <span class="hljs-number">0600</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sä¹‹Service</title>
    <link href="/2025/09/20/K8s%E4%B9%8BService/"/>
    <url>/2025/09/20/K8s%E4%B9%8BService/</url>
    
    <content type="html"><![CDATA[<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h2 id="1ã€ä»€ä¹ˆæ˜¯Service"><a href="#1ã€ä»€ä¹ˆæ˜¯Service" class="headerlink" title="1ã€ä»€ä¹ˆæ˜¯Service"></a>1ã€ä»€ä¹ˆæ˜¯Service</h2><h5 id="ä¸ºä»€ä¹ˆéœ€è¦-Service"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-Service" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ Service"></a>ä¸ºä»€ä¹ˆéœ€è¦ Service</h5><p>Kubernetes ä¸­ Pod æ˜¯éšæ—¶å¯ä»¥æ¶ˆäº¡çš„ï¼ˆèŠ‚ç‚¹æ•…éšœã€å®¹å™¨å†…åº”ç”¨ç¨‹åºé”™è¯¯ç­‰åŸå› ï¼‰ã€‚å¦‚æœä½¿ç”¨ Deployment è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºï¼ŒDeployment å°†ä¼šåœ¨ Pod æ¶ˆäº¡åå†åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod ä»¥ç»´æŒæ‰€éœ€è¦çš„å‰¯æœ¬æ•°ã€‚æ¯ä¸€ä¸ª Pod æœ‰è‡ªå·±çš„ IP åœ°å€ï¼Œç„¶è€Œï¼Œå¯¹äº Deployment è€Œè¨€ï¼Œå¯¹åº” Pod é›†åˆæ˜¯åŠ¨æ€å˜åŒ–çš„ã€‚</p><p>è¿™ä¸ªç°è±¡å¯¼è‡´äº†å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>å¦‚æœæŸäº› Podï¼ˆå‡è®¾æ˜¯ â€˜backendsâ€™ï¼‰ä¸ºå¦å¤–ä¸€äº› Podï¼ˆå‡è®¾æ˜¯ â€˜frontendsâ€™ï¼‰æä¾›æ¥å£ï¼Œåœ¨ â€˜backendsâ€™ ä¸­çš„ Pod é›†åˆä¸æ–­å˜åŒ–ï¼ˆIP åœ°å€ä¹Ÿè·Ÿç€å˜åŒ–ï¼‰çš„æƒ…å†µä¸‹ï¼Œâ€™frontendsâ€™ ä¸­çš„ Pod å¦‚ä½•æ‰èƒ½çŸ¥é“åº”è¯¥å°†è¯·æ±‚å‘é€åˆ°å“ªä¸ª IP åœ°å€ï¼Ÿ</li></ul><p>Service å­˜åœ¨çš„æ„ä¹‰ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h5 id="Service-å¯¹è±¡"><a href="#Service-å¯¹è±¡" class="headerlink" title="Service å¯¹è±¡"></a>Service å¯¹è±¡</h5><p>Kubernetes ä¸­ Service æ˜¯ä¸€ä¸ª API å¯¹è±¡ï¼Œé€šè¿‡ kubectl + YAMLå®šä¹‰ä¸€ä¸ª Serviceï¼Œå¯ä»¥å°†ç¬¦åˆ Service æŒ‡å®šæ¡ä»¶çš„ Pod ä½œä¸ºå¯é€šè¿‡ç½‘ç»œè®¿é—®çš„æœåŠ¡æä¾›ç»™æœåŠ¡è°ƒç”¨è€…ã€‚</p><p>Service æ˜¯ Kubernetes ä¸­çš„ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼š</p><ul><li>Pod æœ‰è‡ªå·±çš„ IP åœ°å€</li><li>Service è¢«èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„ dns name</li><li>Service é€šè¿‡ label selector é€‰å®šä¸€ç»„ Pod</li><li>Service å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¯å°†è¯·æ±‚å‡è¡¡åˆ†å‘åˆ°é€‰å®šè¿™ä¸€ç»„ Pod ä¸­</li></ul><p>Kubernetes é€šè¿‡å¼•å…¥ Service çš„æ¦‚å¿µï¼Œå°†å‰ç«¯ä¸åç«¯è§£è€¦ã€‚</p><h2 id="2ã€ä¸‰ç§ä»£ç†æ¨¡å¼"><a href="#2ã€ä¸‰ç§ä»£ç†æ¨¡å¼" class="headerlink" title="2ã€ä¸‰ç§ä»£ç†æ¨¡å¼"></a>2ã€ä¸‰ç§ä»£ç†æ¨¡å¼</h2><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œæ¯ä¸ªNodeè¿è¡Œä¸€ä¸ªKube-proxyè¿›ç¨‹ã€‚Kube-proxyè´Ÿè´£ä¸ºServiceå®ç°äº†ä¸€ç§VIPï¼ˆè™šæ‹ŸIPï¼‰çš„å½¢å¼ï¼Œè€Œä¸æ˜¯ExternalNameçš„å½¢å¼ã€‚åœ¨Kubernetes v1.0ç‰ˆæœ¬ï¼Œä»£ç†å®Œå…¨åœ¨Userspaceã€‚åœ¨Kubernetes v1.1ç‰ˆæœ¬ï¼Œæ–°å¢äº†Iptablesä»£ç†ï¼Œä½†å¹¶ä¸æ˜¯é»˜è®¤çš„è¿è¡Œæ¨¡å¼ã€‚ä»Kubernetes v1.2èµ·ï¼Œé»˜è®¤å°±æ˜¯Iptablesä»£ç†ã€‚åœ¨Kubernetes v1.8.0-beta.0ä¸­ï¼Œæ·»åŠ äº†Ipvsä»£ç†ã€‚åœ¨Kubernetes v1.0ç‰ˆæœ¬ï¼ŒServiceæ˜¯â€œ4å±‚â€ï¼ˆTCP&#x2F;UDP over IPï¼‰æ¦‚å¿µã€‚åœ¨Kubernetes v1.1ç‰ˆæœ¬ï¼Œæ–°å¢äº†Ingress APIï¼ˆBetaç‰ˆï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºâ€œ7å±‚â€ï¼ˆHTTPï¼‰æœåŠ¡ã€‚</p><p>Kube-proxyè¿™ä¸ªç»„ä»¶å§‹ç»ˆç›‘è§†ç€API Serverä¸­æœ‰å…³Serviceçš„å˜åŠ¨ä¿¡æ¯ï¼Œè·å–ä»»ä½•ä¸€ä¸ªä¸Serviceèµ„æºç›¸å…³çš„å˜åŠ¨çŠ¶æ€ï¼Œé€šè¿‡Watchç›‘è§†ï¼Œä¸€æ—¦æœ‰Serviceèµ„æºç›¸å…³çš„å˜åŠ¨å’Œåˆ›å»ºï¼ŒKube-proxyéƒ½è¦è½¬æ¢ä¸ºå½“å‰èŠ‚ç‚¹ä¸Šçš„èƒ½å¤Ÿå®ç°èµ„æºè°ƒåº¦è§„åˆ™ï¼Œå³Serviceçš„ä»£ç†æ¨¡å¼ã€‚</p><h5 id="Userspaceä»£ç†æ¨¡å¼"><a href="#Userspaceä»£ç†æ¨¡å¼" class="headerlink" title="Userspaceä»£ç†æ¨¡å¼"></a>Userspaceä»£ç†æ¨¡å¼</h5><p>å½“å®¢æˆ·ç«¯Podè¯·æ±‚å†…æ ¸ç©ºé—´çš„Service Iptablesåï¼ŒæŠŠè¯·æ±‚è½¬åˆ°ç»™ç”¨æˆ·ç©ºé—´ç›‘å¬çš„Kube-proxyçš„ç«¯å£ï¼Œç”±Kube-proxyæ¥å¤„ç†åï¼Œå†ç”±Kube-proxyå°†è¯·æ±‚è½¬ç»™å†…æ ¸ç©ºé—´çš„Service IPï¼Œå†ç”±Service Iptalbesæ ¹æ®è¯·æ±‚è½¬ç»™å„èŠ‚ç‚¹ä¸­çš„çš„Service Podã€‚</p><p>ç”±æ­¤å¯è§è¿™ä¸ªæ¨¡å¼æœ‰å¾ˆå¤§çš„é—®é¢˜ï¼Œç”±å®¢æˆ·ç«¯è¯·æ±‚å…ˆè¿›å…¥å†…æ ¸ç©ºé—´çš„ï¼Œåˆè¿›å»ç”¨æˆ·ç©ºé—´è®¿é—®Kube-proxyï¼Œç”±Kube-proxyå°è£…å®Œæˆåå†è¿›å»å†…æ ¸ç©ºé—´çš„Iptablesï¼Œå†æ ¹æ®Iptablesçš„è§„åˆ™åˆ†å‘ç»™å„èŠ‚ç‚¹çš„ç”¨æˆ·ç©ºé—´çš„Podã€‚è¿™æ ·æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å‡ºå†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ã€‚åœ¨Kubernetes 1.1ç‰ˆæœ¬ä¹‹å‰ï¼ŒUserspaceæ˜¯é»˜è®¤çš„ä»£ç†æ¨¡å‹ã€‚</p><h5 id="Iptablesä»£ç†æ¨¡å¼"><a href="#Iptablesä»£ç†æ¨¡å¼" class="headerlink" title="Iptablesä»£ç†æ¨¡å¼"></a>Iptablesä»£ç†æ¨¡å¼</h5><p>å®¢æˆ·ç«¯IPè¯·æ±‚æ—¶ï¼Œç›´æ¥è¯·æ±‚æœ¬åœ°å†…æ ¸Service IPï¼Œæ ¹æ®Iptablesçš„è§„åˆ™ç›´æ¥å°†è¯·æ±‚è½¬å‘åˆ°åˆ°å„Podä¸Šï¼Œå› ä¸ºä½¿ç”¨Iptable NATæ¥å®Œæˆè½¬å‘ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—ã€‚å¦å¤–ï¼Œå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service&#x2F;Endpointï¼Œé‚£ä¹ˆNodeä¸Šçš„Iptables Ruleså°†ä¼šéå¸¸åºå¤§ï¼Œæ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ã€‚Iptablesä»£ç†æ¨¡å¼ç”±Kubernetes 1.1ç‰ˆæœ¬å¼•å…¥ï¼Œè‡ª1.2ç‰ˆæœ¬å¼€å§‹æˆä¸ºé»˜è®¤ç±»å‹ã€‚</p><h5 id="Ipvsä»£ç†æ¨¡å¼"><a href="#Ipvsä»£ç†æ¨¡å¼" class="headerlink" title="Ipvsä»£ç†æ¨¡å¼"></a>Ipvsä»£ç†æ¨¡å¼</h5><p>Kubernetesè‡ª1.9-alphaç‰ˆæœ¬å¼•å…¥äº†Ipvsä»£ç†æ¨¡å¼ï¼Œå¦‚å›¾1-4æ‰€ç¤ºï¼Œè‡ª1.11ç‰ˆæœ¬å¼€å§‹æˆä¸ºé»˜è®¤è®¾ç½®ã€‚å®¢æˆ·ç«¯IPè¯·æ±‚æ—¶åˆ°è¾¾å†…æ ¸ç©ºé—´æ—¶ï¼Œæ ¹æ®Ipvsçš„è§„åˆ™ç›´æ¥åˆ†å‘åˆ°å„Podä¸Šã€‚Kube-proxyä¼šç›‘è§†Kubernetes Serviceå¯¹è±¡å’ŒEndpointsï¼Œè°ƒç”¨Netlinkæ¥å£ä»¥ç›¸åº”åœ°åˆ›å»ºIpvsè§„åˆ™å¹¶å®šæœŸä¸Kubernetes Serviceå¯¹è±¡å’ŒEndpointså¯¹è±¡åŒæ­¥Ipvsè§„åˆ™ï¼Œä»¥ç¡®ä¿IpvsçŠ¶æ€ä¸æœŸæœ›ä¸€è‡´ã€‚è®¿é—®æœåŠ¡æ—¶ï¼Œæµé‡å°†è¢«é‡å®šå‘åˆ°å…¶ä¸­ä¸€ä¸ªåç«¯Podã€‚</p><p>ä¸Iptablesç±»ä¼¼ï¼ŒIpvsåŸºäºNetfilterçš„HookåŠŸèƒ½ï¼Œä½†ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„å¹¶åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚è¿™æ„å‘³ç€Ipvså¯ä»¥æ›´å¿«åœ°é‡å®šå‘æµé‡ï¼Œå¹¶ä¸”åœ¨åŒæ­¥ä»£ç†è§„åˆ™æ—¶å…·æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚æ­¤å¤–Ipvsä¸ºè´Ÿè½½å‡è¡¡ç®—æ³•æä¾›äº†æ›´å¤šé€‰é¡¹ï¼Œä¾‹å¦‚ï¼š</p><ul><li>rrï¼šè½®è¯¢è°ƒåº¦ã€‚</li><li>lcï¼šæœ€å°è¿æ¥æ•°ã€‚</li><li>dhï¼šç›®æ ‡å“ˆå¸Œã€‚</li><li>shï¼šæºå“ˆå¸Œã€‚</li><li>sedï¼šæœ€çŸ­æœŸæœ›å»¶è¿Ÿã€‚</li><li>nqï¼šä¸æ’é˜Ÿè°ƒåº¦ã€‚</li></ul><p>Ipvsæ¨¡å¼å‡å®šåœ¨è¿è¡ŒKube-proxyä¹‹å‰åœ¨èŠ‚ç‚¹ä¸Šéƒ½å·²ç»å®‰è£…äº†IPVSå†…æ ¸æ¨¡å—ã€‚å½“Kube-proxyä»¥Ipvsä»£ç†æ¨¡å¼å¯åŠ¨æ—¶ï¼ŒKube-proxyå°†éªŒè¯èŠ‚ç‚¹ä¸Šæ˜¯å¦å®‰è£…äº†IPVSæ¨¡å—ï¼Œå¦‚æœæœªå®‰è£…ï¼Œåˆ™Kube-proxyå°†å›é€€åˆ°Iptablesä»£ç†æ¨¡å¼ã€‚</p><h2 id="3ã€K8s-æœåŠ¡å‘ç°"><a href="#3ã€K8s-æœåŠ¡å‘ç°" class="headerlink" title="3ã€K8s æœåŠ¡å‘ç°"></a>3ã€K8s æœåŠ¡å‘ç°</h2><p>åœ¨é›†ç¾¤å†…éƒ¨å¯¹ä¸€ä¸ªæœåŠ¡çš„è®¿é—®ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼šç¯å¢ƒå˜é‡ä¸DNSã€‚</p><h5 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h5><p>å½“ä¸€ä¸ªPodè¿è¡Œåœ¨Nodeä¸Šæ—¶ï¼ŒKubeletå°†ä¸ºæ¯ä¸€ä¸ªæ´»åŠ¨çš„Serviceæ·»åŠ ç¯å¢ƒå˜é‡ï¼Œç¯å¢ƒå˜é‡æœ‰ä¸¤ç±»ï¼š</p><ul><li>DockerLinkç¯å¢ƒå˜é‡ï¼šç›¸å½“äºDockerçš„- linkå‚æ•°å®ç°å®¹å™¨è¿æ¥æ—¶è®¾ç½®çš„ç¯å¢ƒå˜é‡ã€‚</li><li>Kubernetes Serviceç¯å¢ƒå˜é‡ï¼šKubernetesä¸ºServiceè®¾ç½®çš„ç¯å¢ƒå˜é‡å½¢å¼ï¼Œ{SVCNAME}*SERVICE_HOST å’Œ{SVCNAME}*SERVICE_PORTå˜é‡ï¼Œç¯å¢ƒå˜é‡çš„åç§°ä¸ºå¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ã€‚</li></ul><p>ä¾‹å¦‚ï¼Œå­˜åœ¨ä¸€ä¸ªåç§°ä¸ºredies-masterçš„Serviceï¼ˆå®ƒçš„Cluster IPåœ°å€ä¸º10.0.0.11ï¼Œç«¯å£å·ä¸º6379ï¼Œåè®®ä¸ºTCPï¼‰ï¼Œå®ƒçš„ç¯å¢ƒå˜é‡å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">REDIS_MASTER_SERVICE_HOST=10.0.0.11<br>REDIS_MASTER_SERVICE_PORT=6379<br>REDIS_MASTER_PORT=tcp://10.0.0.11:6379<br>REDIS_MASTER_PORT_6379_TCP=tcp://10.0.0.11:6379<br>REDIS_MASTER_PORT_6379_TCP_PROTO=tcp<br>REDIS_MASTER_PORT_6379_TCP_PORT=6379<br>REDIS_MASTER_PORT_6379_TCP_ADDR=10.0.0.11<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°ç¯å¢ƒå˜é‡ä¸­è®°å½•äº†redies-masteræœåŠ¡çš„IPåœ°å€å’Œç«¯å£ï¼Œä»¥åŠåè®®ä¿¡æ¯ã€‚å› æ­¤ï¼ŒPodä¸­çš„åº”ç”¨å°±å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¥å‘ç°æ­¤æœåŠ¡ã€‚ä½†æ˜¯ï¼Œç¯å¢ƒå˜é‡æ–¹å¼å­˜åœ¨å¦‚ä¸‹çš„é™åˆ¶ï¼š</p><ul><li>ç¯å¢ƒå˜é‡åªèƒ½åœ¨ç›¸åŒçš„å‘½åç©ºé—´ä¸­ä½¿ç”¨ã€‚</li><li>å¦å¤–Serviceå¿…é¡»åœ¨Podåˆ›å»ºä¹‹å‰è¢«åˆ›å»ºï¼Œå¦åˆ™Serviceå˜é‡ä¸ä¼šè¢«è®¾ç½®åˆ°Podä¸­ã€‚</li><li>DNSæœåŠ¡å‘ç°æœºåˆ¶åˆ™æ²¡æœ‰è¿™äº›é™åˆ¶ã€‚</li></ul><h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><p>DNSæœåŠ¡å‘ç°æ˜¯åŸºäºCluster DNSçš„ï¼ŒDNSæœåŠ¡å™¨ä¼šå¯¹æ–°æœåŠ¡è¿›è¡Œç›‘æ§ï¼Œå¹¶ä¸ºæ¯ä¸€ä¸ªæœåŠ¡åˆ›å»ºDNSè®°å½•ï¼Œç”¨äºåŸŸåè§£æã€‚åœ¨é›†ç¾¤ä¸­ï¼Œå¦‚æœå¯ç”¨DNSï¼Œåˆ™æ‰€æœ‰çš„Podéƒ½å¯ä»¥è‡ªåŠ¨é€šè¿‡åç§°è§£ææœåŠ¡ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœåœ¨my-nså‘½åç©ºé—´ä¸‹æ‹¥æœ‰ä¸€ä¸ªåä¸ºmy-serivceçš„æœåŠ¡ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªåä¸ºmy-service.my-nsçš„DNSè®°å½•è¢«åˆ›å»ºï¼š</p><p>â— åœ¨my-nså‘½åç©ºé—´ä¸‹ï¼ŒPodå°†èƒ½å¤Ÿé€šè¿‡åç§°my-serviceæ¥å‘ç°æ­¤æœåŠ¡ã€‚</p><p>â— åœ¨å…¶å®ƒå‘½åç©ºé—´ï¼ŒPodå¿…é¡»é€šè¿‡my-serivce.my-nsæ¥å‘ç°æ­¤æœåŠ¡ï¼Œæ­¤åç§°é€‰å€çš„ç»“æœå³ä¸ºCluster IPã€‚</p><p>Kubernetesä¹Ÿæ”¯æŒç«¯å£çš„DNS SRVè®°å½•ã€‚å¦‚æœmy-service.my-nsæœåŠ¡æ‹¥æœ‰ä¸€ä¸ªTCPåè®®åç§°ä¸ºhttpçš„ç«¯å£ï¼Œå°±èƒ½å¤Ÿé€šè¿‡*http.*tcp.my-service.my-nsåç§°æ¥å‘ç°httpç«¯å£çš„å€¼ã€‚Kubernetes DNSæœåŠ¡å™¨æ˜¯å‘ç°ExternalNameç±»å‹æœåŠ¡çš„å”¯ä¸€é€”å¾„ã€‚</p><h2 id="4ã€Service-ç±»å‹"><a href="#4ã€Service-ç±»å‹" class="headerlink" title="4ã€Service ç±»å‹"></a>4ã€Service ç±»å‹</h2><p>å¯¹äºæŸäº›åº”ç”¨çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦æš´éœ²ä¸€ä¸ªä½¿ç”¨å¤–éƒ¨IPåœ°å€çš„Seviceã€‚é€šè¿‡Kubernetesçš„ServiceTypeï¼Œèƒ½å¤ŸæŒ‡å®šæ‰€ä½¿ç”¨çš„Serviceç±»å‹ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ClusterIPã€‚Kubernetesçš„æœåŠ¡ç±»å‹å¦‚ä¸‹ï¼š</p><ul><li>ClusterIP (default)ï¼šå°†æœåŠ¡æš´éœ²åœ¨é›†ç¾¤å†…éƒ¨çš„IPï¼Œæ­¤ç±»å‹ä»…æ”¯æŒåœ¨é›†ç¾¤å†…æœåŠ¡ã€‚</li><li>NodePortï¼šå°†æœåŠ¡æš´éœ²åœ¨æ‰€é€‰å®šæ¯ä¸€ä¸ªNodeçš„åŒä¸€ç«¯å£ï¼Œé›†ç¾¤å¤–å¯ä»¥é€šè¿‡<code>&lt;NodeIP&gt;:&lt;NodePort&gt;</code>æ–¹å¼è®¿é—®æœåŠ¡ã€‚</li><li>LoadBalancerï¼šåœ¨å½“å‰çš„é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œå¹¶ä¸ºæœåŠ¡æŒ‡æ´¾ä¸€ä¸ªå›ºå®šçš„ã€å¤–éƒ¨çš„ã€‚</li><li>ExternalNameï¼šä½¿ç”¨ä¸€ä¸ªéšæ„çš„åç§°æ¥æš´éœ²æœåŠ¡ï¼Œå¹¶ä¼šè¿”å›ä¸€ä¸ªå¸¦æœ‰åç§°çš„CNAMEè®°å½•ã€‚</li></ul><h5 id="åˆ›å»ºä¸€ä¸ªService"><a href="#åˆ›å»ºä¸€ä¸ªService" class="headerlink" title="åˆ›å»ºä¸€ä¸ªService"></a>åˆ›å»ºä¸€ä¸ªService</h5><p>åº”ç”¨è¯¥æ¸…å•å°†åˆ›å»ºä¸€ä¸ªåç§°ä¸º â€œmy-serviceâ€ çš„æ–° Serviceï¼Œ è¯¥æœåŠ¡æœåŠ¡ç±»å‹é»˜è®¤ä¸º<code>ClusterIP</code>ã€‚ è¯¥æœåŠ¡æŒ‡å‘å¸¦æœ‰æ ‡ç­¾ <code>name: my-service</code>çš„æ‰€æœ‰ Pod çš„TCP ç«¯å£ 80ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br> <span class="hljs-attr">ports:</span> <span class="hljs-comment"># Service ç«¯å£é…ç½®</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span> <span class="hljs-comment"># Service ç«¯å£åå­—</span><br>   <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># Service ç«¯å£</span><br>   <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span> <span class="hljs-comment"># ä»£ç†åè®®</span><br>   <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># ç›®æ ‡ç«¯å£ï¼Œç¨‹åºç«¯å£</span><br> <span class="hljs-attr">selector:</span> <span class="hljs-comment"># ä»£ç†åˆ°å“ªäº› Pod</span><br>   <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br> <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">None</span> <span class="hljs-comment"># ä¼šè¯ä¿æŒé…ç½®</span><br> <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span> <span class="hljs-comment"># Service ç±»å‹</span><br></code></pre></td></tr></table></figure><p>Service æ”¯æŒå°†ä¸€ä¸ªæ¥æ”¶ç«¯å£æ˜ å°„åˆ°ä»»æ„çš„ <code>targetPort</code>ï¼Œå¦‚æœ <code>targetPort</code> ä¸ºç©ºï¼Œ<code>targetPort</code> å°†è¢«è®¾ç½®ä¸ºä¸ <code>Port</code> å­—æ®µç›¸åŒçš„å€¼ã€‚<code>targetPort</code> å¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¼•ç”¨ <code>Pod</code> çš„ä¸€ä¸ªç«¯å£çš„åç§°ï¼Œè¿™æ ·çš„è¯å³ä½¿æ›´æ”¹äº† <code>Pod</code> çš„ç«¯å£ï¼Œä¹Ÿä¸ä¼šå¯¹ <code>Service</code> çš„è®¿é—®é€ æˆå½±å“ã€‚</p><p>Kubernetes Service èƒ½å¤Ÿæ”¯æŒ TCPã€UDPã€SCTP ç­‰åè®®ï¼Œé»˜è®¤ä¸º TCP åè®®ã€‚</p><h5 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h5><p>ClusterIPæœåŠ¡æ˜¯Kubernetesé»˜è®¤çš„æœåŠ¡ç±»å‹ã€‚å¦‚æœç”¨æˆ·åœ¨é›†ç¾¤å†…åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œåˆ™åœ¨é›†ç¾¤å†…éƒ¨çš„å…¶ä»–åº”ç”¨ç¨‹åºå¯ä»¥å¯¹è¿™ä¸ªæœåŠ¡è¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯ä¸å…·å¤‡é›†ç¾¤å¤–éƒ¨è®¿é—®çš„èƒ½åŠ›ã€‚Serviceçš„ClusterIPåœ°å€æ˜¯Kubernetesç³»ç»Ÿä¸­è™šæ‹Ÿçš„IPåœ°å€ï¼Œç”±ç³»ç»ŸåŠ¨æ€åˆ†é…ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">svc-clusterip</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>  <span class="hljs-comment"># å¯çœç•¥ï¼ˆé»˜è®¤ç±»å‹ï¼‰</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>      <span class="hljs-comment"># Service ç«¯å£</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>  <span class="hljs-comment"># Pod ç«¯å£</span><br></code></pre></td></tr></table></figure><p>è®¿é—®æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é€šè¿‡æœåŠ¡åè®¿é—®(ä»…é™Podå†…éƒ¨)</span><br>curl http://svc-clusterip<br><br><span class="hljs-comment"># é€šè¿‡ ClusterIP è®¿é—®</span><br>curl http://<span class="hljs-variable">$&#123;CLUSTER_IP&#125;</span><br></code></pre></td></tr></table></figure><h5 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h5><p>NodePortæœåŠ¡æ˜¯å¤–éƒ¨è®¿é—®æœåŠ¡çš„æœ€åŸºæœ¬æ–¹å¼ï¼Œé¡¾åæ€ä¹‰ï¼ŒNodePortå°±æ˜¯åœ¨æ‰€æœ‰èŠ‚ç‚¹æˆ–è€…è™šæ‹Ÿæœºä¸Šå¼€æ”¾ç‰¹ç‚¹çš„ç«¯å£ï¼Œè¯¥ç«¯å£çš„æµé‡å°†è¢«è½¬å‘åˆ°å¯¹åº”çš„æœåŠ¡ã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡<a href="NodeIP:NodePort">NodeIP:NodePort</a>çš„å½¢å¼æ¥è®¿é—®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">svc-nodeport</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">31000</span>  <span class="hljs-comment"># æ‰‹åŠ¨æŒ‡å®šç«¯å£ï¼ˆå¯é€‰ï¼‰</span><br></code></pre></td></tr></table></figure><p>è®¿é—®æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹èŠ‚ç‚¹ IP</span><br>kubectl get nodes -o wide<br><br><span class="hljs-comment"># ä»»æ„èŠ‚ç‚¹è®¿é—®</span><br>curl http://&lt;ä»»æ„èŠ‚ç‚¹IP&gt;:31000<br></code></pre></td></tr></table></figure><h5 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h5><p>LoadBalanceræœåŠ¡æ˜¯æš´éœ²æœåŠ¡è‡³äº’è”ç½‘æœ€æ ‡å‡†çš„æ–¹æ¡ˆï¼Œé™¤äº†å…·æœ‰é›†ç¾¤å†…éƒ¨IPä»¥åŠåœ¨NodePortä¸Šå…¬å¼€æœåŠ¡ä¹‹å¤–ï¼Œè¿˜è¦æ±‚äº‘æä¾›å•†è´Ÿè½½å‡è¡¡å°†è¯·æ±‚è½¬å‘åˆ°æ¯ä¸ªNodeèŠ‚ç‚¹çš„NodePortç«¯å£ä¸Šã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">svc-loadbalancer</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">service.beta.kubernetes.io/aws-load-balancer-backend-protocol:</span> <span class="hljs-string">&quot;http&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br></code></pre></td></tr></table></figure><p>è®¿é—®æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è·å–å¤–éƒ¨ IP</span><br>kubectl get svc loadbalancer-service -o jsonpath=<span class="hljs-string">&#x27;&#123;.status.loadBalancer.ingress[0].ip&#125;&#x27;</span><br><br><span class="hljs-comment"># ç›´æ¥è®¿é—®å¤–éƒ¨ IP</span><br>curl http://&lt;EXTERNAL-IP&gt;<br></code></pre></td></tr></table></figure><h5 id="ExternalName"><a href="#ExternalName" class="headerlink" title="ExternalName"></a>ExternalName</h5><p>ExternalNameæ˜¯Serviceçš„ç‰¹ä¾‹ï¼Œå®ƒæ²¡æœ‰Selectorï¼Œä¹Ÿæ²¡æœ‰å®šä¹‰ä»»ä½•çš„ç«¯å£å’Œ Endpointã€‚</p><p>å°† <code>Service</code> æ˜ å°„åˆ°å¤–éƒ¨æœåŠ¡çš„ DNS åç§°ï¼ˆå¦‚æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹ APIï¼‰ï¼Œä¸åˆ›å»ºä»»ä½•ä»£ç†æˆ–ç«¯å£æš´éœ²ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-external-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">my-database.example.com</span>  <span class="hljs-comment"># å¤–éƒ¨æœåŠ¡åŸŸå</span><br></code></pre></td></tr></table></figure><p>è®¿é—®æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é›†ç¾¤å†…éƒ¨è®¿é—®</span><br>nslookup external-db-service.default.svc.cluster.local<br><span class="hljs-comment"># è¿”å› my.database.example.com</span><br></code></pre></td></tr></table></figure><h5 id="Headless-Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰"><a href="#Headless-Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰" class="headerlink" title="Headless Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰"></a>Headless Serviceï¼ˆæ— å¤´æœåŠ¡ï¼‰</h5><p>ä¸åˆ†é… <code>ClusterIP</code>ï¼Œç›´æ¥è¿”å›Pod IP<strong>åˆ—è¡¨</strong>ï¼Œé€‚ç”¨äºéœ€è¦ç›´æ¥è®¿é—® <code>Pod</code> çš„åœºæ™¯ï¼ˆå¦‚ <code>StatefulSet</code>ï¼‰ã€‚é€‚ç”¨åœºæ™¯ï¼šæœ‰çŠ¶æ€åº”ç”¨ï¼ˆå¦‚æ•°æ®åº“é›†ç¾¤ï¼‰å’Œ éœ€è¦è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</p><h2 id="5ã€Endpoints-ä¸-EndpointSlices-æœºåˆ¶"><a href="#5ã€Endpoints-ä¸-EndpointSlices-æœºåˆ¶" class="headerlink" title="5ã€Endpoints ä¸ EndpointSlices æœºåˆ¶"></a>5ã€Endpoints ä¸ EndpointSlices æœºåˆ¶</h2><h3 id="ä»€ä¹ˆæ˜¯-endpoints"><a href="#ä»€ä¹ˆæ˜¯-endpoints" class="headerlink" title="ä»€ä¹ˆæ˜¯ endpoints"></a>ä»€ä¹ˆæ˜¯ endpoints</h3><p>serviceåœ¨åˆ›å»ºä¹‹åï¼Œä¼šé»˜è®¤æ ¹æ®æ ‡ç­¾é€‰æ‹©å™¨æ¥æŠ“å–ç¬¦åˆæ ‡ç­¾çš„åç«¯çœŸå®podçš„ipï¼Œå°†è¿™äº›ipç»´æŠ¤æˆä¸€ä¸ªendpointå¯¹è±¡ï¼Œå½“æˆ‘ä»¬å»è®¿é—®svcçš„æ—¶å€™è‡ªåŠ¨çš„è´Ÿè½½åˆ°endpointã€‚å¦‚æœæ²¡æœ‰é€‰æ‹©å™¨ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨çš„å»åˆ›å»ºendpointå¯¹è±¡æ¥å®ç°è®¿é—®ã€‚</p><p><strong>Endpointçš„ç»„æˆ</strong>ï¼š</p><ul><li>IPåœ°å€ï¼šPodæˆ–å…¶ä»–ç½‘ç»œæœåŠ¡çš„IPåœ°å€ã€‚</li><li>ç«¯å£ï¼šæœåŠ¡æš´éœ²çš„ç«¯å£ã€‚</li><li>TargetRefï¼šæŒ‡å‘å®é™…ç›®æ ‡ï¼ˆPodï¼‰çš„å¼•ç”¨ï¼Œé€šå¸¸åŒ…æ‹¬Podçš„åç§°å’Œå‘½åç©ºé—´ã€‚</li></ul><p><strong>å±€é™æ€§</strong></p><ul><li>æ‰©å±•æ€§å·®ï¼šå½“ Endpoints æ•°é‡å¾ˆå¤šï¼ˆå¦‚ä¸€ä¸ª Service ä¸‹æœ‰å‡ åƒã€å‡ ä¸‡ä¸ª Podï¼‰ï¼Œå•ä¸ªèµ„æºä¼šå˜å¾—éå¸¸å¤§ã€‚</li><li>æ€§èƒ½ç“¶é¢ˆï¼šæ¯å½“æœ‰ä»»ä½•å˜åŠ¨ï¼ˆæ–°å¢&#x2F;ç§»é™¤ Podï¼‰ï¼Œæ•´ä¸ª Endpoints å¯¹è±¡éƒ½è¦è¢«æ›´æ–°ã€åŒæ­¥ã€åˆ†å‘ï¼ŒAPI Server&#x2F;etcd&#x2F;Watch å®¢æˆ·ç«¯éƒ½ä¼šæœ‰æ˜æ˜¾è´Ÿæ‹…ã€‚</li><li>é«˜å¯ç”¨æ€§å—å½±å“ï¼šå¤§å‹ Service æ“ä½œ Endpoints æ—¶å¯èƒ½é‡åˆ°åŒæ­¥å»¶è¿Ÿã€ç½‘ç»œé£æš´ã€èµ„æºæ¶ˆè€—æš´æ¶¨ç­‰é—®é¢˜ã€‚</li></ul><h3 id="ä»€ä¹ˆæ˜¯EndpointSlices-Kubernetes-v1-21-é»˜è®¤"><a href="#ä»€ä¹ˆæ˜¯EndpointSlices-Kubernetes-v1-21-é»˜è®¤" class="headerlink" title="ä»€ä¹ˆæ˜¯EndpointSlices(Kubernetes v1.21+ é»˜è®¤)"></a>ä»€ä¹ˆæ˜¯EndpointSlices(Kubernetes v1.21+ é»˜è®¤)</h3><ul><li>EndpointSlices æ˜¯ä¸ºäº†ä¼˜åŒ–å’Œè§£å†³ä¼ ç»Ÿ Endpoints æ€§èƒ½ä¸è¶³è€Œè®¾è®¡çš„æ–°æ–¹å¼ã€‚</li><li><strong>ä¸€ä¸ª Service ä¼šè‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ªæˆ–å¤šä¸ª</strong> <code>**EndpointSlice**</code><strong>ï¼Œæ¯ä¸ª Slice åŒ…å« Service</strong> <strong>éƒ¨åˆ†åç«¯</strong> <strong>Pod ä¿¡æ¯</strong>ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">discovery.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">EndpointSlice</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service-abc123</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">kubernetes.io/service-name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">addressType:</span> <span class="hljs-string">IPv4</span><br><span class="hljs-attr">ports:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">endpoints:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10.244.1.2&quot;</span><br>  <span class="hljs-attr">conditions:</span><br>    <span class="hljs-attr">ready:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">nodeName:</span> <span class="hljs-string">node-1</span><br>  <span class="hljs-attr">zone:</span> <span class="hljs-string">us-west2-a</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10.244.2.3&quot;</span><br>  <span class="hljs-attr">conditions:</span><br>    <span class="hljs-attr">ready:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">nodeName:</span> <span class="hljs-string">node-2</span><br>  <span class="hljs-attr">zone:</span> <span class="hljs-string">us-west2-b</span><br></code></pre></td></tr></table></figure><ul><li>æ¯ä¸ª EndpointSlice é»˜è®¤æœ€å¤šåŒ…å« 100 ä¸ª Endpointsï¼ˆå¯è°ƒï¼‰ã€‚</li><li>ä¸€ä¸ª Service å¦‚æœæœ‰ 350 ä¸ª Podï¼Œé€šå¸¸ä¼šæœ‰ 4 ä¸ªå·¦å³çš„ EndpointSliceã€‚</li></ul><p><strong>ç‰¹ç‚¹</strong></p><ul><li><strong>åˆ†ç‰‡ç®¡ç†</strong>ï¼šæ¯ä¸ª Service ä¼šè¢«æ‹†åˆ†ä¸ºå¤šä¸ª EndpointSliceï¼Œæ¯ç‰‡ä»…æºå¸¦éƒ¨åˆ†åç«¯ Pod ä¿¡æ¯ã€‚</li><li><strong>å¯æ‰©å±•æ€§å¼º</strong>ï¼šæ›´æ–°åªéœ€åŒæ­¥å˜åŠ¨è¾ƒå°çš„ EndpointSliceï¼Œæ›´åŠ é«˜æ•ˆã€‚</li><li><strong>ä¸°å¯Œä¿¡æ¯</strong>ï¼šç»“æ„ä¸­åŒ…å«æ›´å¤šå…ƒæ•°æ®ï¼ˆå¦‚æ‹“å±•åœ°å€ç±»å‹ã€æ‹“å±•å¥åº·çŠ¶å†µã€æ‹“å±•ç«¯å£åè®®ç­‰ï¼‰ã€‚</li><li><strong>API ç‰ˆæœ¬</strong>ï¼šèµ„æºå±äº discovery API ç»„ï¼Œ<code>discovery.k8s.io/v1</code>ã€‚</li></ul><p><strong>ä¼˜ç‚¹</strong></p><ul><li><strong>å¤§è§„æ¨¡ Service æ€§èƒ½æå‡</strong>ï¼Œå°¤å…¶æ˜¯ Watchã€etcd å­˜å‚¨å’Œè´Ÿè½½ä¸‹é™</li><li>æ”¯æŒå¤šåè®®åœ°å€ï¼ˆå¦‚ IPv4&#x2F;IPv6 åŒæ—¶å­˜åœ¨ï¼‰</li><li>å¯è‡ªå®šä¹‰ EndpointSlice çš„å¤§å°ï¼ˆnumber of endpoints per sliceï¼‰</li></ul><h2 id="6ã€Serviceä½¿ç”¨æ¡ˆä¾‹"><a href="#6ã€Serviceä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="6ã€Serviceä½¿ç”¨æ¡ˆä¾‹"></a>6ã€Serviceä½¿ç”¨æ¡ˆä¾‹</h2><h3 id="ExternalName-ä»£ç†åŸŸå"><a href="#ExternalName-ä»£ç†åŸŸå" class="headerlink" title="ExternalName ä»£ç†åŸŸå"></a>ExternalName ä»£ç†åŸŸå</h3><h5 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h5><ul><li><code>DNSåˆ«åæ˜ å°„</code>ï¼šå°†k8sé›†ç¾¤å†…çš„æœåŠ¡åç§°ï¼ˆå¦‚<code>my-external-service</code>ï¼‰æ˜ å°„åˆ°å¤–éƒ¨æœåŠ¡çš„åŸŸåï¼ˆå¦‚<code>api.external-provider.com</code>ï¼‰</li><li><code>æ— ä»£ç†è½¬å‘</code>ï¼šä¸åˆ›å»ºä»»ä½•è´Ÿè½½å‡è¡¡æˆ–ç«¯å£ä»£ç†ï¼Œä»…ä»…é€šè¿‡DNS CNAME è®°å½•å®ç°é€æ˜è§£æã€‚</li><li><code>ç¯å¢ƒæŠ½è±¡</code>ï¼šå±è”½å¤–éƒ¨æœåŠ¡çš„çœŸå®åœ°å€ï¼Œç®€åŒ–åº”ç”¨é…ç½®ï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¤–éƒ¨ç«¯ç‚¹ï¼‰ã€‚</li></ul><h5 id="é…ç½®å®ä¾‹"><a href="#é…ç½®å®ä¾‹" class="headerlink" title="é…ç½®å®ä¾‹"></a>é…ç½®å®ä¾‹</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>  <span class="hljs-comment"># é›†ç¾¤å†…æœåŠ¡åç§°</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">mysql.com</span>  <span class="hljs-comment"># å¤–éƒ¨æœåŠ¡åŸŸå</span><br></code></pre></td></tr></table></figure><h5 id="ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼ˆç»Ÿä¸€è®¿é—®æ•°æ®åº“ï¼‰"><a href="#ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼ˆç»Ÿä¸€è®¿é—®æ•°æ®åº“ï¼‰" class="headerlink" title="ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼ˆç»Ÿä¸€è®¿é—®æ•°æ®åº“ï¼‰"></a>ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼ˆç»Ÿä¸€è®¿é—®æ•°æ®åº“ï¼‰</h5><p>åœºæ™¯æè¿°ï¼š</p><ul><li>åº”ç”¨éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œéœ€è®¿é—® AWS RDS ä¸Šçš„ MySQL æ•°æ®åº“ã€‚</li><li>RDS å®ä¾‹çš„ç«¯ç‚¹å¯èƒ½å› ç¯å¢ƒï¼ˆå¼€å‘&#x2F;ç”Ÿäº§ï¼‰æˆ–æ•…éšœè½¬ç§»è€Œå˜åŒ–ã€‚</li></ul><p>ä½¿ç”¨ ExternalName çš„ä¼˜åŠ¿ï¼š</p><ul><li>é…ç½®è§£è€¦ï¼šåº”ç”¨ä»£ç ä¸­åªéœ€è¿æ¥ <code>mysql-service</code>ï¼Œæ— éœ€ç¡¬ç¼–ç  RDS åœ°å€ã€‚</li><li>çµæ´»åˆ‡æ¢ï¼šé€šè¿‡ä¿®æ”¹ <code>externalName</code> åˆ‡æ¢ä¸åŒç¯å¢ƒçš„æ•°æ®åº“ï¼ˆå¦‚å¼€å‘ç¯å¢ƒç”¨æµ‹è¯•åº“ï¼Œç”Ÿäº§ç¯å¢ƒç”¨é«˜å¯ç”¨åº“ï¼‰ã€‚</li></ul><p>æ“ä½œæ­¥éª¤ï¼š</p><ol><li>å®šä¹‰ExternalName Serviceï¼š</li></ol><p>ç”Ÿäº§ç¯å¢ƒå¯¹åº”çš„service</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒé…ç½®</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">app-prod</span>  <span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒ</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">prod-db.cluster-abc123.us-west-1.rds.amazonaws.com</span><br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç¯å¢ƒå¯¹åº”çš„service</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒé…ç½®</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">app-test</span>  <span class="hljs-comment"># testç¯å¢ƒ</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">test-db.cluster-abc123.us-west-1.rds.amazonaws.com</span><br></code></pre></td></tr></table></figure><ol><li>åº”ç”¨è¿æ¥æ•°æ®ï¼š</li></ol><p>åº”ç”¨ä»£ç ä¸­ä½¿ç”¨ç»Ÿä¸€ç«¯ç‚¹ <code>mysql-service</code>ï¼ˆKubernetes DNS è§£æä¸ºå¤–éƒ¨åŸŸåï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Python ç¤ºä¾‹</span><br><span class="hljs-string">import</span> <span class="hljs-string">mysql.connector</span><br><span class="hljs-string">db</span> <span class="hljs-string">=</span> <span class="hljs-string">mysql.connector.connect(</span><br>  <span class="hljs-string">host=&quot;mysql-service&quot;,</span>  <span class="hljs-comment"># Kubernetes æœåŠ¡åç§°</span><br>  <span class="hljs-string">user=&quot;admin&quot;,</span><br>  <span class="hljs-string">password=&quot;password&quot;</span><br><span class="hljs-string">)</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç ï¼Œä»…ä»…éœ€è¦æ›´æ–°serviceä¸­å®šä¹‰çš„<code>externalName</code> å°±å¯ä»¥å®ç°å¤šç¯å¢ƒåŒä½¿ç”¨åŒä¸€ä¸ªserviceåå­—å°±èƒ½è‡ªåŠ¨è¿æ¥åˆ°å¯¹åº”çš„ç¯å¢ƒä¸­ã€‚</p><h3 id="ä¼šè¯ä¿æŒ"><a href="#ä¼šè¯ä¿æŒ" class="headerlink" title="ä¼šè¯ä¿æŒ"></a>ä¼šè¯ä¿æŒ</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">ClientIP</span>  <span class="hljs-comment"># å¯é€‰å€¼ï¼šNoneï¼ˆé»˜è®¤ï¼‰ã€ClientIP</span><br>  <span class="hljs-attr">sessionAffinityConfig:</span><br>    <span class="hljs-attr">clientIP:</span><br>      <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">10800</span>  <span class="hljs-comment"># ä¼šè¯ä¿æŒæ—¶é—´ï¼ˆé»˜è®¤ 10800 ç§’ï¼Œå³ 3 å°æ—¶ï¼‰</span><br></code></pre></td></tr></table></figure><ul><li>åŒä¸€å®¢æˆ·ç«¯ IP çš„è¯·æ±‚åœ¨ <code>timeoutSeconds</code> å†…å§‹ç»ˆè½¬å‘åˆ°åŒä¸€ Podã€‚</li><li>è‹¥ Pod é‡å¯æˆ–ç¼©å®¹ï¼Œå®¢æˆ·ç«¯ IP çš„å“ˆå¸Œç»“æœå¯èƒ½å˜åŒ–ï¼Œå¯¼è‡´ä¼šè¯ä¸­æ–­</li></ul><h3 id="è·å–å®¢æˆ·ç«¯çœŸå®-IP"><a href="#è·å–å®¢æˆ·ç«¯çœŸå®-IP" class="headerlink" title="è·å–å®¢æˆ·ç«¯çœŸå® IP"></a>è·å–å®¢æˆ·ç«¯çœŸå® IP</h3><p><code>externalTrafficPolicy: Local</code> æ˜¯ Kubernetes Service çš„ä¸€ä¸ªå…³é”®é…ç½®é€‰é¡¹ï¼Œå®ƒæ”¹å˜äº†æµé‡è¿›å…¥é›†ç¾¤çš„æ–¹å¼ï¼Œä»è€Œä¿ç•™äº†å®¢æˆ·ç«¯çš„çœŸå® IP åœ°å€ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š</p><table><thead><tr><th><strong>ç‰¹æ€§</strong></th><th><code>**Cluster**</code> <strong>(é»˜è®¤)</strong></th><th><code>**Local**</code></th></tr></thead><tbody><tr><td><strong>æµé‡è·¯ç”±</strong></td><td>æµé‡å¯åˆ°è¾¾ä»»ä½•èŠ‚ç‚¹ï¼Œå³ä½¿è¯¥èŠ‚ç‚¹æ²¡æœ‰è¿è¡Œç›®æ ‡ Pod</td><td>æµé‡åªè·¯ç”±åˆ°è¿è¡Œç›®æ ‡ Pod çš„èŠ‚ç‚¹</td></tr><tr><td><strong>æº IP ä¿ç•™</strong></td><td>âŒ ä¸¢å¤±å®¢æˆ·ç«¯çœŸå® IP</td><td>âœ… ä¿ç•™å®¢æˆ·ç«¯çœŸå® IP</td></tr><tr><td><strong>ç½‘ç»œè·³æ•°</strong></td><td>2 è·³ï¼šCLB â†’ ä»»æ„èŠ‚ç‚¹ â†’ ç›®æ ‡èŠ‚ç‚¹</td><td>1 è·³ï¼šCLB â†’ ç›®æ ‡èŠ‚ç‚¹</td></tr><tr><td><strong>è´Ÿè½½å‡è¡¡</strong></td><td>æ‰€æœ‰èŠ‚ç‚¹å‡åŒ€åˆ†æ‹…æµé‡</td><td>åªæœ‰è¿è¡Œ Pod çš„èŠ‚ç‚¹æ¥æ”¶æµé‡</td></tr><tr><td><strong>å¥åº·æ£€æŸ¥</strong></td><td>èŠ‚ç‚¹å¥åº·å³æ¥æ”¶æµé‡</td><td>åªæ£€æŸ¥æœ‰ Pod çš„èŠ‚ç‚¹</td></tr><tr><td><strong>æº IP å¦‚ä½•è·å¾—</strong></td><td></td><td>ä¸éœ€è¦ SNAT&#x2F;DNAT è½¬æ¢ï¼ŒåŸå§‹å®¢æˆ·ç«¯ IP å¾—ä»¥ä¿ç•™</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sä¹‹Pod</title>
    <link href="/2025/09/20/K8s%E4%B9%8BPod/"/>
    <url>/2025/09/20/K8s%E4%B9%8BPod/</url>
    
    <content type="html"><![CDATA[<h1 id="K8sä¹‹Pod"><a href="#K8sä¹‹Pod" class="headerlink" title="K8sä¹‹Pod"></a>K8sä¹‹Pod</h1><h3 id="ä»€ä¹ˆæ˜¯Pod"><a href="#ä»€ä¹ˆæ˜¯Pod" class="headerlink" title="ä»€ä¹ˆæ˜¯Pod"></a>ä»€ä¹ˆæ˜¯Pod</h3><p>Podæ˜¯kubernetesä¸­æœ€å°çš„å¯éƒ¨ç½²å•å…ƒã€‚ä¸€ä¸ªPodåŒ…å«äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºå®¹å™¨ï¼ˆæˆ–è€…å¤šä¸ªå®¹å™¨ï¼‰ã€å­˜å‚¨èµ„æºã€ä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ã€ä»¥åŠä¸€äº›ç¡®å®šè¯¥å®¹å™¨å¦‚ä½•è¿è¡Œçš„é€‰é¡¹ã€‚Podå®¹å™¨ç»„ä»£è¡¨äº†Kubernetesä¸­ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºè¿è¡Œå®ä¾‹ã€‚ä»–ä»¬ï¼š</p><ul><li>å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼šPodå†…æ‰€æœ‰çš„å®¹å™¨å…±äº«åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£ç©ºé—´ã€‚</li><li>å…±äº«å­˜å‚¨å·ï¼šPodå¯ä»¥å®šä¹‰ä¸€ç»„å…±äº«çš„å­˜å‚¨å·ï¼Œä½¿å®¹å™¨é—´å¯å…±äº«æ–‡ä»¶</li><li>å…±äº«è¿›ç¨‹ç©ºé—´ï¼šå®¹å™¨é—´å¯ä»¥çœ‹è§å½¼æ­¤çš„è¿›ç¨‹</li><li>èµ„æºå…±äº«ä¸éš”ç¦»ï¼šPodä½œä¸ºæ•´ä½“ç”³è¯·èµ„æºï¼ŒK8sè°ƒåº¦å™¨åŸºäºPodçš„èµ„æºéœ€æ±‚åˆ†é…èŠ‚ç‚¹</li></ul><p>Podçš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´æ€§</p><ul><li>Podå†…é¢æ‰€æœ‰å®¹å™¨åŒæ—¶å¯åŠ¨ã€ç»ˆæ­¢</li><li>å¥åº·æ£€æŸ¥ä»¥Podä¸ºæ•´ä½“å•ä½</li></ul><p>Podçš„æ•´ä½“åˆ›å»ºæµç¨‹ï¼ˆåŸæ–‡æ¡£ï¼š<a href="https://www.yuque.com/dycloud/pss8ys/vfu5nhag71ezmbl1%EF%BC%89">https://www.yuque.com/dycloud/pss8ys/vfu5nhag71ezmbl1ï¼‰</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/50542277/1749455208444-e4a11474-da6f-4c79-88ea-620bce59ba71.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_65,text_Si4=,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10/format,webp" alt="img"></p><h3 id="Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"><a href="#Pod-ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£" class="headerlink" title="Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£"></a>Pod ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è¯¦è§£</h3><table><thead><tr><th><strong>çŠ¶æ€</strong></th><th><strong>è§¦å‘æ¡ä»¶</strong></th><th><strong>å…¸å‹åŸå› </strong></th><th><strong>æ’æŸ¥æ–¹æ³•</strong></th></tr></thead><tbody><tr><td><code>**Pending**</code></td><td>API Server å·²æ¥æ”¶åˆ›å»ºè¯·æ±‚</td><td>â€¢ è°ƒåº¦é˜Ÿåˆ—ç­‰å¾…â€¢ é•œåƒæ­£åœ¨æ‹‰å–â€¢ èŠ‚ç‚¹èµ„æºä¸è¶³</td><td><code>kubectl describe pod</code> æŸ¥çœ‹ Events</td></tr><tr><td><code>**ContainerCreating**</code></td><td>Kubelet å¼€å§‹åˆ›å»ºå®¹å™¨</td><td>â€¢ å­˜å‚¨å·æŒ‚è½½ä¸­â€¢ CNI ç½‘ç»œé…ç½®ä¸­â€¢ CRI åˆ›å»ºå®¹å™¨ä¸­</td><td>æ£€æŸ¥èŠ‚ç‚¹å­˜å‚¨&#x2F;ç½‘ç»œæ’ä»¶æ—¥å¿—</td></tr><tr><td><code>**Running**</code></td><td>è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€</td><td>æ­£å¸¸æœåŠ¡çŠ¶æ€</td><td>æ£€æŸ¥ä¸šåŠ¡æ—¥å¿— <code>kubectl logs</code></td></tr><tr><td><code>**CrashLoopBackOff**</code></td><td>å®¹å™¨åå¤å´©æºƒï¼ˆé‡å¯é—´éš”æŒ‡æ•°å¢é•¿ï¼‰</td><td>â€¢ åº”ç”¨å¯åŠ¨é”™è¯¯â€¢ é…ç½®é”™è¯¯â€¢ å†…å­˜æ³„æ¼å¯¼è‡´ OOMâ€¢ Liveness æ¢é’ˆé…ç½®ä¸å½“</td><td><code>kubectl logs --previous</code> æŸ¥çœ‹å´©æºƒå‰æ—¥å¿—</td></tr><tr><td><code>**ImagePullBackOff**</code></td><td>å®¹å™¨é•œåƒæ‹‰å–å¤±è´¥</td><td>â€¢ é•œåƒåç§°é”™è¯¯â€¢ ç§æœ‰ä»“åº“è®¤è¯å¤±è´¥â€¢ ç½‘ç»œéš”ç¦»â€¢ é•œåƒä»“åº“æ•…éšœ</td><td><code>kubectl describe pod</code> æŸ¥çœ‹æ‹‰å–é”™è¯¯è¯¦æƒ…</td></tr><tr><td><code>**Terminating**</code></td><td>åˆ é™¤æŒ‡ä»¤å·²ä¸‹å‘</td><td>ç”¨æˆ·æ‰§è¡Œåˆ é™¤æˆ–æ§åˆ¶å™¨ç¼©å®¹</td><td>æ£€æŸ¥ Finalizer é˜»å¡ <code>kubectl get pod -o json</code></td></tr><tr><td><code>**Succeeded**</code></td><td>æ‰€æœ‰å®¹å™¨æ­£å¸¸é€€å‡ºï¼ˆexit code&#x3D;0ï¼‰</td><td>Job&#x2F;CronJob ä»»åŠ¡å®Œæˆ</td><td>æ£€æŸ¥ä»»åŠ¡è¾“å‡ºæ—¥å¿—</td></tr><tr><td><code>**Failed**</code></td><td>è‡³å°‘ä¸€ä¸ªå®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆexit code â‰ 0ï¼‰</td><td>â€¢ åº”ç”¨ä»£ç å¼‚å¸¸â€¢ èµ„æºè¶…é™è¢«æ€â€¢ å¥åº·æ£€æŸ¥å¤±è´¥</td><td><code>kubectl describe</code> æŸ¥çœ‹ Exit Code</td></tr><tr><td><code>**Unknown**</code></td><td>Kubelet å¤±è”</td><td>â€¢ èŠ‚ç‚¹æ•…éšœâ€¢ ç½‘ç»œåˆ†åŒºâ€¢ Kubelet è¿›ç¨‹å´©æºƒ</td><td><code>kubectl get node</code> æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€</td></tr><tr><td><code>**Evicted**</code></td><td>èŠ‚ç‚¹èµ„æºå‹åŠ›è§¦å‘é©±é€</td><td>â€¢ å†…å­˜ä¸è¶³â€¢ ç£ç›˜å‹åŠ›â€¢ PID èµ„æºè€—å°½</td><td>æ£€æŸ¥èŠ‚ç‚¹ç›‘æ§æŒ‡æ ‡ <code>kubectl top node</code></td></tr></tbody></table><p>å½“ä¸€ä¸ª Pod è¢«åˆ é™¤æ—¶ï¼Œæ‰§è¡Œä¸€äº› kubectl å‘½ä»¤ä¼šå±•ç¤ºè¿™ä¸ª Pod çš„çŠ¶æ€ä¸º <code>Terminating</code>ï¼ˆç»ˆæ­¢ï¼‰ã€‚ è¿™ä¸ª <code>Terminating</code> çŠ¶æ€å¹¶ä¸æ˜¯ Pod é˜¶æ®µä¹‹ä¸€ã€‚ Pod è¢«èµ‹äºˆä¸€ä¸ªå¯ä»¥ä½“é¢ç»ˆæ­¢çš„æœŸé™ï¼Œé»˜è®¤ä¸º 30 ç§’ã€‚ ä½ å¯ä»¥ä½¿ç”¨ <code>--force</code> å‚æ•°æ¥å¼ºåˆ¶ç»ˆæ­¢ Pod</p><h3 id="Pod-é‡å¯ç­–ç•¥"><a href="#Pod-é‡å¯ç­–ç•¥" class="headerlink" title="Pod é‡å¯ç­–ç•¥"></a>Pod é‡å¯ç­–ç•¥</h3><p>Pod çš„é‡å¯ç­–ç•¥é€šè¿‡ <code>spec.restartPolicy</code> å­—æ®µå®šä¹‰ï¼Œæ§åˆ¶å®¹å™¨å¼‚å¸¸é€€å‡ºåçš„æ¢å¤è¡Œä¸ºï¼š</p><table><thead><tr><th><strong>ç­–ç•¥</strong></th><th><strong>è§¦å‘åœºæ™¯</strong></th><th><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong></th><th><strong>å®¹å™¨è¡Œä¸º</strong></th></tr></thead><tbody><tr><td><strong>Always</strong></td><td>å®¹å™¨é€€å‡ºï¼ˆæ— è®ºexit codeå€¼ï¼‰</td><td>WebæœåŠ¡ã€æ•°æ®åº“ç­‰é•¿æœŸè¿è¡Œåº”ç”¨</td><td>æ— é™é‡å¯å®¹å™¨ï¼ˆKubeletæ§åˆ¶ï¼Œ30ç§’æŒ‡æ•°é€€é¿é‡è¯•ï¼‰</td></tr><tr><td><strong>OnFailure</strong></td><td>å®¹å™¨ä»¥é0çŠ¶æ€é€€å‡ºï¼ˆexit code â‰ 0ï¼‰</td><td>æ‰¹å¤„ç†ä»»åŠ¡ã€CI&#x2F;CDæµæ°´çº¿ä»»åŠ¡</td><td>æŒ‰éœ€é‡å¯ï¼ŒæˆåŠŸååœæ­¢</td></tr><tr><td><strong>Never</strong></td><td>ä»»ä½•é€€å‡ºéƒ½ä¸é‡å¯</td><td>å•æ¬¡æ‰§è¡Œä»»åŠ¡ï¼ˆå¦‚æ•°æ®è¿ç§»ï¼‰</td><td>è®°å½•é”™è¯¯æ—¥å¿—ï¼ŒPodçŠ¶æ€å˜ä¸º <code>Failed</code></td></tr></tbody></table><p><strong>å…³é”®çº¦æŸ</strong>ï¼š</p><ol><li><strong>èŠ‚ç‚¹çº§æ“ä½œ</strong>ï¼šé‡å¯ç”± <strong>Kubelet</strong> æ‰§è¡Œï¼ˆä¸ç»è¿‡API Serverï¼‰</li><li><strong>é¿é€€å»¶è¿Ÿ</strong>ï¼šé˜²æ­¢é¢‘ç¹å´©æºƒæ¶ˆè€—èµ„æºï¼ˆç¬¬Næ¬¡é‡å¯å»¶è¿Ÿ &#x3D; min(300s, 10s * 2^(N-1))ï¼‰</li><li><strong>é‡ç½®æ¡ä»¶</strong>ï¼šå®¹å™¨æŒç»­è¿è¡Œè¶…è¿‡ <strong>10åˆ†é’Ÿ</strong> åé‡å¯è®¡æ•°å½’é›¶</li></ol><h3 id="Pause-å®¹å™¨"><a href="#Pause-å®¹å™¨" class="headerlink" title="Pause å®¹å™¨"></a>Pause å®¹å™¨</h3><p>Infra å®¹å™¨ï¼ˆPauseå®¹å™¨ï¼‰æ˜¯Podçš„<strong>æ ¸å¿ƒåŸºç¡€è®¾æ–½</strong>ï¼Œä½¿ç”¨å®˜æ–¹ <code>registry.k8s.io/pause</code> é•œåƒï¼ˆçº¦250KBï¼‰ã€‚</p><table><thead><tr><th><strong>åŠŸèƒ½</strong></th><th><strong>å®ç°åŸç†</strong></th><th><strong>å¯¹ä¸šåŠ¡å®¹å™¨å½±å“</strong></th></tr></thead><tbody><tr><td><strong>å…±äº«ç½‘ç»œå‘½åç©ºé—´</strong></td><td>åˆ›å»ºåˆå§‹ç½‘ç»œæ ˆï¼Œåç»­å®¹å™¨é€šè¿‡ <code>--net=container:&lt;infra&gt;</code> åŠ å…¥</td><td>å®¹å™¨é—´é€šè¿‡ <code>localhost</code> é€šä¿¡</td></tr><tr><td><strong>å…±äº«å­˜å‚¨å·</strong></td><td>é¦–å…ˆæŒ‚è½½Podå£°æ˜çš„Volumeï¼Œåç»­å®¹å™¨å¤ç”¨æŒ‚è½½ç‚¹</td><td>å®¹å™¨å…±äº«åŒä¸€ç›®å½•æ•°æ®</td></tr><tr><td><strong>å…±äº«IPCå‘½åç©ºé—´</strong></td><td>è®¾ç½® <code>--ipc=container:&lt;infra&gt;</code></td><td>å®¹å™¨å¯ç”¨SystemV IPCé€šä¿¡</td></tr><tr><td><strong>PIDèµ„æºæ‰˜ç®¡</strong></td><td>ä½œä¸ºPID 1è¿›ç¨‹ï¼ˆé˜²æ­¢åƒµå°¸è¿›ç¨‹ï¼‰</td><td>ä¸šåŠ¡è¿›ç¨‹é€€å‡ºæ—¶è¢«pauseå›æ”¶</td></tr><tr><td><strong>Podç”Ÿå­˜çŠ¶æ€åŸºå‡†</strong></td><td>Kubeleté€šè¿‡ç›‘æ§pauseå®¹å™¨åˆ¤æ–­Podå­˜æ´»</td><td>å³ä½¿ä¸šåŠ¡å®¹å™¨å´©æºƒPodä»è¢«è§†ä¸ºå­˜åœ¨</td></tr></tbody></table><h3 id="Podæ•°é‡é™åˆ¶"><a href="#Podæ•°é‡é™åˆ¶" class="headerlink" title="Podæ•°é‡é™åˆ¶"></a>Podæ•°é‡é™åˆ¶</h3><p>Kubernetes NodeèŠ‚ç‚¹æ¯ä¸ªé»˜è®¤å…è®¸æœ€å¤šåˆ›å»º110ä¸ªPodï¼Œæœ‰æ—¶å¯èƒ½ä¼šç”±äºç³»ç»Ÿç¡¬ä»¶çš„é—®é¢˜ï¼Œä»è€Œéœ€è¦æ§åˆ¶NodeèŠ‚ç‚¹çš„Podçš„è¿è¡Œæ•°é‡ã€‚</p><p>å³ï¼šéœ€è¦è°ƒæ•´NodeèŠ‚ç‚¹çš„æœ€å¤§å¯è¿è¡ŒPodæ•°é‡ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ kubelet å¯åŠ¨å‘½ä»¤ä¸­å¢åŠ  â€“max-pods å‚æ•°ï¼Œç„¶åï¼Œé‡å¯ kubelet æœåŠ¡ï¼Œå°±ç”Ÿæ•ˆã€‚</p><p>é‡å¯ kubeletï¼Œä¸å½±å“ç°æœ‰è¿è¡Œä¸­çš„å®¹å™¨ï¼Œä¸ä¼šé€ æˆå®¹å™¨é‡å¯ã€‚</p><h3 id="Podè§£æ"><a href="#Podè§£æ" class="headerlink" title="Podè§£æ"></a>Podè§£æ</h3><p>æŸäº›æƒ…å†µä¸‹ï¼ŒDNS æˆ–è€…å…¶ä»–çš„åŸŸåè§£ææ–¹æ³•å¯èƒ½ä¸å¤ªé€‚ç”¨ï¼Œæ‚¨éœ€è¦é…ç½® &#x2F;etc&#x2F;hosts æ–‡ä»¶ï¼Œåœ¨Linuxä¸‹æ˜¯æ¯”è¾ƒå®¹æ˜“åšåˆ°çš„ï¼Œåœ¨ Kubernetes ä¸­ï¼Œå¯ä»¥é€šè¿‡ Pod å®šä¹‰ä¸­çš„ <code>hostAliases</code> å­—æ®µå‘ Pod çš„ &#x2F;etc&#x2F;hosts æ·»åŠ æ¡ç›®ã€‚</p><p>é€‚ç”¨å…¶ä»–æ–¹æ³•ä¿®æ”¹ Pod çš„ &#x2F;etc&#x2F;hosts æ–‡ä»¶æ˜¯ä¸è¢«æ¨èçš„ï¼Œå› ä¸º kubelet å¯èƒ½åœ¨é‡æ–°åˆ›å»º Pod æ—¶ï¼Œå°±ä¼šè¦†ç›–è¿™äº›ä¿®æ”¹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">hostaliases-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>  <span class="hljs-attr">hostAliases:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>    <span class="hljs-attr">hostnames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;foo.local&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;bar.local&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-string">&quot;10.1.2.3&quot;</span><br>    <span class="hljs-attr">hostnames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;foo.remote&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;bar.remote&quot;</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cat-hosts</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>    <span class="hljs-attr">command:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cat</span><br>    <span class="hljs-attr">args:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/etc/hosts&quot;</span><br></code></pre></td></tr></table></figure><h3 id="Podç½‘ç»œç­–ç•¥"><a href="#Podç½‘ç»œç­–ç•¥" class="headerlink" title="Podç½‘ç»œç­–ç•¥"></a>Podç½‘ç»œç­–ç•¥</h3><p>å¦‚æœä½ å¸Œæœ›åœ¨ IP åœ°å€æˆ–ç«¯å£å±‚é¢æ§åˆ¶ç½‘ç»œæµé‡ï¼Œå¯ä»¥è€ƒè™‘ä¸ºé›†ç¾¤ä¸­ç‰¹å®šåº”ç”¨ä½¿ç”¨ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰</p><p>Pod æ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ ‡è¯†ç¬¦çš„ç»„åˆæ¥åˆ¤åˆ«æ˜¯å¦å¯ä»¥é€šè®¯</p><ul><li>å…¶ä»–è¢«å…è®¸çš„ Podsï¼ˆä¾‹å¤–ï¼šPod æ— æ³•é˜»å¡å¯¹è‡ªèº«çš„è®¿é—®ï¼‰</li><li>è¢«å…è®¸çš„åå­—ç©ºé—´</li><li>IP ç»„å—ï¼ˆä¾‹å¤–ï¼šä¸ Pod è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹çš„é€šä¿¡æ€»æ˜¯è¢«è¿è¡Œçš„ï¼Œæ— è®º Pod æˆ–èŠ‚ç‚¹çš„ IP åœ°å€ï¼‰</li></ul><p>ç½‘ç»œç­–ç•¥é€šè¿‡<code>ç½‘ç»œæ’ä»¶</code>æ¥å®ç°ã€‚è¿™æ„å‘³ç€ä½ ä½¿ç”¨çš„ç½‘ç»œæ’ä»¶æ˜¯æ”¯æŒ NetworkPolicy çš„ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„è¿æ¥éƒ½æ˜¯è¢«å…è®¸çš„</p><h3 id="Pod-å›ºå®š-ip-åœ°å€"><a href="#Pod-å›ºå®š-ip-åœ°å€" class="headerlink" title="Pod å›ºå®š ip åœ°å€"></a>Pod å›ºå®š ip åœ°å€</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">pod.metadata.annotations:</span><br>  <span class="hljs-attr">&quot;cni.projectcalico.org/ipAddrs&quot;:</span> <span class="hljs-string">&quot;[\&quot;10.244.1.100&quot;</span><span class="hljs-string">\]&quot;</span><br></code></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ° IP æ²¡æœ‰é‡Šæ”¾ç­‰é—®é¢˜å¯¼è‡´çš„ Pod å¯åŠ¨å¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯¹ IP è¿›è¡Œé‡Šæ”¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">calicoctl ipam release --ip 10.244.1.100<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>K8sä¹‹æ§åˆ¶å™¨</title>
    <link href="/2025/09/19/K8s%E4%B9%8B%E6%8E%A7%E5%88%B6%E5%99%A8/"/>
    <url>/2025/09/19/K8s%E4%B9%8B%E6%8E%A7%E5%88%B6%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="K8sä¹‹æ§åˆ¶å™¨"><a href="#K8sä¹‹æ§åˆ¶å™¨" class="headerlink" title="K8sä¹‹æ§åˆ¶å™¨"></a>K8sä¹‹æ§åˆ¶å™¨</h1><h2 id="1ã€Deploymentæ§åˆ¶å™¨"><a href="#1ã€Deploymentæ§åˆ¶å™¨" class="headerlink" title="1ã€Deploymentæ§åˆ¶å™¨"></a>1ã€Deploymentæ§åˆ¶å™¨</h2><h3 id="ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨"><a href="#ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨" class="headerlink" title="ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨"></a>ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨</h3><p>åœ¨Kubernetesä¸­è¿è¡Œäº†ä¸€ç³»åˆ—çš„æ§åˆ¶å™¨æ¥ç¡®ä¿é›†ç¾¤çš„å½“å‰çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€æ˜¯ä¸€è‡´ï¼Œä»–ä»¬å°±æ˜¯kubernetesé›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒã€‚ä¾‹å¦‚ï¼ŒReplicaSetæ§åˆ¶å™¨è´Ÿè´£ç»´æŠ¤é›†ç¾¤ä¸­è¿è¡Œçš„Podæ•°é‡ï¼›Nodeæ§åˆ¶å™¨è´Ÿè´£ç›‘æ§èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¹¶åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œæ‰§è¡Œè‡ªåŠ¨åŒ–ä¿®å¤æµç¨‹ã€‚ç¡®ä¿é›†ç¾¤å§‹ç»ˆå¤„äºé¢„æœŸçš„å·¥ä½œçŠ¶æ€ã€‚</p><h3 id="ReplicaSetå’ŒReplicationController"><a href="#ReplicaSetå’ŒReplicationController" class="headerlink" title="ReplicaSetå’ŒReplicationController"></a>ReplicaSetå’ŒReplicationController</h3><p><code>ReplicationController(RC)</code>ç”¨æ¥ç¡®ä¿å®¹å™¨åº”ç”¨çš„å‰¯æœ¬æ•°å§‹ç»ˆä¿æŒåœ¨ç”¨æˆ·å®šä¹‰çš„å‰¯æœ¬æ•°ï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„Podæ¥æ›¿ä»£ï¼›å¦‚æœå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</p><p>åœ¨æ–°ç‰ˆçš„Kubernetesä¸­å»ºè®®ä½¿ç”¨<code>ReplicaSet</code>æ¥å–ä»£<code>ReplicationController</code>ã€‚å®ƒä¿©æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œåªæ˜¯åå­—ä¸åŒï¼Œå¹¶ä¸”ReplicaSetæ”¯æŒé›†åˆå¼çš„selectorã€‚</p><p>ReplicaSet ç¡®ä¿ä»»ä½•æ—¶é—´éƒ½æœ‰æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬åœ¨è¿è¡Œã€‚ RSä¼šé€šè¿‡<code>spec.selector</code>å­—æ®µæ¥é€‰æ‹©ç¬¦åˆæ¡ä»¶çš„Podçš„æ ‡ç­¾ï¼Œå¹¶æŠŠå®ƒçš„æ•°é‡ç»´æŒåœ¨æœŸæœ›çš„å€¼ï¼Œå¦‚æœä½ è¯•å›¾æ›´æ”¹æ‰Podçš„æ ‡ç­¾ï¼ŒRCä¼šåˆ¤æ–­æƒ…å†µï¼Œå¢åŠ æˆ–è€…åˆ é™¤Podæ¥ä¿æŒé¢„æœŸçš„çŠ¶æ€ã€‚</p><p>åœ¨Podæ•°é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼˜å…ˆè¢«å‰”é™¤çš„Podæ—¶æœ€æ–°è¢«åˆ›å»ºçš„Podã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-rs</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.22.1</span><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰è¢«éƒ¨ç½²çš„ ReplicaSetï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get rs<br>NAME       DESIRED   CURRENT   READY   AGE<br>nginx   3         3         3       6s<br></code></pre></td></tr></table></figure><p>è°ƒæ•´Podçš„æ•°é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl scale rs(æ§åˆ¶å™¨ç±»åˆ«) my-rs(æ§åˆ¶å™¨åç§°) --replicas=10<br></code></pre></td></tr></table></figure><p><strong>matchExpressionsæ ‡ç­¾</strong></p><ul><li>Inï¼šlabelçš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼ŒNotInï¼šlabelçš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">selector:</span><br>  <span class="hljs-attr">matchExpressions:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span><br>    <span class="hljs-attr">operator:</span> <span class="hljs-string">In/NotIn</span><br>    <span class="hljs-attr">values:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">app</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">log</span><br></code></pre></td></tr></table></figure><ul><li>Existsï¼šæŸä¸ªlabelå­˜åœ¨ï¼ŒDoesNotExistï¼šæŸä¸ªlabelä¸å­˜åœ¨</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">selector:</span><br>  <span class="hljs-attr">matchExpressions:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">app</span><br>    <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists/DoesNotExist</span><br></code></pre></td></tr></table></figure><h3 id="ä»€ä¹ˆæ˜¯Deployment"><a href="#ä»€ä¹ˆæ˜¯Deployment" class="headerlink" title="ä»€ä¹ˆæ˜¯Deployment"></a>ä»€ä¹ˆæ˜¯Deployment</h3><p>Deployment æ˜¯ Kubernetes ä¸­ç®¡ç†æ— çŠ¶æ€åº”ç”¨çš„æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œå®ƒä¸º Pod å’Œ ReplicaSet æä¾›äº†<code>å£°æ˜å¼</code>çš„æ–¹æ³•æ¥ç®¡ç†åº”ç”¨ã€‚å…¸å‹çš„åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p><ul><li>å®šä¹‰Deploymentæ¥åˆ›å»º Pod å’Œ ReplicaSet</li><li>æ»šåŠ¨å‡çº§å’Œå›æ»šåº”ç”¨</li><li>æ‰©å®¹å’Œç¼©å®¹</li><li>æš‚åœå’Œç»§ç»­Deployment</li></ul><h5 id="å£°æ˜å¼å’Œå‘½ä»¤å¼åœ¨k8så‘½ä»¤ä¸Šçš„ä½“ç°"><a href="#å£°æ˜å¼å’Œå‘½ä»¤å¼åœ¨k8så‘½ä»¤ä¸Šçš„ä½“ç°" class="headerlink" title="å£°æ˜å¼å’Œå‘½ä»¤å¼åœ¨k8så‘½ä»¤ä¸Šçš„ä½“ç°"></a>å£°æ˜å¼å’Œå‘½ä»¤å¼åœ¨k8så‘½ä»¤ä¸Šçš„ä½“ç°</h5><ul><li>kubectl replaceï¼šä½¿ç”¨æ–°çš„é…ç½®å®Œå…¨æ›¿æ¢æ‰ç°æœ‰çš„èµ„æºé…ç½®ã€‚è¿™æ„å‘³ç€æ–°é…ç½®å°†è¦†ç›–ç°æœ‰èµ„æºçš„æ‰€æœ‰å­—æ®µå’Œå±æ€§ï¼ŒåŒ…æ‹¬æœªæŒ‡å®šçš„å­—æ®µï¼Œä¼šå¯¼è‡´æ•´ä¸ªèµ„æºçš„æ›¿æ¢ã€‚ç”±äºæ˜¯å®Œå…¨æ›¿æ¢ï¼Œæ‰€ä»¥ä¼šè¦†ç›–æ‰€æœ‰å­—æ®µå’Œå±æ€§ï¼Œæ— è®ºæ˜¯å¦åœ¨æ–°é…ç½®æŒ‡å®š</li><li>kubectl applyï¼šä½¿ç”¨æ–°çš„é…ç½®éƒ¨åˆ†åœ°æ›´æ–°ç°æœ‰çš„èµ„æºé…ç½®ã€‚å®ƒä¼šæ ¹æ®æä¾›çš„é…ç½®æ–‡ä»¶æˆ–å‚æ•°ï¼Œåªæ›´æ–°ä¸æ–°é…ç½®ä¸­ä¸åŒçš„éƒ¨åˆ†ï¼Œè€Œä¸ä¼šè¦†ç›–æ‰æ•´ä¸ªèµ„æºçš„é…ç½®ã€‚åªæ›´æ–°ä¸é…ç½®ä¸­ä¸åŒçš„å­—æ®µå’Œå±æ€§ï¼Œä¿ç•™æœªæŒ‡å®šçš„å­—æ®µä¸å—å½±å“</li><li>kubectl createï¼šåˆ›å»ºæ–°çš„èµ„æºé…ç½®ï¼Œå¦‚æœå­˜åœ¨æ—§çš„èµ„æºï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œæ— æ³•æ›¿æ¢å­˜åœ¨çš„èµ„æºã€‚</li></ul><h5 id="Deploymentçš„yamlæ–‡ä»¶"><a href="#Deploymentçš„yamlæ–‡ä»¶" class="headerlink" title="Deploymentçš„yamlæ–‡ä»¶"></a>Deploymentçš„yamlæ–‡ä»¶</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-deploy</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.22.1</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥ç”¨diffå‘½ä»¤æ¥å¯¹æ¯”è¿è¡Œä¸­çš„èµ„æºå’Œèµ„æºæ¸…å•çš„åŒºåˆ«</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl diff -f my-deploy.yaml<br></code></pre></td></tr></table></figure><h5 id="è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="è‡ªåŠ¨æ‰©ç¼©å®¹"></a>è‡ªåŠ¨æ‰©ç¼©å®¹</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl autoscale deployment my-deploy --min=5 --max=10 --cpu-percent=80<br>å½“cpuä½¿ç”¨ç‡è¶…è¿‡80%çš„æ—¶å€™è‡ªåŠ¨æ‰©å®¹ï¼Œæœ€å¤§ä¸º10ä¸ªï¼Œæœ€å°ä¸º5ä¸ª<br></code></pre></td></tr></table></figure><h2 id="2ã€StatefulSet-ä»‹ç»"><a href="#2ã€StatefulSet-ä»‹ç»" class="headerlink" title="2ã€StatefulSet ä»‹ç»"></a>2ã€StatefulSet ä»‹ç»</h2><p>StatefulSet é¡¾åæ€ä¹‰ï¼Œç”¨äºç®¡ç† Statefulï¼ˆæœ‰çŠ¶æ€ï¼‰çš„åº”ç”¨ç¨‹åºã€‚</p><p>StatefulSet ç®¡ç† Pod æ—¶ï¼Œç¡®ä¿å…¶ Pod æœ‰ä¸€ä¸ªæŒ‰é¡ºåºå¢é•¿çš„ IDã€‚</p><p>ä¸ Deployment ç›¸ä¼¼ï¼ŒStatefulSet åŸºäºä¸€ä¸ª Pod æ¨¡æ¿ç®¡ç†å…¶ Podã€‚ä¸ Deployment æœ€å¤§çš„ä¸åŒåœ¨äº StatefulSet å§‹ç»ˆå°†ä¸€ç³»åˆ—ä¸å˜çš„åå­—åˆ†é…ç»™å…¶ Podã€‚è¿™äº› Pod ä»åŒä¸€ä¸ªæ¨¡æ¿åˆ›å»ºï¼Œä½†æ˜¯å¹¶ä¸èƒ½ç›¸äº’æ›¿æ¢ï¼šæ¯ä¸ª Pod éƒ½å¯¹åº”ä¸€ä¸ªç‰¹æœ‰çš„æŒä¹…åŒ–å­˜å‚¨æ ‡è¯†ã€‚</p><p>åŒå…¶ä»–æ‰€æœ‰æ§åˆ¶å™¨ä¸€æ ·ï¼ŒStatefulSet ä¹Ÿä½¿ç”¨ç›¸åŒçš„æ¨¡å¼è¿ä½œï¼šç”¨æˆ·åœ¨ StatefulSet ä¸­å®šä¹‰è‡ªå·±æœŸæœ›çš„ç»“æœï¼ŒStatefulSet æ§åˆ¶å™¨æ‰§è¡Œéœ€è¦çš„æ“ä½œï¼Œä»¥ä½¿å¾—è¯¥ç»“æœè¢«è¾¾æˆã€‚</p><h3 id="StatefulSetä½¿ç”¨åœºæ™¯"><a href="#StatefulSetä½¿ç”¨åœºæ™¯" class="headerlink" title="StatefulSetä½¿ç”¨åœºæ™¯"></a>StatefulSetä½¿ç”¨åœºæ™¯</h3><p>å¯¹äºæœ‰å¦‚ä¸‹è¦æ±‚çš„åº”ç”¨ç¨‹åºï¼ŒStatefulSet éå¸¸é€‚ç”¨ï¼š</p><ul><li>ç¨³å®šã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ï¼ˆdnsnameï¼‰</li><li>æ¯ä¸ªPodå§‹ç»ˆå¯¹åº”å„è‡ªçš„å­˜å‚¨è·¯å¾„ï¼ˆPersistantVolumeClaimTemplateï¼‰</li><li>æŒ‰é¡ºåºåœ°å¢åŠ å‰¯æœ¬ã€å‡å°‘å‰¯æœ¬ï¼Œå¹¶åœ¨å‡å°‘å‰¯æœ¬æ—¶æ‰§è¡Œæ¸…ç†</li><li>æŒ‰é¡ºåºè‡ªåŠ¨åœ°æ‰§è¡Œæ»šåŠ¨æ›´æ–°</li></ul><p>å¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºä¸éœ€è¦ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ï¼Œæˆ–è€…ä¸éœ€è¦æŒ‰é¡ºåºéƒ¨ç½²ã€åˆ é™¤ã€å¢åŠ å‰¯æœ¬ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä½¿ç”¨ Deployment è¿™ç±»æ— çŠ¶æ€ï¼ˆstatelessï¼‰çš„æ§åˆ¶å™¨ã€‚</p><h3 id="StatefulSet-é™åˆ¶"><a href="#StatefulSet-é™åˆ¶" class="headerlink" title="StatefulSet é™åˆ¶"></a>StatefulSet é™åˆ¶</h3><ul><li>Pod çš„å­˜å‚¨è¦ä¹ˆç”± StorageClass å¯¹åº”çš„ PersistentVolume Provisioner æä¾›ï¼Œè¦ä¹ˆç”±é›†ç¾¤ç®¡ç†å‘˜äº‹å…ˆåˆ›å»º</li><li>åˆ é™¤æˆ– scale down ä¸€ä¸ª StatefulSet å°†ä¸ä¼šåˆ é™¤å…¶å¯¹åº”çš„æ•°æ®å·ã€‚è¿™æ ·åšçš„è€ƒè™‘æ˜¯æ•°æ®å®‰å…¨</li><li>åˆ é™¤ StatefulSet æ—¶ï¼Œå°†æ— æ³•ä¿è¯ Pod çš„ç»ˆæ­¢æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœè¦æŒ‰é¡ºåº gracefully ç»ˆæ­¢ StatefulSet ä¸­çš„ Podï¼Œå¯ä»¥åœ¨åˆ é™¤ StatefulSet å‰å°†å…¶ scale down åˆ° 0</li><li>å½“ä½¿ç”¨é»˜è®¤çš„ Pod Management Policy (OrderedReady) è¿›è¡Œæ»šåŠ¨æ›´æ–°æ—¶ï¼Œå¯èƒ½è¿›å…¥ä¸€ä¸ªé”™è¯¯çŠ¶æ€ï¼Œå¹¶éœ€è¦äººå·¥ä»‹å…¥æ‰èƒ½ä¿®å¤</li></ul><h3 id="åˆ›å»ºStatefulSet"><a href="#åˆ›å»ºStatefulSet" class="headerlink" title="åˆ›å»ºStatefulSet"></a>åˆ›å»ºStatefulSet</h3><p>åœ¨ä¸‹è¿°ä¾‹å­ä¸­åˆ›å»ºäº†ï¼š</p><ul><li>ä¸€ä¸ªåä¸º <code>nginx</code> çš„ Headless Service ç”¨æ¥æ§åˆ¶ç½‘ç»œåŸŸåã€‚</li><li>ä¸€ä¸ªåä¸º <code>web</code> çš„ StatefulSet æœ‰ä¸€ä¸ª Specï¼Œå®ƒè¡¨æ˜å°†åœ¨ç‹¬ç«‹çš„ 3 ä¸ª Pod å‰¯æœ¬ä¸­å¯åŠ¨ nginx å®¹å™¨ã€‚</li><li><code>volumeClaimTemplates</code> å°†é€šè¿‡ PersistentVolume åˆ¶å¤‡ç¨‹åºæ‰€å‡†å¤‡çš„ PersistentVolumes æ¥æä¾›ç¨³å®šçš„å­˜å‚¨ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span> <span class="hljs-comment"># å¿…é¡»åŒ¹é… .spec.template.metadata.labels</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;nginx&quot;</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># é»˜è®¤å€¼æ˜¯ 1</span><br>  <span class="hljs-attr">minReadySeconds:</span> <span class="hljs-number">10</span> <span class="hljs-comment"># é»˜è®¤å€¼æ˜¯ 0</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span> <span class="hljs-comment"># å¿…é¡»åŒ¹é… .spec.selector.matchLabels</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">registry.k8s.io/nginx-slim:0.8</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">www</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">www</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&quot;my-storage-class&quot;</span><br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br></code></pre></td></tr></table></figure><p><strong>è¯´æ˜ï¼š</strong></p><p>è¿™ä¸ªç¤ºä¾‹å‡ºäºç®€åŒ–è€ƒè™‘ä½¿ç”¨äº† <code>ReadWriteOnce</code> è®¿é—®æ¨¡å¼ã€‚ä½†å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œ Kubernetes é¡¹ç›®å»ºè®®ä½¿ç”¨ <code>ReadWriteOncePod</code> è®¿é—®æ¨¡å¼ã€‚</p><h3 id="StatefilSetç‰¹ç‚¹"><a href="#StatefilSetç‰¹ç‚¹" class="headerlink" title="StatefilSetç‰¹ç‚¹"></a>StatefilSetç‰¹ç‚¹</h3><p>StatefulSet ä¸­çš„ Pod å…·å¤‡ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œè¯¥æ ‡è¯†ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>åºå·</li><li>ç¨³å®šçš„ç½‘ç»œæ ‡è¯†</li><li>ç¨³å®šçš„å­˜å‚¨</li></ul><p>è¯¥æ ‡è¯†å§‹ç»ˆä¸ Pod ç»‘å®šï¼Œæ— è®ºè¯¥ Pod è¢«è°ƒåº¦ï¼ˆé‡æ–°è°ƒåº¦ï¼‰åˆ°å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p><h5 id="åºå·"><a href="#åºå·" class="headerlink" title="åºå·"></a>åºå·</h5><p>å‡è®¾ä¸€ä¸ª StatefulSet çš„å‰¯æœ¬æ•°ä¸º Nï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ª Pod éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªåºå·ï¼Œåºå·çš„å–å€¼èŒƒå›´ä» 0 åˆ° N - 1ï¼Œå¹¶ä¸”è¯¥åºå·åœ¨ StatefulSet å†…éƒ¨æ˜¯å”¯ä¸€çš„ã€‚åˆ›å»ºçš„è¿‡ç¨‹æ˜¯ä» 0 ~ N ï¼Œåˆ é™¤çš„è¿‡ç¨‹æ˜¯ä» N ~ 0ã€‚åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå¿…é¡»å½“å‰é¢çš„ Pod å¤„äº Running çŠ¶æ€ï¼Œä¸‹ä¸€ä¸ª Pod æ‰å¼€å§‹åˆ›å»ºã€‚</p><h5 id="ç¨³å®šçš„ç½‘ç»œ-ID"><a href="#ç¨³å®šçš„ç½‘ç»œ-ID" class="headerlink" title="ç¨³å®šçš„ç½‘ç»œ ID"></a>ç¨³å®šçš„ç½‘ç»œ ID</h5><ul><li>StatefulSet ä¸­ Pod çš„ hostname æ ¼å¼ä¸º $(StatefulSet name)-$(Pod åºå·)ã€‚ä¸Šé¢çš„ä¾‹å­å°†è¦åˆ›å»ºä¸‰ä¸ª Podï¼Œå…¶åç§°åˆ†åˆ«ä¸ºï¼š web-0ï¼Œweb-1ï¼Œweb-2ã€‚</li><li>StatefulSet å¯ä»¥ä½¿ç”¨ Headless Service æ¥æ§åˆ¶å…¶ Pod æ‰€åœ¨çš„åŸŸã€‚è¯¥åŸŸï¼ˆdomainï¼‰çš„æ ¼å¼ä¸º $(service name).$(namespace).svc.cluster.localï¼Œå…¶ä¸­ â€œcluster.localâ€ æ˜¯é›†ç¾¤çš„åŸŸã€‚</li><li>StatefulSet ä¸­æ¯ä¸€ä¸ª Pod å°†è¢«åˆ†é…ä¸€ä¸ª dnsNameï¼Œæ ¼å¼ä¸ºï¼š $(podName).$(æ‰€åœ¨åŸŸå)</li></ul><h5 id="ç¨³å®šçš„å­˜å‚¨"><a href="#ç¨³å®šçš„å­˜å‚¨" class="headerlink" title="ç¨³å®šçš„å­˜å‚¨"></a>ç¨³å®šçš„å­˜å‚¨</h5><p>Kubernetes ä¸ºæ¯ä¸€ä¸ª VolumeClaimTemplate åˆ›å»ºä¸€ä»½ PersistentVolumeï¼ˆå­˜å‚¨å·ï¼‰ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ¯ä¸€ä¸ª Pod éƒ½å°†ç”± StorageClassï¼ˆå­˜å‚¨ç±»ï¼‰<code>my-storage-class</code> ä¸ºå…¶åˆ›å»ºä¸€ä¸ª 1Gib å¤§å°çš„ PersistentVolumeï¼ˆå­˜å‚¨å·ï¼‰ã€‚å½“ Pod è¢«è°ƒåº¦ï¼ˆæˆ–é‡æ–°è°ƒåº¦ï¼‰åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå…¶æŒ‚è½½ç‚¹å°†æŒ‚è½½è¯¥å­˜å‚¨å·å£°æ˜ï¼ˆå…³è”åˆ°è¯¥ PersistentVolumeï¼‰ã€‚</p><p>TIPï¼š</p><ul><li>å½“ Pod æˆ– StatefulSet è¢«åˆ é™¤æ—¶ï¼Œå…¶å…³è”çš„ PersistentVolumeClaimï¼ˆå­˜å‚¨å·å£°æ˜ï¼‰ä»¥åŠå…¶èƒŒåçš„ PersistentVolumeï¼ˆå­˜å‚¨å·ï¼‰ä»ç„¶å­˜åœ¨ã€‚</li><li>å¦‚æœç›¸åŒçš„ Pod æˆ– StatefulSet è¢«å†æ¬¡åˆ›å»ºï¼Œåˆ™ï¼Œæ–°å»ºçš„åä¸º web-0 çš„ Pod ä»å°†æŒ‚è½½åˆ°åŸæ¥åä¸º web-0 çš„ Pod æ‰€æŒ‚è½½çš„å­˜å‚¨å·å£°æ˜åŠå­˜å‚¨å·ã€‚</li><li>è¿™ç¡®ä¿äº† web-0ã€web-1ã€web-2 ç­‰ï¼Œä¸ç®¡è¢«åˆ é™¤é‡å»ºå¤šå°‘æ¬¡ï¼Œéƒ½å°† â€œç¨³å®šâ€ çš„ä½¿ç”¨å„è‡ªæ‰€å¯¹åº”çš„å­˜å‚¨å†…å®¹</li></ul><h5 id="Pod-name-æ ‡ç­¾"><a href="#Pod-name-æ ‡ç­¾" class="headerlink" title="Pod name æ ‡ç­¾"></a>Pod name æ ‡ç­¾</h5><p>å½“ StatefulSet æ§åˆ¶å™¨åˆ›å»ºä¸€ä¸ª Pod æ—¶ï¼Œä¼šä¸º Pod æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼ˆlabelï¼‰ <code>statefulset.kubernetes.io/pod-name</code> ä¸”è¯¥æ ‡ç­¾çš„å€¼ä¸º Pod çš„åå­—ã€‚æ‚¨å¯ä»¥åˆ©ç”¨æ­¤åå­—ï¼Œä¸º StatefulSet ä¸­çš„æŸä¸€ä¸ªç‰¹å®šçš„ Pod å…³è”ä¸€ä¸ª Serviceã€‚</p><p>TIP**ï¼š**</p><p>å®é™…æ“ä½œä¸­ï¼Œæ‚¨æ— éœ€ä¸º StatefulSet ä¸­çš„ä¸€ä¸ªç‰¹å®š Pod å…³è” Serviceï¼Œå› ä¸ºæ‚¨å¯ä»¥ç›´æ¥é€šè¿‡è¯¥ Pod çš„ DNS Name è®¿é—®åˆ° Podã€‚</p><h2 id="3ã€Daemonset-æ§åˆ¶å™¨"><a href="#3ã€Daemonset-æ§åˆ¶å™¨" class="headerlink" title="3ã€Daemonset æ§åˆ¶å™¨"></a>3ã€Daemonset æ§åˆ¶å™¨</h2><h3 id="DaemonSet-ä»‹ç»"><a href="#DaemonSet-ä»‹ç»" class="headerlink" title="DaemonSet ä»‹ç»"></a>DaemonSet ä»‹ç»</h3><p>DaemonSet ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…æŸäº›ï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚ å½“æœ‰NodeåŠ å…¥é›†ç¾¤æ—¶ï¼Œ ä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚ å½“æœ‰èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤DaemonSetå°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podã€‚</p><p>DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š</p><ul><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†å®ˆæŠ¤è¿›ç¨‹</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹</li></ul><p>ä¸€ç§ç®€å•çš„ç”¨æ³•æ˜¯ä¸ºæ¯ç§ç±»å‹çš„å®ˆæŠ¤è¿›ç¨‹åœ¨æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨ä¸€ä¸ªDaemonSetã€‚ ä¸€ä¸ªç¨å¾®å¤æ‚çš„ç”¨æ³•æ˜¯ä¸ºåŒä¸€ç§å®ˆæŠ¤è¿›ç¨‹éƒ¨ç½²å¤šä¸ª DaemonSetï¼›æ¯ä¸ªå…·æœ‰ä¸åŒçš„æ ‡å¿—ï¼Œ å¹¶ä¸”å¯¹ä¸åŒç¡¬ä»¶ç±»å‹å…·æœ‰ä¸åŒçš„å†…å­˜ã€CPU è¦æ±‚ã€‚</p><h3 id="èŠ‚ç‚¹åŒ¹é…"><a href="#èŠ‚ç‚¹åŒ¹é…" class="headerlink" title="èŠ‚ç‚¹åŒ¹é…"></a>èŠ‚ç‚¹åŒ¹é…</h3><p>DaemonSet å¯ç”¨äºç¡®ä¿æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹éƒ½è¿è¡Œè¯¥ Pod çš„ä¸€ä¸ªå‰¯æœ¬ã€‚ DaemonSet æ§åˆ¶å™¨ä¸ºæ¯ä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª Podï¼Œå¹¶æ·»åŠ  Pod çš„ <code>spec.affinity.nodeAffinity</code> å­—æ®µä»¥åŒ¹é…ç›®æ ‡ä¸»æœºã€‚Pod è¢«åˆ›å»ºä¹‹åï¼Œé»˜è®¤çš„è°ƒåº¦ç¨‹åºé€šå¸¸é€šè¿‡è®¾ç½® <code>.spec.nodeName</code> å­—æ®µæ¥æ¥ç®¡ Pod å¹¶å°† Pod ç»‘å®šåˆ°ç›®æ ‡ä¸»æœºã€‚å¦‚æœæ–°çš„ Pod æ— æ³•æ”¾åœ¨èŠ‚ç‚¹ä¸Šï¼Œåˆ™é»˜è®¤çš„è°ƒåº¦ç¨‹åºå¯èƒ½ä¼šæ ¹æ®æ–° Pod çš„ä¼˜å…ˆçº§æŠ¢å  ï¼ˆé©±é€ï¼‰æŸäº›ç°å­˜çš„ Podã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">log-collector</span>  <span class="hljs-comment"># Podé€‰æ‹©æ ‡ç­¾</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span>       <span class="hljs-comment"># èŠ‚ç‚¹é€‰æ‹©æ ‡ç­¾</span><br>        <span class="hljs-attr">node-type:</span> <span class="hljs-string">worker</span><br>      <span class="hljs-attr">tolerations:</span>        <span class="hljs-comment"># æ±¡ç‚¹å®¹å¿</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;disk-pressure&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br></code></pre></td></tr></table></figure><h3 id="DaemonSet-éƒ¨ç½²"><a href="#DaemonSet-éƒ¨ç½²" class="headerlink" title="DaemonSet éƒ¨ç½²"></a>DaemonSet éƒ¨ç½²</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-elasticsearch</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-logging</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-elasticsearch</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-elasticsearch</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-comment"># è¿™äº›å®¹å¿åº¦è®¾ç½®æ˜¯ä¸ºäº†è®©è¯¥å®ˆæŠ¤è¿›ç¨‹é›†åœ¨æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œ</span><br>      <span class="hljs-comment"># å¦‚æœä½ ä¸å¸Œæœ›è‡ªå·±çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹è¿è¡Œ Podï¼Œå¯ä»¥åˆ é™¤å®ƒä»¬</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/control-plane</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/master</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-elasticsearch</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">30</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span><br></code></pre></td></tr></table></figure><h2 id="4ã€Jobæ§åˆ¶å™¨"><a href="#4ã€Jobæ§åˆ¶å™¨" class="headerlink" title="4ã€Jobæ§åˆ¶å™¨"></a>4ã€Jobæ§åˆ¶å™¨</h2><h3 id="ä»€ä¹ˆæ˜¯Job"><a href="#ä»€ä¹ˆæ˜¯Job" class="headerlink" title="ä»€ä¹ˆæ˜¯Job"></a>ä»€ä¹ˆæ˜¯Job</h3><p>Jobè´Ÿè´£æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå³ä»…ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä»–ä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ªPod<code>æˆåŠŸç»“æŸ</code></p><p>ç‰¹æ®Šè¯´æ˜</p><ul><li>spec.templateæ ¼å¼åŒPod</li><li>RestartPolicyä»…æ”¯æŒNeverå’ŒOnfailure</li><li>å•ä¸ªPodæ—¶ï¼Œé»˜è®¤PodæˆåŠŸè¿è¡ŒåJobå³ç»“æŸ</li><li><code>spec.completions</code>æ ‡å¿—Jobç»“æŸéœ€è¦æˆåŠŸè¿è¡Œçš„Podä¸ªæ•°ï¼Œé»˜è®¤ä¸º1</li><li><code>spec.parallelism</code>è¡¨ç¤ºå¹¶è¡Œè¿è¡Œçš„Podä¸ªæ•°ã€‚é»˜è®¤ä¸º1</li><li><code>spec.activeDeadlineSeconds</code>æ ‡å¿—å¤±è´¥Podçš„é‡è¯•æœ€å¤§æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ä¸ä¼šç»§ç»­é‡è¯•</li></ul><p>Jobçš„èµ„æºæ¸…å•å†™æ³•</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">job-demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">job-demo</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">job-demo</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">æ‰¹å¤„ç†é•œåƒ</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span><br></code></pre></td></tr></table></figure><h3 id="ä»€ä¹ˆæ˜¯CronJob"><a href="#ä»€ä¹ˆæ˜¯CronJob" class="headerlink" title="ä»€ä¹ˆæ˜¯CronJob"></a>ä»€ä¹ˆæ˜¯CronJob</h3><p><code>CronJob</code>åˆ›å»ºåŸºäºæ—¶éš”é‡å¤è°ƒåº¦çš„Jobã€‚</p><p>ä½¿ç”¨æ¡ä»¶ï¼šå½“å‰k8sé›†ç¾¤ç‰ˆæœ¬&gt;&#x3D;1.8</p><p><code>CronJob</code> ç”¨äºæ‰§è¡Œæ’æœŸæ“ä½œï¼Œä¾‹å¦‚å¤‡ä»½ã€ç”ŸæˆæŠ¥å‘Šç­‰ã€‚ ä¸€ä¸ª <code>CronJob</code> å¯¹è±¡å°±åƒ Unix ç³»ç»Ÿä¸Šçš„ <code>crontab</code>ï¼ˆcron tableï¼‰æ–‡ä»¶ä¸­çš„ä¸€è¡Œã€‚ å®ƒç”¨ Cron æ ¼å¼è¿›è¡Œç¼–å†™ï¼Œ å¹¶å‘¨æœŸæ€§åœ°åœ¨ç»™å®šçš„è°ƒåº¦æ—¶é—´æ‰§è¡Œ Jobã€‚</p><p>ç‰¹æ®Šè¯´æ˜ï¼š</p><ul><li><p><code>spec.schedule</code>ï¼šè°ƒåº¦ï¼Œå¿…é¡»å­—æ®µï¼ŒæŒ‡å®šä»»åŠ¡è¿è¡Œå‘¨æœŸ</p></li><li><p><code>spec.jobTemplate</code>ï¼šJobæ¨¡æ¿ï¼Œå¿…é¡»å­—æ®µï¼ŒæŒ‡å®šä¹Ÿéœ€è¦è¿è¡Œçš„Jobæ¨¡æ¿ï¼Œæ ¼å¼åŒJob</p></li><li><p><code>spec.startingDeadlineSeconds</code>ï¼šå¯åŠ¨Jobçš„æœŸé™ï¼ˆç§’çº§åˆ«ï¼‰ï¼Œè¯¥å­—æ®µæ˜¯å¯é€‰çš„ã€‚å¦‚æœå› ä¸ºä»»ä½•åŸå› è€Œé”™è¿‡äº†è¢«è°ƒåº¦çš„æ—¶é—´ï¼Œé‚£ä¹ˆé”™è¿‡æ‰§è¡Œæ—¶é—´çš„Jobå°†è¢«è®¤ä¸ºæ˜¯å¤±è´¥çš„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™æ²¡æœ‰æœŸé™</p></li><li><p><code>spec.concurrencyPolicy</code>ï¼šå¹¶å‘ç­–ç•¥ï¼Œå¯é€‰å­—æ®µï¼Œå®ƒæŒ‡å®šäº†å¦‚ä½•å¤„ç†è¢«Cron Job åˆ›å»ºçš„ Job çš„å¹¶å‘æ‰§è¡Œã€‚åªå…è®¸æŒ‡å®šä¸‹é¢ç­–ç•¥ä¸­çš„ä¸€ç§ï¼š</p></li><li><ul><li><code>Allow</code>ï¼ˆé»˜è®¤ï¼‰ï¼šè¿è¡Œå¹¶å‘æ‰§è¡ŒJob</li><li><code>Forbid</code>ï¼šç¦æ­¢å¹¶å‘è¿è¡Œï¼Œå¦‚æœå‰ä¸€ä¸ªè¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™ç›´æ¥è·³è¿‡ä¸‹ä¸€ä¸ª</li><li><code>Replace</code>ï¼šå–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„Jobï¼Œç”¨ä¸€ä¸ªæ–°çš„æ¥æ›¿æ¢</li><li>æ³¨æ„ï¼Œå½“å‰ç­–ç•¥åªèƒ½ç”¨äºåŒä¸€ä¸ª Cron Job åˆ›å»ºçš„ Job ã€‚å¦‚æœå­˜åœ¨å¤šä¸ªï¼Œåˆ™ä»–ä»¬åˆ›å»ºçš„ Job ä¹‹é—´æ˜¯å…è®¸å¹¶å‘è¿è¡Œçš„ã€‚</li></ul></li><li><p>spec.suspendï¼šæŒ‚èµ·ï¼Œå¯é€‰å­—æ®µã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œåç»­æ‰€æœ‰æ‰§è¡Œéƒ½ä¼šè¢«æŒ‚èµ·ã€‚é»˜è®¤ä¸ºfalseã€‚ä»–å¯¹å·²ç»å¼€å§‹æ‰§è¡Œçš„ Job ä¸èµ·ä½œç”¨ã€‚</p></li><li><p>spec.successfulJobsHistoryLimitå’Œspec.failedJobsHistoryLimitï¼šå†å²é™åˆ¶ï¼Œå¯é€‰å­—æ®µã€‚ä»–ä»¬åªèƒ½å¤Ÿäº†å¯ä»¥ä¿ç•™å¤šä¸ªå®Œæˆå’Œå¤±è´¥çš„Jobã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»–ä»¬è¢«è®¾ç½®ä¸º3å’Œ1ã€‚è®¾ç½®é™åˆ¶çš„å€¼ä¸º0ï¼Œç›¸å…³ç±»å‹çš„ Job å®Œæˆåå°†ä¸ä¼šè¢«ä¿ç•™ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CronJob</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">schedule:</span> <span class="hljs-string">&quot;0 1 * * *&quot;</span><br>  <span class="hljs-attr">jobTemplate:</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">spec:</span><br>          <span class="hljs-attr">containers:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br>            <span class="hljs-attr">image:</span> <span class="hljs-string">busybox:1.28</span><br>            <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>            <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">date;</span> <span class="hljs-string">echo</span> <span class="hljs-string">Hello</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">Kubernetes</span> <span class="hljs-string">cluster</span><br>          <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">OnFailure</span><br></code></pre></td></tr></table></figure><p><code>Cron</code> æ—¶é—´è¡¨è¯­æ³•</p><p><code>.spec.schedule</code> å­—æ®µæ˜¯å¿…éœ€çš„ã€‚è¯¥å­—æ®µçš„å€¼éµå¾ª <code>Cron</code>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain"># â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)<br># â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)<br># â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆçš„æŸå¤© (1 - 31)<br># â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)<br># â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘¨çš„æŸå¤© (0 - 6)ï¼ˆå‘¨æ—¥åˆ°å‘¨ä¸€ï¼›åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œ7 ä¹Ÿæ˜¯æ˜ŸæœŸæ—¥ï¼‰<br># â”‚ â”‚ â”‚ â”‚ â”‚                          æˆ–è€…æ˜¯ sunï¼Œmonï¼Œtueï¼Œwebï¼Œthuï¼Œfriï¼Œsat<br># â”‚ â”‚ â”‚ â”‚ â”‚<br># â”‚ â”‚ â”‚ â”‚ â”‚<br># * * * * *<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ <code>0 0 13 * 5</code> è¡¨ç¤ºæ­¤ä»»åŠ¡å¿…é¡»åœ¨æ¯ä¸ªæ˜ŸæœŸäº”çš„åˆå¤œä»¥åŠæ¯ä¸ªæœˆçš„ 13 æ—¥çš„åˆå¤œå¼€å§‹ã€‚</p><h5 id="å…¸å‹å’Œç”¨æ³•"><a href="#å…¸å‹å’Œç”¨æ³•" class="headerlink" title="å…¸å‹å’Œç”¨æ³•"></a>å…¸å‹å’Œç”¨æ³•</h5><p>1ã€æ•°æ®åº“å¤‡ä»½</p>]]></content>
    
    
    <categories>
      
      <category>K8s</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
